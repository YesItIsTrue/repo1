<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
<TITLE>Individual Test Kit Results</TITLE> 
 
<META NAME="AUTHOR" CONTENT="Trae Luttrell">
<META name="VERSION" content="3.8">
<META name="COPYRIGHT" content="Solsource">  
<META name="CREATE_DATE" content="24/Dec/14">
<META NAME="LAST_UPDATED" CONTENT="23/Aug/16">   

<LINK rel='stylesheet' type='text/css' href='/depot/src/HTMLContent/stylesheets/core.css' />

<script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

<script src='/depot/src/HTMLContent/javascript/fixed.js'></script>
<script src='/depot/src/HTMLContent/javascript/tablesorter.min.js'></script>

<script>$(document).ready(function() 
    { 
        // $("td").wrapInner("<div class='printfix'></div>");
        $('.table_

 table').tablesorter(); //this selects the tables that will be sortable, it has to target a 'table' specifically and not the surrounding class
    } 
); </script>


  
<SCRIPT LANGUAGE="SpeedScript">
   
CREATE WIDGET-POOL.

  /*------------------------------------------------------------------
    File: TKtestresR.html
    Description: This is the infamous report that takes an individual's
    single test kit results and compares it with the recommendations on 
    hand and shows them what they would like to do. 
    Created: Dec 24 2014
    Updated: May 02 2015
    Version: 3.1

    Version 3.2 - written by Harold Luttrell on 07/Oct/15.
    Changed the http://loccalhost:3333/  code to ../../  
    Marked by /* 3dot2 */. 
    
    Version 3.3 - written by Jacob Luttrell on 04/Nov/15
    Changed the hyperlinks in the buttons. Marked by 3dot3
    
    Version 3.4 - written by Jacob Luttrell on 12/Jan/16
    Added field in TKinfoBoxR.i for new table field Lab Completed 
    Marked 3dot4
    
    Version 3.5 - written by Jacob Luttrell on 22/Feb/16
    Made changes to fields to match the v11.1 database. 
    Marked by 3dot5.
    
    Version 3.6 - written by DOUG LUTTRELL on 22/Mar/16.  Added
        changes from Quinton to support the new CSS changes to 
        get the tables to line up properly.  Marked by 3dot6.
        
    Version 3.7 - written by DOUG LUTTRELL on 28/May/16.  
        a) Tightened the report to only combine results across the same test type.
        b) Also increased the precision of the result column.  It was only going 
            out to 2 digits and I increased it to 4 so it would match with the 
            changes to the recommendation maintenance and the datafiles that come in.  
        c) Fixed the test header block in the include file (TKinfoBoxR.i).  
        d) Fixed the Edit this Testkit button to pass proper data to TK maint.
        Marked by 3dot7.
        
    Version 3.8 - Written by Jacob Luttrell on 23/Aug/16. Added alternate fields 
        for MPA tests for character values replacing intiger range values. Marked by 3dot8.    
  -------------------------------------------------------------------*/
  
/*/******* this is an identical copy of DDI's colors *******/*/
/*                                                           */
/*.leftToRightGradient{                                      */
/*  width: 40%;                                              */
/*  background:                                              */
/*    linear-gradient(to right,                              */
/*    rgba(204,255,204,.9) 32%, /** green end */             */
/*    rgba(255,255,204,.8) 32%, /** yellow start */          */
/*    rgba(255,255,204,.8) 66%, /** yellow end */            */
/*    rgba(255,191,191,.9) 66%); /* red start */             */
/*}                                                          */ 
/*                                                           */
/*.centerGradient{                                           */
/*  width: 40%;                                              */
/*  background: linear-gradient(to right,                    */
/*    rgba(255,191,191,.9) 15%,     /** red end **/          */
/*    rgba(255,255,204,.8) 15%,     /** yellow start **/     */
/*    rgba(255,255,204,.8) 30%,     /** yellow end **/       */
/*    rgba(204,255,204,.9) 30%,     /** green start **/      */
/*    rgba(204,255,204,.9) 45%,     /** green end **/        */
/*    rgba(255,255,255,.9) 45%,     /** white start **/      */
/*    rgba(255,255,255,.9) 55%,     /** white end **/        */
/*    rgba(204,255,204,.9) 55%,     /** green start **/      */
/*    rgba(204,255,204,.9) 70%,     /** green end **/        */
/*    rgba(255,255,204,.8) 70%,     /** yellow start **/     */
/*    rgba(255,255,204,.8) 85%,     /** yellow end **/       */
/*    rgba(255,191,191,.9) 85%);    /** red start **/        */
/*}                                                          */

</SCRIPT>
<style TYPE="text/css">

/****** this is how Trae thinks the colors ought to be, more or less. *******/

.leftToRightGradient{
  width: 40%;
  background: 
    linear-gradient(to right, 
    rgba(102,204,102,.9) 32%, /** green end */
    rgba(255,255,102,.8) 32%, /** yellow start */
    rgba(255,255,102,.8) 66%, /** yellow end */
    rgba(255,153,153,.9) 66%); /* red start */
}

.centerGradient{
  width: 40%;
  background: linear-gradient(to right, 
    rgba(255,153,153,.9) 15%,     /** red end **/
    rgba(255,255,102,.8) 15%,     /** yellow start **/
    rgba(255,255,102,.8) 30%,     /** yellow end **/
    rgba(102,204,102,.9) 30%,     /** green start **/
    rgba(102,204,102,.9) 45%,     /** green end **/
    rgba(255,255,255,.9) 45%,     /** white start **/
    rgba(255,255,255,.9) 55%,     /** white end **/
    rgba(102,204,102,.9) 55%,     /** green start **/
    rgba(102,204,102,.9) 70%,     /** green end **/
    rgba(255,255,102,.8) 70%,     /** yellow start **/
    rgba(255,255,102,.8) 85%,     /** yellow end **/
    rgba(255,153,153,.9) 85%);    /** red start **/
}

.bar{
  width:0px;
  height:12px;
  background:black;
  border-radius:10px;
  animation-name: stretch;
  -webkit-animation-name: stretch;  
    animation-duration: 1.5s;   
  -webkit-animation-duration: 1.5s;
    animation-timing-function: ease-out;    
    -webkit-animation-timing-function: ease-out;    
    transform-origin: 0% 0%;
    -ms-transform-origin: 0% 0%;
    -webkit-transform-origin: 0% 0%;
} 

/** 
For the center bars, treat 50% as the maximum width for the centerToLeft bar, 
and 52% as the maximum width for the centerToRight bar. This is because in 
order to have the centerToRight bar start more centered, the bar needs to 
start slightly less than halfway.
**/

 .centerToRight{ 
  /** Having the margin-left at 48% looks more centered than 50% **/
  margin-left:48%;
  width:0px;
  height:12px;
  background:black;
  border-radius:10px;
  animation-name: stretch;
  -webkit-animation-name: stretch;  
    animation-duration: 1.5s;   
  -webkit-animation-duration: 1.5s;
    animation-timing-function: ease-out;    
    -webkit-animation-timing-function: ease-out;    
    transform-origin: 0% 0%;
    -ms-transform-origin: 0% 0%;
    -webkit-transform-origin: 0% 0%;
}
.centerToLeft{
  margin-right:50%;
  float:right;
  width: 0px;
  height:12px;
  background:black;
  border-radius:10px;
    animation-name: stretch;
    -webkit-animation-name: stretch;    
    animation-duration: 1.5s;   
    -webkit-animation-duration: 1.5s;
    animation-timing-function: ease-out;    
    -webkit-animation-timing-function: ease-out;    
    transform-origin: 100% 0%;
    -ms-transform-origin: 100% 0%;
    -webkit-transform-origin: 100% 0%; 
} 

/** Animation keyframes **/
@keyframes stretch {
    0% {transform: scaleX(0.3);}
    60% {transform: scaleX(1);}         
    80% {transform: scaleX(0.98);}
    100% {transform: scaleX(1);}                            
}
@-webkit-keyframes stretch {
    0% {-webkit-transform: scaleX(0.3);}
    60% {-webkit-transform: scaleX(1);}
    80% {-webkit-transform: scaleX(0.98);}
    100% {-webkit-transform: scaleX(1);}        
}

</style>

</HEAD>

<BODY class='inside'>

<SCRIPT LANGUAGE="SpeedScript">

{../depot/src/WebSpeed/menuname.i}.
  
/***************************  Variables  ******************************/

DEFINE TEMP-TABLE tkr-2 
    FIELD tkr-item      LIKE TKR_det.TKR_item
    FIELD tkr-resval    LIKE TKR_det.TKR_lab_resval FORMAT "->>,>>9.<<<<<"                               /* 3dot7 */
    FIELD tkr-result    LIKE TKR_det.TKR_lab_result
    FIELD tkr-uom       LIKE TKR_det.TKR_ref_uom 
    FIELD trr-order     LIKE trr_det.trr_order 
    FIELD suppl-name    LIKE suppl_list.suppl_name
    FIELD suppl-id      LIKE suppl_list.suppl_id 
    FIELD tld-item-id   LIKE tld_det.tld_item_ID
    FIELD tl-section    LIKE tl_mstr.tl_section_desc INITIAL "Unknown"
    FIELD tl-order      LIKE tl_mstr.tl_order
    FIELD tld-id        LIKE tld_det.tld_sect_id
    FIELD TK-testtype   LIKE TK_mstr.TK_test_type                           /* 3dot5 */
    FIELD tld-order     LIKE tld_det.tld_order
/*    FIELD trr-dosage    LIKE trr_det.trr_dosage INITIAL 0*/
    FIELD trr-dose-from LIKE trr_det.trr_dosage_from                        /* 3dot5 */
    FIELD trr-dose-to   LIKE trr_det.trr_dosage_to                          /* 3dot5 */
    FIELD trr-eff-start LIKE trr_det.trr_start_eff                          /* 3dot5 */
    FIELD trr-eff-end   LIKE trr_det.trr_end_eff                            /* 3dot5 */
    FIELD trr-uom       LIKE trr_det.trr_uom
    FIELD trr-notes     LIKE trr_det.trr_notes
    FIELD marker-disp   LIKE marker_list.marker_display                     /* 3dot6 */
    FIELD tkr-minusSD   LIKE TKR_det.tkr_minusSD
    FIELD tkr-meanSD    LIKE TKR_det.tkr_meanSD
    FIELD tkr-plusSD    LIKE TKR_det.tkr_plusSD
    FIELD tld-bar-type  LIKE tld_det.tld_bar_type
    FIELD people_firstn LIKE people_mstr.people_firstname 
    FIELD people_lastn  LIKE people_mstr.people_lastname
    FIELD tally         AS INTEGER
    FIELD found         AS LOGICAL INITIAL NO                                                      
    INDEX item-idx      AS PRIMARY UNIQUE tkr-item 
    .
 
DEFINE BUFFER tkr-2-buff FOR tkr-2.
    
/********  Database Variables  **********/

DEFINE VARIABLE v-TK_id         LIKE TK_mstr.TK_ID                          NO-UNDO.
DEFINE VARIABLE v-testtype      LIKE tl_mstr.tl_testtype                    NO-UNDO.
DEFINE VARIABLE v-TK_test_seq   LIKE TK_mstr.tk_test_seq  INITIAL 1         NO-UNDO.
DEFINE VARIABLE v-orig-TK_test_seq  LIKE TK_mstr.TK_test_seq NO-UNDO.                               /* 3dot7 */
DEFINE VARIABLE v-patient_id    LIKE TK_mstr.TK_patient_ID                  NO-UNDO.

/*******  Adminstrator Variables  *******/

DEFINE VARIABLE themath AS DECIMAL FORMAT "->>9.9" NO-UNDO.
DEFINE VARIABLE v-itmessage         AS LOGICAL      INITIAL NO  NO-UNDO.
DEFINE VARIABLE v-itmessage-math    AS LOGICAL      INITIAL NO  NO-UNDO.
DEFINE VARIABLE v-act0              AS CHARACTER                NO-UNDO.
DEFINE VARIABLE act                 AS CHARACTER                NO-UNDO.
DEFINE VARIABLE v-start_holder      AS CHARACTER    INITIAL ""  NO-UNDO.
DEFINE VARIABLE v-end_holder        AS CHARACTER    INITIAL ""  NO-UNDO.
DEFINE VARIABLE v-green             AS CHARACTER                NO-UNDO.
DEFINE VARIABLE x                   AS INTEGER                  NO-UNDO.
DEFINE VARIABLE y                   AS INTEGER                  NO-UNDO.
DEFINE VARIABLE v-found             AS LOGICAL                  NO-UNDO.
DEFINE VARIABLE v-inside-trr4ea     AS LOGICAL                  NO-UNDO.
DEFINE VARIABLE v-inside-trr4ea-p3  AS LOGICAL                  NO-UNDO.
DEFINE VARIABLE v-inside-4ea        AS LOGICAL  INITIAL NO      NO-UNDO.
DEFINE VARIABLE v-everything-failed AS LOGICAL  INITIAL NO      NO-UNDO.
DEFINE VARIABLE found-mult          AS INTEGER                  NO-UNDO.

DEFINE VARIABLE userdate            AS DATE INITIAL TODAY       NO-UNDO. /* 3dot5 */

DEFINE VARIABLE make-export-data    AS LOG          INITIAL NO  NO-UNDO.

/***************************  Prologue  *******************************/

/*********  HTML Get-Values  ***********/
ASSIGN 
    v-tk_id         = get-value("h-tk_id")
    v-testtype      = get-value("h-testtype")
    v-orig-TK_test_seq = IF get-value("h-tk_test_seq") = "" THEN
                            1
                         ELSE
                            INTEGER (get-value("h-tk_test_seq"))
    whatshouldrun       = get-value('whattorun')
    v-patient_id    = INTEGER (get-value("h-patient_id"))                            
    v-act0          = get-value("h-act").
    
IF v-act0       = "" THEN ASSIGN 
    v-act0      = "User".

/****************  Main Program - Act - "User" Input  ******************/

IF v-act0 = "User" THEN DO:     
    
    {&OUT}
        "<br>"                                                                                              SKIP
        "<div class='row'>"                                                                                 SKIP
        "<div class='grid_3'></div>"                                                                        SKIP
        "<div class='grid_6'>"                                                                              SKIP
        "   <div class='table_col'>"                                                                        SKIP
        "       <form>"                                                                                     SKIP
        "           <table>"                                                                                SKIP
        "               <tr>"                                                                               SKIP
        "                   <th colspan=2> Enter TestkKit</th>"                                             SKIP    /* 3dot2 */
        "               </tr>"                                                                              SKIP
        "               <tr>"                                                                               SKIP
        "                   <td>Test Kit ID</td>"                                                           SKIP
        "                   <td><input type=text name='h-tk_id' value='" v-tk_id "'></td>"                  SKIP
        "               </tr>"                                                                              SKIP                                                                 
        "               <tr>"                                                                               SKIP
        "                   <td>Patient ID</td>"                                                            SKIP
        "                   <td><input type=text name='h-patient_ID' value='" v-patient_id "'></td>"        SKIP
        "               </tr>"                                                                              SKIP
        "           </table>                                                              "                 SKIP
/*        "<center>"                                                                                          SKIP*/
        "</div>"                                                                                            SKIP
        "</div><!--class='grid_6'-->"                                                                       SKIP
        "<div class='3'></div>"                                                                             SKIP
       /* 3dot5 --> */ 
        "</div>"
        "<BR>" SKIP 
       "<div class='row'>" SKIP
		"   <div class='grid_3'> </DIV>" SKIP
        "       <input type='hidden' name='whattorun' value='" whatshouldrun "'>"                           SKIP		
		"   <div class='grid_2'><BUTTON type='submit' name='h-act' value='Report' class='btn'>Submit</BUTTON></div>" SKIP
		"   <div class='grid_2'> </DIV>" SKIP
		"   <div class='grid_2'><BUTTON type='reset' class='btn'>Clear Changes</BUTTON></div>" SKIP
		"   <div class='grid_3'> </DIV>" SKIP
		"</div>" SKIP
		/* <-- 3dot5 */
/*        "       <INPUT type='hidden' name='h-act' value='Report'/>"                                         SKIP*/
/*        "       <input type='hidden' name='whattorun' value='" whatshouldrun "'>"                           SKIP*/
/*        "       <INPUT type='submit' name='submit' value='Submit'/>                       "                 SKIP*/
/*        "       <INPUT type='reset' name='reset' value='Reset'/>                          "                 SKIP*/
/*        "</center>"                                                                                         SKIP*/
        "   </FORM>"                                                                                        SKIP.
        
        
END. /*** v-act0 0 ***/

/***********************  Display - "Report"  ************************/

IF v-act0 = "Report" THEN DO:
    
    FOR EACH TK_mstr WHERE 
        TK_mstr.TK_ID                   = v-tk_id       AND 
        TK_mstr.TK_patient_ID           = v-patient_id  AND 
        TK_mstr.tk_test_type            = v-testtype AND                                                /* 3dot7 */
        TK_mstr.TK_deleted              = ?
        NO-LOCK:

        ASSIGN 
            v-TK_test_seq = TK_mstr.TK_test_seq
            v-inside-4ea = YES.
        
        FIND people_mstr WHERE 
            people_mstr.people_ID         = TK_mstr.tk_patient_id AND 
            people_mstr.people_deleted    = ?
            NO-LOCK NO-ERROR.
        
        IF AVAILABLE people_mstr THEN DO:
    
            FOR EACH tl_mstr WHERE 
                tl_mstr.tl_testtype    = TK_mstr.tk_test_type AND               /* 3dot5 */
                tl_mstr.tl_deleted     = ? 
                NO-LOCK,
                EACH tld_det WHERE 
                tld_det.tld_sect_id         = tl_mstr.tl_sect_id AND 
                tld_det.tld_deleted         = ?
                NO-LOCK,
                FIRST marker_list WHERE 
                marker_list.marker_ID       = tld_det.tld_item_ID AND 
                marker_list.marker_deleted  = ?
                NO-LOCK:       
                                 
                                                                    IF v-itmessage = YES THEN
                                                                        {&OUT}
                                                                             "<H3>Inside 4ea. tl_mstr, etc.</H3>" SKIP
                                                                             "<OL>" SKIP
                                                                             "<LI>tl_test_type = " tl_testtype "</LI>" SKIP
                                                                             "<LI>tl_sect_id = " tl_sect_id "</LI>" skip 
                                                                             "<LI>tl_section_desc = " tl_section_desc "</LI>" SKIP
                                                                             "<LI>tld_item_id = " tld_item_id "</LI>" SKIP
/*                                                                             "<LI>tld_item_name = " tld_item_name "</LI>" SKIP*/
                                                                             "<LI>marker_item = " marker_item "</LI>" SKIP
                                                                             "<OL>" SKIP.
                FIND tkr-2 WHERE 
                    tkr-2.tkr-item = marker_list.marker_item              /* 3dot5 */
                    EXCLUSIVE-LOCK NO-ERROR.
            
                IF NOT AVAILABLE (tkr-2) THEN DO:
                
                    CREATE tkr-2.
                    
                    ASSIGN 
                        tkr-2.tkr-item = marker_list.marker_item.           /* 3dot5 */ 
                    
                END.    /** of if not avail tkr-2 **/
            
                ASSIGN  
                     tkr-2.TK-testtype   = TK_mstr.tk_test_type          /* 3dot5 */       
                     tkr-2.tl-section    = tl_mstr.tl_section_desc
                     tkr-2.tl-order      = tl_mstr.tl_order
                     tkr-2.tld-id        = tld_det.tld_sect_id
                     tkr-2.tld-order     = tld_det.tld_order
                     tkr-2.tld-item-id   = tld_det.tld_item_id
                     tkr-2.tld-bar-type  = tld_det.tld_bar_type                                                    
                     tkr-2.marker-disp   = marker_list.marker_display                       /* 3dot6 */
                     tkr-2.found         = YES
                     .
    
                RELEASE tkr-2.

            END. /***  of 4ea tl_mstr  ***/
            
	        FOR EACH TKR_det WHERE 
		            TKR_det.TKR_ID          = TK_mstr.TK_ID AND 
		            TKR_det.tkr_test_seq    = TK_mstr.TK_test_seq AND                                   /* 3dot6 */
		            TKR_det.TKR_deleted     = ?
		            NO-LOCK,
	            FIRST marker_list WHERE marker_list.marker_item = TKR_det.TKR_item NO-LOCK 
	               BREAK BY TKR_det.TKR_ID BY TKR_det.TKR_item:
	                    
	            FIND tkr-2 WHERE tkr-2.tkr-item = TKR_det.TKR_item
	                EXCLUSIVE-LOCK NO-ERROR.
	                
	            IF NOT AVAILABLE (tkr-2) THEN DO:
	             
	                CREATE tkr-2.
	                
	                ASSIGN 
	                    tkr-2.tkr-item = TKR_det.TKR_item.
	                
	            END.    /** of if not avail tkr-2 **/
	               
	            ASSIGN 
	                tkr-2.tkr-item      = TKR_det.TKR_item
	                tkr-2.marker-disp   = marker_list.marker_display                                           /* 3dot6 */
	                tkr-2.tkr-resval    = TKR_det.tkr_lab_resval 
	                tkr-2.tkr-result    = IF TKR_det.TKR_lab_result = "" THEN 
	                                            STRING(TKR_det.TKR_lab_resval,"->>,>>9.9999") + " " + (TKR_det.tkr_ref_uom) /* 3dot7 */
	                                             /** used to have a comma in it **/
	                                      ELSE  
	                                            TKR_det.TKR_lab_result                           
	                tkr-2.tkr-minusSD   = TKR_det.tkr_minusSD
	                tkr-2.tkr-meanSD    = TKR_det.tkr_meanSD
	                tkr-2.tkr-plusSD    = TKR_det.tkr_plusSD
	                .
	                
	            RELEASE tkr-2. 
	                
											            IF v-itmessage = YES THEN               
									                        {&OUT}
									                            "TK_mstr.tk_test_type = " TK_mstr.tk_test_type "." SKIP. /* 3dot5 */
    
	        END. /***  4ea tkr_det  ***/
	        
	    END. /*** if avail people_mstr ***/
	    
	    ELSE DO: 
	        {&OUT}
	        "<center><h3>Unable to find a specific person with the information you supplied.</h3><br>      
	        <form><button name='h-act' value='User'>Search Again</button></FORM></center>".
	        
	        ASSIGN v-everything-failed = YES.
	        
	    END. /*** of ELSE (people_mstr not avail) ***/
      
    END. /***  4ea TK_mstr  ***/            

    IF v-inside-4ea = NO THEN DO: 
 
       {&OUT}  
            "<center><h3>Unable to find a specific Testkit with the information you supplied.</h3><br>
            <form><button name='h-act' value='User'>Search Again</button></FORM></center>".
            
        ASSIGN v-everything-failed = YES.  
        
    END. /*** of v-inside-4ea = NO (TKR_det not avail) ***/ 
    
    IF v-everything-failed = NO THEN DO:
    
/*******************************   Display the Data  ***************************************************************/  
        
        IF make-export-data = YES THEN  
            OUTPUT TO "C:\progress\wrk\what-the-tkr-2.txt". 
         
        {TKinfoBoxR.i v-tk_id v-patient_id v-testtype v-orig-TK_test_seq}.                  /* 3dot7 */
        
        /* link to the general Test Kit maintanence program */
        {&OUT}
            "<div class='row'>" SKIP
            "   <div class='grid_5'> </DIV>" SKIP
            "   <div class='grid_2'>" SKIP(1)
            
            "<a href='../../DataHub/rcode/TKgeneralMaintU.r"                                /* 3dot2 */
                "?h-TK_ID=" v-tk_id                
                "&h-TK_test_seq=" v-orig-TK_test_seq                                        /* 3dot7 */
                "&whattorun=1.5&h-act=MAINTENANCE'>" SKIP(1)                                /* 3dot7 */
                                
                "<button type='submit' class='btn'>" SKIP                                  /* 3dot3 */
                "Edit this Testkit"
                "</BUTTON>" SKIP(1)                                                        /* 3dot3 */
                
                "</a>"
                "</div>" SKIP
            "   <div class='grid_5'> </DIV>" SKIP
            "</div>" SKIP
            "<br>" SKIP.
              
/*******************************   Start "Page 1"   ****************************************************************/
                            
        FOR EACH tkr-2 NO-LOCK BREAK 
            BY tkr-2.found DESCENDING                                           /* show Y before N */
            BY tkr-2.tl-order 
            BY tkr-2.tld-order: 
                     
                                                                                    IF v-itmessage = YES THEN 
                                                                                        MESSAGE "inside 4ea tkr-2".
                                                                                        
            IF make-export-data = NO THEN DO:
                    
                IF found = YES THEN DO: 
                        
                    IF FIRST-OF (tkr-2.tl-order) THEN DO:
                        
                        x = 0.
                              
                        {&OUT}                      
                        "<div class='row'>"             SKIP
                        "<div class='grid_1'></div>"    SKIP
                        "<div class='grid_10'>"         SKIP
                        "   <div class='table_report fixed_table'>" SKIP
                        "       <table>"                SKIP
                        "           <thead>"            SKIP
                        "               <tr>"           SKIP
                        "                   <th colspan=3>" tkr-2.tl-section "</th>" SKIP
                        "               </tr>"          SKIP                                                        
                        "           <tr>"               SKIP        
                        "               <th>Item Name</th>" SKIP                                            /* 3dot6 */
                        "               <th>Result</th>" SKIP                                               /* 3dot6 */
                        "               <th>Graph</th>"  SKIP                                               /* 3dot6 */
                        "           </TR>" SKIP
                        "           </thead>" SKIP.  
                        
                    END. /*** first-of tkr-tl-order ***/
    
                    {&OUT} 
                        "           <tr>" SKIP 
                        "               <td><a href=~"TLitemmaintU.r?h-testtype=" tkr-2.tk-testtype  
                        "&h-sectid=" tkr-2.tld-id 
                        "&h-sectdesc=" tkr-2.tl-section 
                        "&h-itemid=" tkr-2.tld-item-id  
                        "&h-act=FIND ITEM&whattorun=4.8&Submit=FIND ITEM~">" tkr-2.marker-disp "</a></td> ".            /* 3dot6 */
                             
                    IF tkr-result = "< dl" THEN 
                        {&OUT}
                            "<TD> &lt; dl</TD>" SKIP.
                    ELSE 
                        {&OUT}       
                            "<td>" tkr-2.tkr-result " </td> " SKIP.
                                                            
                    IF tkr-2.tkr-minusSD <> "NULL" AND 
                        tkr-2.tkr-minusSD <> "< dl" AND 
                        tkr-2.tkr-minusSD <> "NONE" THEN
                        
                        ASSIGN 
                        themath = ABS((DECIMAL(tkr-2.tkr-minusSD) / (DECIMAL(tkr-2.tkr-plusSD) - DECIMAL(tkr-2.tkr-meanSD))) * 100).
                            
    /*                    ELSE ASSIGN themath = 135.*/
     
                                                                    if v-ITmessage = YES THEN 
                                                                        {&OUT}
                                                                            "<TD>Hi " tkr-2.tld-bar-type 
                                                                            " minusSD = " tkr-2.tkr-minusSD "</TD>" SKIP.
         
                    IF tkr-2.tld-bar-type = "bar" THEN DO:
                        
                        IF tkr-2.tkr-minusSD = "null"  OR 
                            tkr-2.tkr-minusSD = "< dl" OR 
                            tkr-2.tkr-minusSD = "NONE" THEN 
                                {&OUT} "<td class='leftToRightGradient'></td></tr>" SKIP.
                            
                        ELSE 
                            {&OUT} "<td class='leftToRightGradient'><div class='bar' style=~"width:" 
                                themath "%;~"></DIV></td></tr>" SKIP.
                               
                    END. /* of "bar" type */
                        
                    ELSE IF tkr-2.tld-bar-type = "centerBar" THEN DO:
                             
                        IF tkr-2.tkr-minusSD = "null" OR 
                            tkr-2.tkr-minusSD = "< dl" OR 
                            tkr-2.tkr-minusSD = "NONE" 
    /*                            OR                    */
    /*                            tkr-2.tkr-minusSD = ""*/
                            THEN
                            
                            {&OUT} "<td class='centerGradient'></td></tr>" SKIP.
                        
                        ELSE DO: 
                                
                            IF DECIMAL(tkr-2.tkr-minusSD) <= 0 THEN 
                                {&OUT} "<td class='centerGradient'><div class='centerToLeft' style=~"width:" 
                                    themath "%;~"></div></td></tr>" SKIP.
                                
                            IF DECIMAL(tkr-2.tkr-minusSD) > 0 THEN 
                                {&OUT} "<td class='centerGradient'><div class='centerToRight' style=~"width:" 
                                    themath "%;~"></div></td></tr>" SKIP.
                                                             
                        END.  /** of else do -- tkr-minusSD <> NULL OR "< dl" or "NONE" **/
                            
                    END. /* of "centerBar" type */
                        
                    ELSE IF tkr-2.tld-bar-type = "" THEN DO: 
                    
                        {&OUT}    
                            "<td><center><b>Unknown</b></center></td></tr>" SKIP.
                    
                    END.  /** of else if bar-type = "" **/
                        
                    ELSE 
                        {&OUT}
                            "<TD> Unknown [2] </TD>" SKIP
                            "</TR>" SKIP.
                           
                    IF LAST-OF (tkr-2.tl-order) THEN DO:
                        
												                        IF v-ITmessage = YES THEN
												                            DISPLAY "inside last of (tl-order = " tl-order "). ".
                        
                        {&OUT}
                            "        </table>" SKIP
                            "    </div>" SKIP
                            "</div><div class='grid_1'></div></div>" SKIP
                            "<br/>" SKIP.
                       
                    END. /** of Last-of tl-order **/
                           
                END.  /** of if found = yes **/
         
                ELSE IF found = NO THEN DO:
                                  
                    IF first-of(found) THEN  
                        {&OUT}
                            ""
                            "<div class='row'><div class='grid_1'></div>" SKIP
                            "<div class='grid_10'>"  
                            "   <div class='table_report fixed_table'>" SKIP
                            "       <table>" SKIP
                            "           <thead>" SKIP
                            "               <tr>" SKIP
                            "                   <th colspan=2>Unassigned</th>" SKIP
                            "               </tr>" SKIP                                                    
                            "               <tr>" SKIP        
                            "                   <td>Item Name</td>" SKIP
                            "                   <td>Results</td>" SKIP
                            "               </TR>" SKIP
                            "           </thead>" SKIP.
                                
                    {&OUT} 
                        "           <tr>" SKIP
/*                        "               <td>" tkr-2.tkr-item "</td>" SKIP*/                               /* 3dot6 */
                        "               <td>" tkr-2.marker-disp "</td>" SKIP                                /* 3dot6 */
                        "               <td>" tkr-2.tkr-result "</td>" SKIP
                        "           </tr>".
                        
                    IF LAST-OF(found) THEN 
                        {&OUT}
                            "</table></div>" SKIP
                            "</div><div class='grid_1'></div></div>".    
    
                END. /* If v-found = no */      
          
            END.  /** of if make-export-data = no **/
                
            IF make-export-data = YES THEN 
                EXPORT DELIMITER ";" tkr-2. 
          
        END. /*** of 4ea tkr-2 ***/
                    
        IF make-export-data = YES THEN                
            OUTPUT CLOSE.
                
/************************    START "PAGE 2"   ***************************************************************************/
    
        {&OUT}
            "<br/><br/>  <center> <h2>Supplement Details</h2> </center>  <br/>" SKIP.
    
        IF make-export-data = YES THEN
            OUTPUT TO "C:\progress\wrk\what-the-tkr-2.txt".
            
        FOR EACH tkr-2 NO-LOCK BREAK
            BY tkr-2.found DESCENDING                                           /* show Y before N */
            BY tkr-2.tl-order
            BY tkr-2.tld-order
            BY tkr-2.tkr-item:
    
    															                IF v-itmessage = YES THEN
    															                    MESSAGE "inside 2nd 4ea tkr-2".
    															
            IF make-export-data = NO THEN DO:
    
                IF FIRST-OF (tkr-2.tl-order) THEN DO:
       
                    {&OUT}		
                    "<div class='row'><div class='grid_1'></div>" SKIP
                    "<div class='grid_10'>" SKIP
                    "   <div class='table_report fixed_table'>"     SKIP
                    "       <table>"                    SKIP
                    "           <thead>"                SKIP
                    "               <tr>"               SKIP
                    "                   <th colspan=3>" tkr-2.tl-section "</th>" SKIP
                    "               </tr>"    SKIP
                    "               <tr>"         SKIP
                    "                   <th>Item Name</th>" SKIP                                        /* 3dot6 */
                    "                   <th>Result</th>"    SKIP                                        /* 3dot6 */
                    "                   <th class='inner5'>" SKIP                                        /* 3dot6 */
                    "                       <table>" SKIP                                               /* 3dot6 */
                    "                           <thead>" SKIP                                           /* 3dot6 */
                    "                               <tr>"    SKIP 
                    "                                   <th>Supplement</th>"  SKIP   
                    "                                   <th>From Dosage</th>" SKIP          /* 3dot5 */
                    "                                   <th>To Dosage</th>"   SKIP          /* 3dot5 */            
                    "                                   <th>UOM</th>"         SKIP
                    "                                   <th>Notes</th>"       SKIP
                    "                               </tr>" SKIP                                         /* 3dot6 */
                    "                           </thead>" SKIP                                          /* 3dot6 */
                    "                       </table>" SKIP                                              /* 3dot6 */
                    "                   </th>" SKIP
                    "               </TR>" SKIP
                    "           </thead>" SKIP
                    "           <tbody>" SKIP.
    
                END. /*** first-of tkr-tl-order ***/
    	
                {&OUT}    
                    "           <tr>" SKIP
/*                    "               <td> " tkr-2.tkr-item "</td>" SKIP*/                              /* 3dot6 */
                    "               <td> " tkr-2.marker-disp "</td>" SKIP                               /* 3dot6 */
                    "               <td> " tkr-2.tkr-result "</td>" SKIP
                    "               <td class='inner5'>" SKIP
                    "                   <table>"    SKIP.
                    
                ASSIGN 
                    y = y + 1
                    x = x + 1 
                    v-inside-trr4ea = NO.
                    
                IF x MODULO 2 = 0 THEN ASSIGN v-green = " class='green' ".
                        
                ELSE ASSIGN v-green = "".                    
    
                FOR EACH trr_det WHERE 
                    trr_det.trr_testtype    = tkr-2.TK-testtype AND
                    trr_det.trr_item_ID     = tkr-2.tld-item-id AND 
                    ((trr_det.trr_start_range <= tkr-2.tkr-resval) OR   /* 3dot5 */
                    (trr_det.trr_start_range = 0)) AND                  /* 3dot5 */               
                    ((trr_det.trr_end_range >= tkr-2.tkr-resval) OR     /* 3dot5 */
                    (trr_det.trr_end_range = 0)) AND                    /* 3dot5 */
                    trr_det.trr_charstart = tkr-2.tkr-result AND        /* 3dot8 */
                    trr_det.trr_charend = tkr-2.tkr-result AND          /* 3dot8 */
                    ((trr_det.trr_start_eff >= userdate) OR             /* 3dot5 */
                    (trr_det.trr_start_eff   = ?)) AND                  /* 3dot5 */
                    ((trr_det.trr_end_eff   <= userdate) OR             /* 3dot5 */
                    (trr_det.trr_end_eff     = ?)) AND                  /* 3dot5 */
                    trr_det.trr_deleted = ? NO-LOCK,
                    FIRST suppl_list WHERE 
                        suppl_list.suppl_id = trr_det.trr_suppl_id NO-LOCK            
                    BREAK BY trr_det.trr_order BY trr_det.trr_start_range BY suppl_list.suppl_name :
                
                    {&OUT}  
                        "                   <tr>" SKIP
                        "                       <td " v-green " >" suppl_list.suppl_name "</td>" SKIP
                        "                       <td " v-green " >" trr_det.trr_dosage_from "</td>" SKIP             /* 3dot5 */
                        "                       <td " v-green " >" trr_det.trr_dosage_to "</td>" SKIP               /* 3dot5 */
                        "                       <td " v-green " >" trr_det.trr_uom "</td>" SKIP
                        "                       <td " v-green " >" trr_det.trr_notes "</td>" SKIP
                        "                   </tr>" SKIP.
                    
                    ASSIGN v-inside-trr4ea = YES.
                        
                END. /*** 4ea trr_det ***/  
                    
                IF v-inside-trr4ea = NO THEN  /*** this is the "if the trr_det 4ea returns empty ***/
                    {&OUT} 
                        "                   <tr>" SKIP 
                        "                       <td " v-green " > </td>" SKIP 
                        "                       <td " v-green " > </td>" SKIP 
                        "                       <td " v-green " > </td>" SKIP 
                        "                       <td " v-green " > </td>" SKIP 
                        "                       <td " v-green " > </td>" SKIP
                        "                   </tr>" SKIP.      
    
                {&OUT} 
                    "               </table>" SKIP 
                    "           </td>" SKIP 
                    "       </tr>" SKIP.
        
                IF LAST-OF (tkr-2.tl-order) THEN DO:
                    {&OUT}
                       "        </tbody>" SKIP
                       "        </table>" SKIP
                       "    </div>" SKIP
                       "</div><div class='grid_1'></div></div>" SKIP
                       "<br>" SKIP.
                       
                    ASSIGN 
                        x = 0
                        y = 0 .
    
                END. /** of last-of tkr-2.tl-order **/
    
                IF LAST-OF (tkr-2.found) THEN {&OUT} "</table></div></div></div><br/>" SKIP.
    
            END.  /** of if make-export-data = no **/
    
            IF make-export-data = YES THEN
                EXPORT DELIMITER ";" tkr-2.
                
        END. /*** of 4ea tkr-2 ***/  
              
        /********************************************** PAGE 3 ********************************************************/
    
        {&OUT}
            "<br/><br/>" SKIP 
            "<center><h2>Supplements and their Supports</h2></center><!---------------### PAGE 3 ###-------------->" SKIP .
            
        IF make-export-data = YES THEN
            OUTPUT TO "C:\progress\wrk\what-the-tkr-2.txt".
            
        IF make-export-data = NO THEN DO:
            
            {&OUT}      
                "<div class='row'><div class='grid_1'></div>"                       SKIP
                "<div class='grid_10'>"                                             SKIP
                "   <div class='table_report fixed_table'>"                         SKIP
                "       <table>"                                                    SKIP
                "           <thead>"                                                SKIP
                "               <tr>"                                               SKIP
                "                   <th colspan=5>Reasons for Each Supplement</th>" SKIP
                "               </tr>"                                              SKIP
                "           <tr>"                                                   SKIP
                "               <td>Supplement</td>"                                SKIP
                "               <td>From Dosage</td>"                               SKIP        /* 3dot5 */
                "               <td>To Dosage</td>"                                 SKIP        /* 3dot5 */
                "               <td>UOM</td>"                                       SKIP
                "               <td class='inner' style='width:30%;'>"              SKIP
                "                   <table><tr>"                                    SKIP 
                "                       <th>Item Name</td>"                         SKIP   
                "                       <th>Result</td>"                            SKIP
                "                   </tr></table>"                                  SKIP
                "               </td>"                                              SKIP
                "           </TR>"                                                  SKIP
                "           </thead>"                                               SKIP
                "           <tbody>"                                                SKIP.
            
            FOR EACH tkr-2 NO-LOCK, 
            EACH trr_det WHERE 
                trr_det.trr_testtype    = tkr-2.TK-testtype AND
                trr_det.trr_item_ID     = tkr-2.tld-item-id AND 
                trr_det.trr_start_range <= tkr-2.tkr-resval AND 
                trr_det.trr_end_range   >= tkr-2.tkr-resval AND 
                trr_det.trr_charstart   = tkr-2.tkr-result AND      /* 3dot8 */
                trr_det.trr_charend     = tkr-2.tkr-result AND      /* 3dot8 */
                ((trr_det.trr_start_eff >= userdate) OR             /* 3dot5 */
                (trr_det.trr_start_eff   = ?)) AND                  /* 3dot5 */
                ((trr_det.trr_end_eff   <= userdate) OR             /* 3dot5 */
                (trr_det.trr_end_eff     = ?)) AND                  /* 3dot5 */
                trr_det.trr_deleted = ? NO-LOCK,
             FIRST suppl_list WHERE suppl_list.suppl_id = trr_det.trr_suppl_id NO-LOCK            
                 BREAK BY suppl_list.suppl_name BY tkr-2.tkr-item:
    
                    IF FIRST-OF (suppl_list.suppl_name) THEN DO:
           
                    x = x + 1.
                    
                    IF x MODULO 2 = 0 THEN 
                        ASSIGN v-green = " class='green' ".
                        
                        ELSE ASSIGN v-green = "".
           
                    {&OUT}    
                        "           <tr>"                                                   SKIP
                        "               <td> " suppl_list.suppl_name "</td>"                SKIP
/*                        "       <td " v-green " >" trr_det.trr_dosage "</td>" SKIP*/
                        "       <td " v-green " >" trr_det.trr_dosage_from "</td>" SKIP             /* 3dot5 */
                        "       <td " v-green " >" trr_det.trr_dosage_to "</td>" SKIP               /* 3dot5 */
                        "               <td> " trr_det.trr_uom "</td>"                      SKIP
                        "               <td class='inner' style='width:30%;'>"              SKIP
                        "                   <table>"                                        SKIP.    
        
                    END. /*** first-of tkr-tl-order ***/
                 
                    {&OUT}  
                        "   <tr>" SKIP
/*                        "       <td " v-green " >" tkr-2.tkr-item "</td>" SKIP*/                      /* 3dot6 */
                        "       <td " v-green " >" tkr-2.marker-disp "</td>" SKIP                          /* 3dot6 */
                        "       <td " v-green " >" tkr-2.tkr-result "</td>" SKIP
                        "   </tr>" SKIP.      
        
                    IF LAST-OF (suppl_list.suppl_name) THEN DO:
                       
                        {&OUT}
                            "        </table></td>" SKIP  
                            "</tr>".  
    
                    END. /** of last-of suppl_list.suppl_name **/ 

                END.  /** of if make-export-data = no **/
    
            IF make-export-data = YES THEN
                EXPORT DELIMITER ";" tkr-2.
    
        END. /*** of 4ea tkr-2 ***/
        
        {&OUT}
                           "        </tbody>"                       SKIP
                           "        </table>"                       SKIP
                           "    </div>"                             SKIP
                           "</div><div class='grid_1'></div></div>" SKIP.  
                                
        IF make-export-data = YES THEN                
            OUTPUT CLOSE.        
                        
        /***************** END OF PAGE 3 ****************/             
        
        {&OUT}
            "<br></br>" SKIP           
            "<div class='row'>" SKIP
            "   <div class='grid_5'> </DIV>" SKIP
            "   <div class='grid_2'>" SKIP
            "           <a href='../../DataHub/rcode/TKtestSearchR.r?whattorun=14.5'>"
            "       <BUTTON type='submit' class='btn'>" SKIP                                           /* 3dot3 */
                        "Search Again"
            "       </BUTTON>"                                                                         /* 3dot3 */
            "</a>" SKIP             /* 3dot2 */
            "</div>" SKIP
            "   <div class='grid_5'> </DIV>" SKIP
            "</div>" SKIP.

    END. /*** of if v-everything-failed = no ***/

END. /*** v-act0 1 ***/

                                                                                            IF v-itmessage = YES THEN 
                                                                                                {&OUT} "END OF LINE.".
</SCRIPT>
</BODY>
</HTML>