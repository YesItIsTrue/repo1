"cm.ui.merchant.creditcard".namespace();"cm.secure".namespace();cm.ui.merchant.creditcard.CreditCardAddVaultClientWrapperConfigOptions=Class.create(cm.ui.IframeConfigOptions,{vaultClientScriptResourceUrl:null});cm.ui.merchant.creditcard.CreditCardAddVaultClientWrapper=Class.create(cm.ui.ComplexControl,{SavedEvent:null,CancelEvent:null,ErrorEvent:null,configureDefaultOptions:function(){return new cm.ui.merchant.creditcard.CreditCardAddVaultClientWrapperConfigOptions()},initializeData:function(){this._cfo=this.GetConfigOptions();this.initializeVault();this._financialSettings=this._cfo.financialSettings;if($$CM.isNull(this._financialSettings)){this._financialSettings={}}},initializeUIElements:function(){var a=this._cfo.iFrameConfigOptions||{src:this._cfo.src,height:this._cfo.height,width:this._cfo.width};this._iFrame=new $$IFRM(this._id,a);this.AddChild(this._iFrame)},createEvents:function($super){$super();this.SavedEvent=new cm.event();this.CancelEvent=new cm.event();this.ErrorEvent=new cm.event()},postInitialize:function(){},handleVaultClientComplete:function(a){this.SavedEvent.fire(this,a)},handleVaultClientCancel:function(){this.CancelEvent.fire(this)},handleVaultClientError:function(a){this.ErrorEvent.fire(this,a)},onDataUpdated:function(){var a=this.GetBoundData();if($$CM.isNull(this._vault)){this.initializeVault();this._vault=cm.secure.vaultClient}this._vault.initialize(a.CreditCardVaultCategoryTypeID,a.ObjectID,this.getVaultBillingData(a),this.handleVaultClientComplete,this.handleVaultClientCancel,this._financialSettings.RequiresEmail,this.handleVaultClientError,this);var b=this._vault.getUrl(this._configOptions.style);this._iFrame.SetSrc(b)},initializeVault:function(){if($$CM.isNull(cm.secure.vaultClient)){var a=jQuery.ajax({async:false,type:"GET",url:this._cfo.vaultClientScriptResourceUrl,data:null,success:null,dataType:"script"});this.setVault(a.responseText)}},setVault:function(script){eval(script)},getVaultBillingData:function(a){if($$CM.isNull(a)||($$CM.isNull(a.Address)&&$$CM.isEmpty(a.FirstName)&&$$CM.isEmpty(a.LastName))){return null}var b={FirstName:a.FirstName,LastName:a.LastName};if(!$$CM.isNull(a.Address)){b.Address={Address1:a.Address.Address1,Address2:a.Address.Address2,City:a.Address.City,StateProvince:a.Address.StateProvince,PostalCode:a.Address.PostalCode,Country:a.Address.Country}}return b}});"cm.ui.merchant.creditcard".namespace();cm.ui.merchant.creditcard.CreditCardAddVaultDialogConfigOptions=Class.create(cm.ui.dialog.ModalDialogConfigOptions,{creditCardAddVaultClientWrapperConfigOptions:{vaultClientScriptResourceUrl:null}});cm.ui.merchant.creditcard.CreditCardAddVaultDialog=Class.create(cm.ui.dialog.ModalDialog,{SavedEvent:null,CancelEvent:null,ErrorEvent:null,configureDefaultOptions:function(){return new cm.ui.merchant.creditcard.CreditCardAddVaultDialogConfigOptions()},initializeData:function(){this._cfo=this.GetConfigOptions();this._financialSettings=this._cfo.financialSettings},initializeUIElements:function(){this._vaultClientWrapper=new cm.ui.merchant.creditcard.CreditCardAddVaultClientWrapper(null,this._cfo);this.AddChild(this._vaultClientWrapper)},createEvents:function($super){$super();this.SavedEvent=new cm.event();this.CancelEvent=new cm.event();this.ErrorEvent=new cm.event()},wireEvents:function($super){$super();this._vaultClientWrapper.SavedEvent.subscribe(this.onCreditCardAddSave,this);this._vaultClientWrapper.CancelEvent.subscribe(this.onCreditCardAddCancel,this);this._vaultClientWrapper.ErrorEvent.subscribe(this.onCreditCardAddError,this)},onCreditCardAddSave:function(b,a){this.SavedEvent.fire(this,a)},onCreditCardAddCancel:function(){this.CancelEvent.fire(this)},onCreditCardAddError:function(b,a){this.ErrorEvent.fire(this,a)},Bind:function(a){this._vaultClientWrapper.Bind(a)}});"cm.ui.merchant.creditcard".namespace();cm.ui.merchant.creditcard.CreditCardVaultConfigOptions=Class.create(cm.ConfigOptions,{showCloseButton:false,objectID:0,creditCardTypeIDArray:$A(),creditCardCategoryID:0,creditCardGatewayTypeID:0,classNames:"creditCardVault"});cm.ui.merchant.creditcard.CreditCardVault=Class.create(cm.ui.ComplexControl,{_cardNameAbbreviations:{VISA:"VISA",MASTERCARD:"MC",AMEX:"AMEX",DISCOVER:"DISC"},_cfo:null,_creditCard:new Object(),_isExistingCard:false,_iFrame:null,_divBody:null,_ftxtCardNumber:null,_dtcExpiration:null,_fcExpiration:null,_ftxtFirstName:null,_ftxtLastName:null,_fAddress:null,_btnCancel:null,_btnSave:null,_formForNMIPost:null,PriorToNMIEvent:null,SaveEvent:null,CancelEvent:null,ErrorEvent:null,configureDefaultOptions:function(){return new cm.ui.merchant.creditcard.CreditCardVaultConfigOptions()},initializeDAOs:function($super){this._financialDAO=new cm.dao.Financial.DAO();this._merchantDAO=new cm.dao.Merchant.DAO();this._merchantDAO.bindGatewayType(this.GetConfigOptions().creditCardGatewayTypeID)},initializeData:function($super){this._cfo=this.GetConfigOptions();this.BindAcceptedCreditCards(this._cfo.creditCardTypeIDArray);this._requiresEmail=false;if(!$$CM.isNull(this._cfo.financialSettings)){this._requiresEmail=this._cfo.financialSettings.RequiresEmail}},initializeNMIFormAndAnIFrame:function(){var b="iframeForNMIPost";this._iFrame=$$P.iframe(b,"javascript:false;",1,1,null);this._iFrame.SetAttribute("name",b);this.AddChild(this._iFrame);this._iFrame.Hide();var a=$$P.div(null);this.AddChild(a);a.Hide();this._formForNMIPost=$$P.frm("frmAdd");a.AddChild(this._formForNMIPost);this._formForNMIPost.SetAttribute("method","post");this._formForNMIPost.SetAttribute("target",b);this._formForNMIPost.SetAttribute("enctype","application/x-www-form-urlencoded");this._billing_cc_number=$$P.hdn("billing-cc-number");this._formForNMIPost.AddChild(this._billing_cc_number);this._billing_cc_number.SetAttribute("name","billing-cc-number");this._billing_cc_exp=$$P.hdn("billing-cc-exp");this._formForNMIPost.AddChild(this._billing_cc_exp);this._billing_cc_exp.SetAttribute("name","billing-cc-exp")},initializeUIElements:function($super){this.initializeNMIFormAndAnIFrame();this.AddClassName("nofbBody");this._divBody=$$P.div("AddCreditCard",null,{classNames:"cmCCVault"});this.AddChild(this._divBody);var d=$$P.p("pciNotice","Your credit card information is being stored in a <strong>Level 1 PCI compliant vault</strong>.");this._divBody.AddChild(d);this._ftxtCardNumber=new $$FTXT("creditCardNumber",{label:"Credit Card Number",spanWidth:330,inputWidth:330,maxLength:16,isRequired:true});this._divBody.AddChild(this._ftxtCardNumber);var a=$$P.div("divRow1",null,{classNames:"cmFormRow"});this._divBody.AddChild(a);this._dtcExpiration=new cm.ui.common.DateTimeControl("expirationDate",{includeYear:true,includeMonth:true,includeDay:false,includeHour:false,includeMinute:false,requireDate:true});this._fcExpiration=new $$FC(this._dtcExpiration,"formExpiration",{label:"Expiration",isRequired:true});a.AddChild(this._fcExpiration);currentYear=new Date().getFullYear();this._dtcExpiration.Bind(null,currentYear,currentYear+10);var e=$$P.div("cmCCSpacerDiv",null,{classNames:"cmInputLabel"});a.AddChild(e);var b=$$P.div("divRow2",null,{classNames:"cmFormRow"});this._divBody.AddChild(b);this._ftxtFirstName=new $$FTXT("_ftxtFirstName",{label:"First Name",isRequired:true});b.AddChild(this._ftxtFirstName);this._ftxtLastName=new $$FTXT("_ftxtLastName",{label:"Last Name",isRequired:true,classNames:"cmFloatRight"});b.AddChild(this._ftxtLastName);if(this._requiresEmail){this._txtEmail=new $$FTXT("_txtEmail",{label:"Email",isRequired:true,classNames:"cmFloatLeft",inputWidth:330,spanWidth:330});this._divBody.AddChild(this._txtEmail)}this._fAddress=new $$FADDRESS(null,{required:true,addressLabel:"Billing Address",address2Label:"Billing Address Line 2",zipLabel:"Zip/Post"});this._divBody.AddChild(this._fAddress);var c=$$P.div("divRow3",null,{classNames:"cmFormRow"});this._divBody.AddChild(c);this._btnCancel=new $$BTN("_btnCancel",{classNames:"cmCancelDeleteButton mt10px"});c.AddChild(this._btnCancel);this._btnCancel.Bind("Cancel");this._btnSave=new $$BTN("_btnSave",{classNames:"cmGoButton cmFloatRight mt10px mr25px"});c.AddChild(this._btnSave);this._btnSave.Bind("Save")},createEvents:function($super){$super();this.AddEnterPressListener();this._ftxtCardNumber.AddChangeListener();this._dtcExpiration.AddChangeListener();this._ftxtFirstName.AddChangeListener();this._ftxtLastName.AddChangeListener();if(this._requiresEmail){this._txtEmail.AddChangeListener()}this._iFrame.AddLoadListener();this.SaveEvent=new cm.event();this.SaveCompleteEvent=new cm.event();this.CancelEvent=new cm.event();this.ErrorEvent=new cm.event();this.PriorToNMIEvent=new cm.event()},wireEvents:function($super){$super();this.EnterPressEvent.subscribe(this.onSaveClicked,this);this._btnCancel.ClickEvent.subscribe(this.onCancelClicked,this);this._btnSave.ClickEvent.subscribe(this.onSaveClicked,this);this._merchantDAO.creditCardAddedEvent.subscribe(this.onCreditCardAdded,this);this._iFrame.OnLoadEvent.subscribe(this.onIFrameLoaded,this);this._merchantDAO.creditCardCompletedEvent.subscribe(this.onCreditCardCompleted,this)},postInitialize:function($super){this.SetValidation()},SetValidation:function(){this._ftxtFirstName.Validator.addEvaluator($$EVAL.TEXT({FieldName:"First Name",IsRequired:true,MinLength:1}),this._ftxtFirstName.ChangeEvent);this._ftxtFirstName.Validator.Enable();this._ftxtLastName.Validator.addEvaluator($$EVAL.TEXT({FieldName:"Last Name",IsRequired:true,MinLength:1}),this._ftxtLastName.ChangeEvent);this._ftxtLastName.Validator.Enable();if(this._requiresEmail){this._txtEmail.Validator.addEvaluator($$EVAL.TEXT({FieldName:"Email",IsRequired:true,MinLength:7}),this._txtEmail.ChangeEvent);this._txtEmail.Validator.Enable()}},SetTabIndex:function(a){this._ftxtCardNumber.SetTabIndex(a++);this._dtcExpiration._ddlMonth.SetTabIndex(a++);this._dtcExpiration._ddlYear.SetTabIndex(a++);this._ftxtFirstName.SetTabIndex(a++);this._ftxtLastName.SetTabIndex(a++);if(this._requiresEmail){this._txtEmail.SetTabIndex(a++)}this._fAddress.SetTabIndex(a++);this._btnSave.SetTabIndex(a+=5)},BindConfigOptions:function(a){this._cfo=a;if(!$$CM.isNull(a.creditCardGatewayTypeID)){this._merchantDAO.bindGatewayType(a.creditCardGatewayTypeID)}if(!$$CM.isNull(a.creditCardTypeIDArray)){this.BindAcceptedCreditCards(a.creditCardTypeIDArray)}},BindAcceptedCreditCards:function(a){this._creditCardTypeArrayString="";this._creditCardTypesString=a.join();a.each(function(b){var c=this._financialDAO.GetEnum("CreditCardTypeAbbreviated").GetName(b);if(this._cardNameAbbreviations[c.toUpperCase()]){this._creditCardTypeArrayString+=this._cardNameAbbreviations[c.toUpperCase()]}else{this._creditCardTypeArrayString+=c.toUpperCase()}this._creditCardTypeArrayString+="/"},this);this._creditCardTypeArrayString=this._creditCardTypeArrayString.substr(0,this._creditCardTypeArrayString.length-1)},Validate:function(a){var b=this.Validator.validate();if(b.IsValid()){var c=new cm.validation.ValidationResult("",null);if(this.isCreditCardExpired(this._dtcExpiration.GetData())){c.AddError("Credit card is expired.");a=true}b.AppendResult(c)}if(a==true){this.Validator.ShowErrors(b)}return b},IsValid:function(a){var b=this.Validate(a);return b.IsValid()},isCreditCardExpired:function(a){var c=moment.utc();var b=moment.utc(a,"YYYY-MM-DD");if(c.year()>b.year()||(c.year()==b.year()&&c.month()>b.month())){return true}return false},Reset:function($super){this._creditCard=null;this._isExistingCard=false;this._ftxtCardNumber.Bind(null);this._ftxtCardNumber.Validator.Enable();this._ftxtCardNumber.SetEnabled(true);currentYear=new Date().getFullYear();this._dtcExpiration.Bind(null,currentYear,currentYear+10);this._ftxtFirstName.Bind(null);this._ftxtLastName.Bind(null);this._fAddress.Bind(null);this._ftxtCardNumber.Validator.Clear();this._ftxtFirstName.Validator.Clear();this._ftxtLastName.Validator.Clear()},onDataUpdated:function(){this.Reset();data=this.GetBoundData();this._creditCard=data;if(!$$CM.isNull(data)){this._isExistingCard=false;if($$CM.isNull(data.IsExistingCard)||data.IsExistingCard==true){this._isExistingCard=true}if(!$$CM.isNull(data.NumberLastFour)){this._ftxtCardNumber.Bind("************"+data.NumberLastFour);this._ftxtCardNumber.Validator.Disable();this._ftxtCardNumber.SetEnabled(false)}currentYear=new Date().getFullYear();if(!$$CM.isEmpty(data.ExpirationAsString)){this._dtcExpiration.Bind(data.ExpirationAsString,currentYear,currentYear+10)}this._ftxtFirstName.Bind(data.FirstName);this._ftxtLastName.Bind(data.LastName);if(!$$CM.isNull(data.Address)){this._fAddress.Bind(data.Address)}}},GetData:function(){var b=this.GetBoundData();if($$CM.isNull(b)){b=new Object()}if($$CM.isNull(b.ID)){b.ID=-1}b.VaultID=(this._isExistingCard==true&&!$$CM.isNull(b.VaultID))?b.VaultID:-1;b.ObjectID=this._cfo.objectID;b.Number="";var c=this._dtcExpiration.GetData();b.ExpirationAsString=c.slice(0,c.indexOf("T"));b.FirstName=this._ftxtFirstName.GetData();b.LastName=this._ftxtLastName.GetData();b.Address=this._fAddress.GetData();if(!this._isExistingCard){b.IsDefault=true;b.VaultConfirmed=false;b.CreditCardCategory=this._cfo.creditCardCategoryID;var d=this._ftxtCardNumber.GetData();b.NumberLastFour=d.substr(d.length-4,4);var a=$$CM.getCreditCardType(d);b.CreditCardType=cm.dao.Financial.Enums.CreditCardTypeAbbreviated.asEnum().GetId(a)}if(this._requiresEmail){b.email=this._txtEmail.GetData()}return b},onCancelClicked:function(b,a){this.CancelEvent.fire(this)},onSaveClicked:function(c,a){if(this.IsValid(true)){var b=this.GetData();this.SaveEvent.fire(this,{data:b});if(this._isExistingCard!=true){$$CMD.ShowWaitDialog({message:"Saving data in PCI Compliant Manner.<br />Please wait..."});this._merchantDAO.AddNewCreditCard(b,"/ui/merchant/creditcard/CreditCardVaultComplete")}}},onCreditCardAdded:function(c,a){$$CMD.HideWaitDialog();if(a.success==true){var b=null;if(!$$CM.isUndefinedOrNull(a.data)){b=a.data}else{if(!$$CM.isUndefinedOrNull(a.result)){b=a.result}}if($$CM.isUndefinedOrNull(b.FormUrl)||b.FormUrl.length==0){this.ErrorEvent.fire(this,{error:"There has been an error while creating a new credit card with NMI."})}else{this.PriorToNMIEvent.fire(this,b);this._creditCard=b;this.PostToNMI(b)}}else{if($$CM.isUndefinedOrNull(a.error)){a.error="Failed to add credit card. No details were provided."}this.ErrorEvent.fire(this,a)}},PostToNMI:function(b){this._formForNMIPost.SetAttribute("action",b.FormUrl);var a=this._ftxtCardNumber.GetData();this._billing_cc_number.SetAttribute("value",a);var c=moment.utc(this._dtcExpiration.GetData(),"YYYY-MM-DD").format("MMYY");this._billing_cc_exp.SetAttribute("value",c);window.ccvScope=this;jQuery($$E(this._formForNMIPost)).submit()},onIFrameLoaded:function(b,a){var c=b.GetHtmlElement();var d=c.contentWindow.document.URL.indexOf("token-id");if(d>0){var e=this;if(window.ccvScope){e=window.ccvScope}var f=c.contentWindow.document.URL.substr(d+9);if($$CM.isNull(this._creditCard)){this._creditCard=a.data}e._creditCard.TokenID=f;e._merchantDAO.CompleteNewCreditCard(e._creditCard)}},onCreditCardCompleted:function(b,a){$$CMD.HideWaitDialog();if(a.success==true){$$GROWL.ShowBanner("Credit card successfully "+((this._isExistingCard==false)?"added.":"updated."),2000);this._isExistingCard=true;if($$CM.isNull(this._creditCard)){this._creditCard=a.data}this._creditCard.ID=a.data.ID;this._creditCard.VaultID=a.data.VaultID;this.SaveEvent.fire(this,{data:this._creditCard});this.SaveCompleteEvent.fire(this,{data:this._creditCard})}},setFacebookClass:function(){this.AddClassName("fbBody")}});"cm.ui.merchant.creditcard".namespace();cm.ui.merchant.creditcard.CreditCardVaultComplete=Class.create(cm.ui.Controller,{mvcController:"merchant/creditcard/CreditCardVaultComplete",_tokenID:null,initializeData:function(){$$CM.PopulateQueryString();this._tokenID=$$CM.QueryStringObject["token-id"]}});"cm.ui.merchant.creditcard".namespace();cm.ui.merchant.creditcard.CreditCardVaultDialogConfigOptions=Class.create(cm.ui.dialog.ModalDialogConfigOptions,{vaultConfigOptions:null});cm.ui.merchant.creditcard.CreditCardVaultDialog=Class.create(cm.ui.dialog.ModalDialog,{PriorToNMIEvent:null,SaveEvent:null,CancelEvent:null,ErrorEvent:null,configureDefaultOptions:function(){return new cm.ui.merchant.creditcard.CreditCardVaultDialogConfigOptions()},initializeData:function(){this._cfo=this.GetConfigOptions()},initializeUIElements:function(){this._ccv=new cm.ui.merchant.creditcard.CreditCardVault("CCV",this._cfo.vaultConfigOptions);this.AddChild(this._ccv)},createEvents:function($super){$super();this.SaveEvent=new cm.event();this.CancelEvent=new cm.event();this.ErrorEvent=new cm.event();this.PriorToNMIEvent=new cm.event()},wireEvents:function($super){$super();this._ccv.PriorToNMIEvent.subscribe(this.onPriorToNMI,this);this._ccv.SaveEvent.subscribe(this.onSaveClicked,this);this._ccv.CancelEvent.subscribe(this.onCancelClicked,this);this._ccv.ErrorEvent.subscribe(this.onError,this)},onSaveClicked:function(b,a){if(this._ccv._isExistingCard==true){this.SaveEvent.fire(this,a)}},onCancelClicked:function(b,a){this.Hide();this.CancelEvent.fire(this,a)},onPriorToNMI:function(b,a){this.PriorToNMIEvent.fire(this,a)},onError:function(b,a){this.ErrorEvent.fire(this,a)},Bind:function(a){this._ccv.Bind(a)},GetData:function(){this._ccv.GetData(data)}});"cm.ui.merchant.creditcard".namespace();cm.ui.merchant.creditcard.CreditCardVaultUPRConfigOptions=Class.create(cm.ConfigOptions,{objectID:0,creditCardTypeIDArray:$A(),creditCardCategoryID:0,creditCardGatewayTypeID:0,billingData:null,classNames:"creditCardVault"});cm.ui.merchant.creditcard.CreditCardVaultUPR=Class.create(cm.ui.ComplexControl,{PriorToNMIEvent:null,SavedEvent:null,CancelEvent:null,ErrorEvent:null,configureDefaultOptions:function(){return new cm.ui.merchant.creditcard.CreditCardVaultUPRConfigOptions()},initializeData:function($super){this._co=this.GetConfigOptions();if(!$$CM.isEmpty(this._co.uniqueID)){this._uniqueID=this._co.uniqueID}else{this._uniqueID=$$CM.uniqueID()}this._objectID=this._co.objectID;this._creditCardTypeIDArray=this._co.creditCardTypeIDArray;this._creditCardCategoryID=this._co.creditCardCategoryID;this._creditCardGatewayTypeID=this._co.creditCardGatewayTypeID;this._creditCardGatewayCategoryID=this._co.creditCardGatewayCategoryID;this._enumCreditCardGatewayType=FW.Enums.Financial.CreditCardGatewayType;this._enumCreditCardCategory=FW.Enums.Financial.CreditCardCategory;this._enumCreditCardType=FW.Enums.Financial.CreditCardTypeAbbreviated;this._cardNameAbbreviations={VISA:"VISA",MASTERCARD:"MC",AMEX:"AMEX",DISCOVER:"DISC"};this._creditCard=new Object();this._isExistingCard=false;this._iframeVaultID="iframeVaultID";this.setAcceptedCreditCardStrings(this._co.creditCardTypeIDArray);this._requiresEmail=this._co.financialSettings.RequiresEmail},BindConfigOptions:function(a){this._co=a;if(!$$CM.isEmpty(this._co.uniqueID)){this._uniqueID=this._co.uniqueID}else{this._uniqueID=$$CM.uniqueID()}if($$CM.isArray(this._co.objectID)){this._objectID=this._co.objectID}if($$CM.isArray(this._co.creditCardTypeIDArray)){this._creditCardTypeIDArray=this._co.creditCardTypeIDArray}if(!$$CM.isNull(this._co.creditCardCategoryID)){this._creditCardCategoryID=this._co.creditCardCategoryID}if(!$$CM.isNull(this._co.creditCardGatewayTypeID)){this._creditCardGatewayTypeID=this._co.creditCardGatewayTypeID}if(!$$CM.isNull(this._co.creditCardGatewayCategoryID)){this._creditCardGatewayCategoryID=this._co.creditCardGatewayCategoryID}if(!$$CM.isNull(this._co.creditCardTypeIDArray)){this.setAcceptedCreditCards(this._co.creditCardTypeIDArray);this.toggleAcceptedCreditCards()}},BindObjectID:function(a){this._co=this.GetConfigOptions();this._co.objectID=a;this._objectID=a},initializeUIElements:function(){this.AddClassName("nofbBody");this.initializeIFrame();this._divBody=$$P.div("divCreditCardVaultBody");this.AddChild(this._divBody);this._divBody.AddClassName("cmCCVault creditCardVaultBody");this._pPCINotice=$$P.p("pPCINotice","Your credit card information is being stored in a <strong>Level 1 PCI compliant vault</strong>.");this._divBody.AddChild(this._pPCINotice);this._pPCINotice.AddClassName("pciNotice");this._ftxtCardNumber=new $$FTXT("creditCardNumber",{label:"Credit Card Number",spanWidth:330,inputWidth:330,fieldTip:"NO SPACES, EX:4375009012859081",maxLength:16,isRequired:true});this._divBody.AddChild(this._ftxtCardNumber);var a=$$P.div("divRow1",null,{classNames:"cmFormRow"});this._divBody.AddChild(a);this._dtcExpiration=new cm.ui.common.DateTimeControl("expirationDate",{includeYear:true,includeMonth:true,includeDay:false,includeHour:false,includeMinute:false,requireDate:true});this._fcExpiration=new $$FC(this._dtcExpiration,"formExpiration",{label:"Expiration",isRequired:true});a.AddChild(this._fcExpiration);currentYear=new Date().getFullYear();this._dtcExpiration.Bind(null,currentYear,currentYear+10);var d=$$P.div("divSpacer",null,{classNames:"cmInputLabel spacer"});a.AddChild(d);var b=$$P.div("divRow2",null,{classNames:"cmFormRow"});this._divBody.AddChild(b);this._ftxtFirstName=new $$FTXT("ftxtFirstName",{label:"First Name",isRequired:true});b.AddChild(this._ftxtFirstName);this._ftxtLastName=new $$FTXT("ftxtLastName",{label:"Last Name",isRequired:true,classNames:"cmFloatRight"});b.AddChild(this._ftxtLastName);if(this._requiresEmail){this._txtEmail=new $$FTXT("_txtEmail",{label:"Email",isRequired:true,classNames:"cmFloatLeft",inputWidth:330,spanWidth:330});this._divBody.AddChild(this._txtEmail)}this._fAddress=new $$FADDRESS(null,{required:true,addressLabel:"Billing Address",address2Label:"Billing Address Line 2",zipLabel:"Zip/Post"});this._divBody.AddChild(this._fAddress);var c=$$P.div("divRow3",null,{classNames:"cmFormRow"});this._divBody.AddChild(c);this._btnSave=new $$BTN("btnSave",{classNames:"cmGoButton cmFloatRight mt10px mr25px btnSave"});c.AddChild(this._btnSave);this._btnSave.Bind("Save");this._btnCancel=new $$BTN("btnCancel",{classNames:"cmCancelDeleteButton mt10px"});c.AddChild(this._btnCancel);this._btnCancel.Bind("Cancel");this.SetTabIndex(100)},initializeIFrame:function(){this._iframeVault=$$P.iframe(this._iframeVaultID,"javascript:false;",1,1,null);this._iframeVault.SetAttribute("name",this._iframeVaultID);this.AddChild(this._iframeVault);this._iframeVault.Hide();this._divVault=$$P.div("divVault");this.AddChild(this._divVault);this._divVault.Hide();this._frmVault=$$P.frm("frmAdd");this._divVault.AddChild(this._frmVault);this._frmVault.SetAttribute("method","post");this._frmVault.SetAttribute("target",this._iframeVaultID);this._frmVault.SetAttribute("enctype","application/x-www-form-urlencoded");this._billing_cc_number=$$P.hdn("billing-cc-number");this._frmVault.AddChild(this._billing_cc_number);this._billing_cc_number.SetAttribute("name","billing-cc-number");this._billing_cc_exp=$$P.hdn("billing-cc-exp");this._frmVault.AddChild(this._billing_cc_exp);this._billing_cc_exp.SetAttribute("name","billing-cc-exp")},createEvents:function($super){$super();this.AddEnterPressListener();this._ftxtCardNumber.AddChangeListener();this._dtcExpiration.AddChangeListener();this._ftxtFirstName.AddChangeListener();this._ftxtLastName.AddChangeListener();if(this._requiresEmail){this._txtEmail.AddChangeListener()}this._iframeVault.AddLoadListener();this.SavedEvent=new cm.event();this.CancelEvent=new cm.event();this.ErrorEvent=new cm.event();this.PriorToNMIEvent=new cm.event()},wireEvents:function($super){$super();this._btnCancel.ClickEvent.subscribe(this.onCancel,this);this._btnSave.ClickEvent.subscribe(this.onSave,this);this.EnterPressEvent.subscribe(this.onSave,this);this._iframeVault.OnLoadEvent.subscribe(this.onIFrameLoaded,this)},postInitialize:function($super){this.SetValidation();this.toggleAcceptedCreditCards()},SetValidation:function(){this._ftxtFirstName.Validator.addEvaluator($$EVAL.TEXT({FieldName:"First Name",IsRequired:true,MinLength:1}),this._ftxtFirstName.ChangeEvent);this._ftxtFirstName.Validator.Enable();this._ftxtLastName.Validator.addEvaluator($$EVAL.TEXT({FieldName:"Last Name",IsRequired:true,MinLength:1}),this._ftxtLastName.ChangeEvent);this._ftxtLastName.Validator.Enable();if(this._requiresEmail){this._txtEmail.Validator.addEvaluator($$EVAL.TEXT({FieldName:"Email",IsRequired:true,MinLength:7}),this._txtEmail.ChangeEvent);this._txtEmail.Validator.Enable()}},SetTabIndex:function(a){this._ftxtCardNumber.SetTabIndex(a++);this._dtcExpiration._ddlMonth.SetTabIndex(a++);this._dtcExpiration._ddlYear.SetTabIndex(a++);this._ftxtFirstName.SetTabIndex(a++);this._ftxtLastName.SetTabIndex(a++);if(this._requiresEmail){this._txtEmail.SetTabIndex(a++)}this._fAddress.SetTabIndex(a++);this._btnSave.SetTabIndex(a+=5);this._btnCancel.SetTabIndex(++a)},setAcceptedCreditCardStrings:function(a){this._creditCardTypeArrayString="";this._creditCardTypesString=a.join();a.each(function(b){var c=this._enumCreditCardType.GetName(b);if(this._cardNameAbbreviations[c.toUpperCase()]){this._creditCardTypeArrayString+=this._cardNameAbbreviations[c.toUpperCase()]}else{this._creditCardTypeArrayString+=c.toUpperCase()}this._creditCardTypeArrayString+="/"},this);this._creditCardTypeArrayString=this._creditCardTypeArrayString.substr(0,this._creditCardTypeArrayString.length-1)},toggleAcceptedCreditCards:function(){this._ftxtCardNumber.GetFieldTipControl().UpdateInnerHtml(this._creditCardTypeArrayString+" NO SPACES, EX:4375009012859081")},onCancel:function(b,a){this.CancelEvent.fire(this)},onSave:function(c,a){if(this.IsValid(true)){var b=this.GetData();if(this._isExistingCard==true){this.modifyCreditCard(b)}else{this.addCreditCard(b)}}},getDomain:function(){return window.location.protocol+"//"+window.location.host},modifyCreditCard:function(a){$$CMD.ShowWaitDialog({message:"Saving data in PCI Compliant Manner.<br />Please wait..."});DAO.CreditCard.CreditCardModify({ObjectID:this._objectID,CreditCardCategoryID:this._creditCardCategoryID,CreditCardGatewayTypeID:this._creditCardGatewayTypeID,CreditCardGatewayCategoryID:this._creditCardGatewayCategoryID,CreditCard:a},{wait:false,scope:this,onSuccess:function(b){$$CMD.HideWaitDialog();var c=b.data;if(!$$CM.isNull(c)&&c.ID>0){$$GROWL.ShowBanner("Credit card successfully updated.",2000);this._isExistingCard=true;this._creditCard=c;this.SavedEvent.fire(this,{data:this._creditCard})}else{var d="There has been an error while updating credit card with NMI.";$$CMD.Alert({title:"Error",message:d});this.ErrorEvent.fire(this,{message:d})}},onFailure:function(b){$$CMD.HideWaitDialog();var c="There were issues processing your request.";$$CMD.Alert({title:"Error",message:c});this.ErrorEvent.fire(this,{message:c})}})},addCreditCard:function(a){$$CMD.ShowWaitDialog({message:"Saving data in PCI Compliant Manner.<br />Please wait..."});DAO.CreditCard.CreditCardAdd({ObjectID:this._objectID,CreditCardCategoryID:this._creditCardCategoryID,CreditCardGatewayTypeID:this._creditCardGatewayTypeID,CreditCardGatewayCategoryID:this._creditCardGatewayCategoryID,RedirectUrl:this.getDomain()+"/ui/merchant/creditcard/CreditCardVaultUPRComplete",CreditCard:a},{wait:false,scope:this,onSuccess:function(b){$$CMD.HideWaitDialog();var c=b.data;if(!$$CM.isNull(c)&&c.ID>0){$$CMD.ShowWaitDialog({message:"Communication with PCI Compliant Manner.<br />Please wait..."});this.PriorToNMIEvent.fire(this,c);this._creditCard=c;this.postToNMI(this._creditCard)}else{var d="There has been an error while creating new credit card with NMI.";$$CMD.Alert({title:"Error",message:d});this.ErrorEvent.fire(this,{message:d})}},onFailure:function(b){$$CMD.HideWaitDialog();var c="There were issues processing your request.";$$CMD.Alert({title:"Error",message:c});this.ErrorEvent.fire(this,{message:c})}})},postToNMI:function(b){this._frmVault.SetAttribute("action",b.FormUrl);var a=this._ftxtCardNumber.GetData();this._billing_cc_number.SetAttribute("value",a);var c=moment.utc(this._dtcExpiration.GetData(),"YYYY-MM-DD").format("MMYY");this._billing_cc_exp.SetAttribute("value",c);window.ccvScope=this;jQuery($$E(this._frmVault)).submit()},onIFrameLoaded:function(b,a){var c=b.GetHtmlElement();var d=c.contentWindow.document.URL.indexOf("token-id");if(d>0){var e=this;if(window.ccvScope){e=window.ccvScope}var f=c.contentWindow.document.URL.substr(d+9);e._creditCard.TokenID=f;e.completeCreditCard(e._creditCard)}},completeCreditCard:function(a){DAO.CreditCard.CreditCardComplete({ObjectID:this._objectID,CreditCardCategoryID:this._creditCardCategoryID,CreditCardGatewayTypeID:this._creditCardGatewayTypeID,CreditCardGatewayCategoryID:this._creditCardGatewayCategoryID,CreditCard:a},{wait:false,scope:this,onSuccess:function(b){$$CMD.HideWaitDialog();var c=b.data;if(!$$CM.isNull(c)&&c.ID>0){$$GROWL.ShowBanner("Credit card successfully "+((this._isExistingCard!=true)?"added.":"updated."),2000);this._isExistingCard=true;this._creditCard=c;this.SavedEvent.fire(this,{data:this._creditCard})}else{var d="There has been an error while completing/verifying new credit card with NMI.";$$CMD.Alert({title:"Error",message:d});this.ErrorEvent.fire(this,{message:d})}},onFailure:function(b){$$CMD.HideWaitDialog();var c="There were issues processing your request.";$$CMD.Alert({title:"Error",message:c});this.ErrorEvent.fire(this,{message:c})}})},isCreditCardExpired:function(a){var c=moment.utc();var b=moment.utc(a,"YYYY-MM-DD");if(c.year()>b.year()||(c.year()==b.year()&&c.month()>b.month())){return true}return false},IsExistingCard:function(){return this._isExistingCard},Validate:function(a){var b=this.Validator.validate();if(b.IsValid()){var c=new cm.validation.ValidationResult("",null);if(this.isCreditCardExpired(this._dtcExpiration.GetData())){c.AddError("Credit card is expired.");a=true}b.AppendResult(c)}if(a==true){this.Validator.ShowErrors(b)}return b},IsValid:function(a){var b=this.Validate(a);return b.IsValid()},ClearFields:function($super){this.Validator.Clear();this._creditCard=null;this._isExistingCard=false;this._ftxtCardNumber.Bind(null);this._ftxtCardNumber.Validator.Enable();this._ftxtCardNumber.SetEnabled(true);currentYear=new Date().getFullYear();this._dtcExpiration.Bind(null,currentYear,currentYear+10);this._ftxtFirstName.Bind(null);this._ftxtLastName.Bind(null);this._fAddress.Bind(null);this._ftxtCardNumber.Validator.Clear();this._ftxtFirstName.Validator.Clear();this._ftxtLastName.Validator.Clear()},onDataUpdated:function(){this.ClearFields();this._creditCard=this.GetBoundData();if(!$$CM.isNull(this._creditCard)){this._isExistingCard=false;if($$CM.isNull(this._creditCard.IsExistingCard)||this._creditCard.IsExistingCard==true){this._isExistingCard=true}if(!$$CM.isNull(this._creditCard.NumberLastFour)){this._ftxtCardNumber.Bind("************"+this._creditCard.NumberLastFour);this._ftxtCardNumber.Validator.Disable();this._ftxtCardNumber.SetEnabled(false)}currentYear=new Date().getFullYear();if(!$$CM.isEmpty(this._creditCard.ExpirationAsString)){this._dtcExpiration.Bind(this._creditCard.ExpirationAsString,currentYear,currentYear+10)}this._ftxtFirstName.Bind(this._creditCard.FirstName);this._ftxtLastName.Bind(this._creditCard.LastName);if(!$$CM.isNull(this._creditCard.Address)){this._fAddress.Bind(this._creditCard.Address)}}},GetData:function(){var b=this._creditCard;if($$CM.isNull(b)){b=new Object()}if($$CM.isNull(b.ID)){b.ID=-1}b.VaultID=(this._isExistingCard==true&&!$$CM.isNull(b.VaultID))?b.VaultID:-1;b.ObjectID=this._co.objectID;b.Number="";var c=this._dtcExpiration.GetData();b.ExpirationAsString=c.slice(0,c.indexOf("T"));b.FirstName=this._ftxtFirstName.GetData();b.LastName=this._ftxtLastName.GetData();b.Address=this._fAddress.GetData();if(!this._isExistingCard){b.IsDefault=true;b.VaultConfirmed=false;b.CreditCardCategory=this._co.creditCardCategoryID;b.CreditCardGatewayCategoryID=this._creditCardGatewayCategoryID;var d=this._ftxtCardNumber.GetData();b.NumberLastFour=d.substr(d.length-4,4);var a=$$CM.getCreditCardType(d);b.CreditCardType=this._enumCreditCardType.GetId(a)}if(this._requiresEmail){b.email=this._txtEmail.GetData()}return b}});"cm.ui.merchant.creditcard".namespace();cm.ui.merchant.creditcard.CreditCardVaultUPRComplete=Class.create(cm.ui.Controller,{initializeData:function(){$$CM.PopulateQueryString();this._tokenID=$$CM.QueryStringObject["token-id"]}});"cm.ui.merchant.creditcard".namespace();cm.ui.merchant.creditcard.CreditCardVaultUPRDialogConfigOptions=Class.create(cm.ui.dialog.ModalDialogConfigOptions,{dialogClass:"cmBaseDialog",showCloseButton:false,vaultConfigOptions:null});cm.ui.merchant.creditcard.CreditCardVaultUPRDialog=Class.create(cm.ui.dialog.ModalDialog,{PriorToNMIEvent:null,SavedEvent:null,CancelEvent:null,ErrorEvent:null,configureDefaultOptions:function(){return new cm.ui.merchant.creditcard.CreditCardVaultUPRDialogConfigOptions()},initializeData:function(){this._co=this.GetConfigOptions();if(!$$CM.isEmpty(this._co.uniqueID)){this._uniqueID=this._co.uniqueID}else{this._uniqueID=$$CM.uniqueID()}},initializeUIElements:function(){this._ctrCreditCardVault=new cm.ui.merchant.creditcard.CreditCardVaultUPR("ctrCreditCardVaultUPR_"+this._uniqueID,this._co.vaultConfigOptions);this.AddChild(this._ctrCreditCardVault)},createEvents:function($super){$super();this.SavedEvent=new cm.event();this.CancelEvent=new cm.event();this.ErrorEvent=new cm.event();this.PriorToNMIEvent=new cm.event()},wireEvents:function($super){$super();this._ctrCreditCardVault.PriorToNMIEvent.subscribe(this.onPriorToNMI,this);this._ctrCreditCardVault.SavedEvent.subscribe(this.onSaved,this);this._ctrCreditCardVault.CancelEvent.subscribe(this.onCancel,this);this._ctrCreditCardVault.ErrorEvent.subscribe(this.onError,this)},onSaved:function(b,a){if(this._ctrCreditCardVault.IsExistingCard()==true){this.SavedEvent.fire(this,a)}this.Hide()},onCancel:function(b,a){this.CancelEvent.fire(this,a);this.Hide()},onPriorToNMI:function(b,a){this.PriorToNMIEvent.fire(this,a)},onError:function(b,a){this.ErrorEvent.fire(this,a)},SetTabIndex:function(a){this._ctrCreditCardVault.SetTabIndex(a)},BindConfigOptions:function(a){this._ctrCreditCardVault.BindConfigOptions(a)},BindObjectID:function(a){this._ctrCreditCardVault.BindObjectID(a)},Bind:function(a){this._ctrCreditCardVault.Bind(a)},GetData:function(){this._ctrCreditCardVault.GetData(data)}});