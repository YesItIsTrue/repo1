"cm.ui.customforms".namespace();cm.ui.customforms.CustomFormConfigOptions=Class.create(cm.ConfigOptions,{layout:$$LAYOUT.FLOW(),formWidth:530,fieldStore:"CustomForms",async:false});cm.ui.customforms.CustomForm=Class.create(cm.ui.Control,{THREAD_DELAY:5,_extConstraintTable:null,_guidTable:null,_currentGuid:0,_currentForm:null,_hasExternalConditions:false,ObjectAddedEvent:null,ObjectRemovedEvent:null,AsyncProgressUpdateEvent:null,AsyncLoadCompleteEvent:null,initializeData:function(){this._guidTable=new cm.ui.Hashtable();this._extConstraintTable=new cm.ui.Hashtable();this._hasExternalConditions=false;this._currentGuid=0;FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("GuidTable",this._guidTable);FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("DataTable",new cm.ui.Hashtable());FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("OriginalDataTable",new cm.ui.Hashtable())},initializeUIElements:function(){this.AddClassName("cmCustomForm");this._canvas=new cm.ui.customforms.Canvas(this.ID()+"_canvas",{layout:this.GetConfigOptions().layout,width:this.GetConfigOptions().formWidth});this.AddChild(this._canvas)},initializeDAOs:function(){this._dao=new cm.dao.Framework.DAO();this._cfDAO=new cm.dao.CustomForms.DAO()},createEvents:function(){this.ObjectAddedEvent=new cm.event();this.ObjectRemovedEvent=new cm.event();this.AsyncProgressUpdateEvent=new cm.event();this.AsyncLoadCompleteEvent=new cm.event()},wireEvents:function(){this._canvas.ObjectAddedEvent.subscribe(this.onObjectAdded,this);this._canvas.ObjectRemovedEvent.subscribe(this.onObjectRemoved,this)},configureDefaultOptions:function(){return new cm.ui.customforms.CustomFormConfigOptions()},BindExternalData:function(a){if(!$$CM.isArray(a)){a=$A([a])}a.each(function(b){this._extConstraintTable.put(b.Key,b.Value)},this);this.UpdateConditions()},Bind:function(a){FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("DataTable",new cm.ui.Hashtable());FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("OriginalDataTable",new cm.ui.Hashtable());this._suppressConditions=true;var b=this.GetAllObjects();if($$CM.isArray(b)){b.each(function(c){c.Bind();FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("OriginalDataTable").put("L"+c.Guid,c.GetData())},this)}if($$CM.isArray(a)&&!$$CM.isNull(this._currentForm)){a.each(function(c){if(this._currentForm.IsCustomFieldForm==true){var e=FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("FieldTable").get("CF"+c.Key);var f=this._guidTable.get(e);if(!$$CM.isNull(f)){f.Bind(c.Value);FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("DataTable").put("L"+f.Guid,f.GetData());FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("OriginalDataTable").put("L"+f.Guid,f.GetData())}}else{var f=this._guidTable.get("L"+c.Key);if(!$$CM.isNull(f)){f.Bind(c.Value);FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("DataTable").put("L"+f.Guid,f.GetData());FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("OriginalDataTable").put("L"+f.Guid,f.GetData())}}},this)}this._suppressConditions=false;this.UpdateConditions()},GetData:function(){var a=$A($$JQ(this._canvas).find(".cmFrameworkObject"));return this.GetDataFromGrid(a)},GetAllData:function(a,b){return this.parseData(this._canvas.GetObjects(),true)},GetDataFromGrid:function(b){var a=$A();var d=FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("DataTable");d.keys.each(function(g){var h=FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("GuidTable").get(g);if(h.GetApplicableState()==true){var e=h.GetData();if($$CM.isArray(e)&&e.length==0){e=null}if($$CM.isEmpty(e)){e=null}var f=(h.GetConfig(CFG_CUSTOM_FIELD_ID)>0)?h.GetConfig(CFG_CUSTOM_FIELD_ID):h.Guid;a.push({Key:f,Value:e,Label:h.GetName(),Position:b.indexOf($$E(h))})}},this);var c=FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("GuidTable");if(!$$CM.isNull(c)&&$$CM.isArray(c.keys)&&c.keys.length>0){c.keys.each(function(h){var i=c.get(h);var f=(i.GetConfig(CFG_CUSTOM_FIELD_ID)>0)?i.GetConfig(CFG_CUSTOM_FIELD_ID):i.Guid;var g=a.find(function(j){return j.Key==f},this);if($$CM.isNull(g)){if(i.GetApplicableState()==true){var e=i.GetData();if($$CM.isArray(e)&&e.length==0){e=null}if($$CM.isEmpty(e)){e=null}if(!$$CM.isNull(e)){a.push({Key:f,Value:e,Label:i.GetName(),Position:b.indexOf($$E(i))})}}}},this)}a.sort(function(e,f){return e.Position-f.Position});return a},GetApplicableTable:function(){return this.GetAllObjects().collect(function(a){return{Key:a.Guid,Value:a.GetApplicableState()}},this)},SetCanvasWidth:function(a){this._canvas.SetWidth(a)},parseData:function(b,c){var a=$A();b.each(function(f){var d=f.GetData();var e=f.GetConfig(CFG_CUSTOM_FIELD_ID);if(!$$CM.isNull(d)&&!$$CM.isEmpty(d)&&(!$$CM.isArray(d)||($$CM.isArray(d)&&d.length>0))&&f.IsVisible()==true&&f.IsApplicable==true){if(!$$CM.isNull(e)&&e>0&&this._currentForm.IsCustomFieldForm==true){a.push({Key:e,Value:d,Label:f.GetName()})}else{a.push({Key:f.Guid,Value:d,Label:f.GetName()})}}else{if(c==true&&($$CM.isNull(d)||$$CM.isEmpty(d))){if(!$$CM.isNull(e)&&e>0&&this._currentForm.IsCustomFieldForm==true){a.push({Key:e,Value:null,Label:f.GetName()})}}}if(f.IsApplicable==true&&f.Children.length>0){a=a.concat(this.parseData(f.Children,c))}},this);return a},IsApplicable:function(){return !$$CM.isNull(this._canvas.GetObjects().find(function(a){return a.IsApplicable==true}))},GetForm:function(){return this._currentFormData},SetForm:function(a){if($$CM.isNull(a)||a==this.GetForm()){return}this._currentFormData=$$CM.deepClone(a);this._currentForm=this._currentFormData.Form;var b=this._currentFormData.Form.LayoutParameters;if($$CM.isNull(b)){b=""}this._canvas.GetLayout().SetParameters(b);this.SetContent(this._currentFormData.Content)},SetLayout:function(a){this._canvas.SetLayout(a)},SetContent:function(a){this._guidTable=new cm.ui.Hashtable();FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("GuidTable",this._guidTable);FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("DataTable",new cm.ui.Hashtable());FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("FieldTable",new cm.ui.Hashtable());FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("ConditionTable",$A());this._canvas.Clear();if(this.GetConfigOptions().async==true){this._canvas.Hide();$$CMD.ShowWaitDialog({showProgress:true});this._thLoader=new cm.EnumerationThread("cfLoader",this,this.THREAD_DELAY);this._thLoader.ThreadFinished.subscribe(this.onAsyncLoadFinished,this);this._thLoader.ProgressUpdated.subscribe(this.onAsyncProgressUpdate,this);this._thLoader.Start(this.parseTreeAsync,this,a,this.getContentCount(a),this._canvas)}else{this.parseTree(this._canvas,a);this.onContentLoaded()}},getContentCount:function(b){var a=b.length;b.each(function(c){if(c.Children.length>0){a+=this.getContentCount(c.Children)}},this);return a},DeregisterObject:function(a){FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("ConditionTable",{Guid:"L"+a.Guid}).each(function(b){var f=this._guidTable.get(b.Source);var d=f.Conditions.findAll(function(c){return c.Guid==b.Guid});for(var e=0;e<d.length;e++){f.Conditions.remove(d[e])}f.Reload()},this);FW.Data.GetStore(this.GetConfigOptions().fieldStore).Remove("ConditionTable",{Guid:"L"+a.Guid});FW.Data.GetStore(this.GetConfigOptions().fieldStore).Remove("ConditionTable",{Source:"L"+a.Guid});this._guidTable.remove("L"+a.Guid);a.Children.each(function(b){this.DeregisterObject(b)},this)},RegisterObject:function(a){if($$CM.isNull(a.Guid)){this._currentGuid++;a.Guid=this._currentGuid}this._guidTable.put("L"+a.Guid,a);if(a.GetConfig(CFG_CUSTOM_FIELD_ID)>0){FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("FieldTable").put("CF"+a.GetConfig(CFG_CUSTOM_FIELD_ID),"L"+a.Guid)}this.updateConditionTable(a)},IsValidConstraint:function(c){if(c.startsWith("L")){var d=this._guidTable.get(c);return !$$CM.isNull(d)&&d.IsValidConditional()}else{if(c.startsWith("F")){var b=c.split(":")[0].substr(1);var a=FW.Data.GetStore(this.GetConfigOptions().fieldStore).GetFirst("ExtConstraints",{FormID:b});return(!$$CM.isNull(a))}else{if(c.startsWith("G")){var a=FW.Data.GetStore(this.GetConfigOptions().fieldStore).GetFirst("ExtConstraints",{FormID:0});return(!$$CM.isNull(a))}}}return false},GetConstraint:function(e){if(e.startsWith("L")){var g=this._guidTable.get(e);if(!$$CM.isNull(g)&&g.IsValid()){var f=g.GetConfig(CFG_LIST);if(!$$CM.isNull(f)){return{Datasource:f}}}}else{if(e.startsWith("F")){var d=e.split(":")[0].substr(1);var b=FW.Data.GetStore(this.GetConfigOptions().fieldStore).GetFirst("ExtConstraints",{FormID:d});if(!$$CM.isNull(b)){var a=b.ConstraintsArray.find(function(c){return c.ID==e.split(":")[1]});return a}}else{if(e.startsWith("G")){var b=FW.Data.GetStore(this.GetConfigOptions().fieldStore).GetFirst("ExtConstraints",{FormID:0});if(!$$CM.isNull(b)){var a=b.ConstraintsArray.find(function(c){return c.ID==e.split(":")[1]});return a}}}}return{Datasource:$A()}},GetConstraintValue:function(a){if(a.startsWith("L")){var b=this._guidTable.get(a);if(!$$CM.isNull(b)&&b.IsValid()==true&&b.IsApplicable==true){return b.GetData()}else{return null}}else{if(a.startsWith("F")||a.startsWith("G")){return this._extConstraintTable.get(a)}else{return null}}},GetAllObjects:function(){var a=$A();this._guidTable.keys.select(function(b){return b.startsWith("L")}).each(function(b){a.push(this._guidTable.get(b))},this);return a},UpdateConditions:function(){FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("ConditionTable").each(function(a){this.doConditionCheck(this._guidTable.get(a.Source))},this)},UpdateAllConditions:function(){this.doConditionCheck(this._canvas.GetAllObjects())},updateEvaluator:function(target){var override=target.GetConfig(CFG_OVERRIDE_EVALUATOR);if(override!=true){target.Validator.RemoveAll();var evalID=target.GetConfig(CFG_EVALUATOR);var isRequired=target.GetConfig(CFG_EVALUATOR_IS_REQUIRED);if(evalID>=6){isRequired=true}if(evalID>0){var eval=$$EVAL[FW.Enums.Evaluator.GetName(evalID).toUpperCase()]({IsRequired:isRequired});target.Validator.addEvaluator(eval)}}},updateChange:function(a){if($$CM.isNull(a.ChangeEvent)){a.AddChangeListener()}a.ChangeEvent.subscribe(this.onObjectValueChanged,this)},parseTreeAsync:function(b,a){var c=new cm.ui.customforms.CustomFormObject(FW.Object.Render(b.ClassID,b.ConfigOptions));c.Guid=b.Guid;c.Layout=b.Layout;c.Conditions=b.Conditions;this.doParse(c);if(a instanceof cm.ui.customforms.Canvas){a.AddObject(c)}else{a.AddChildObject(c)}if(b.Children.length>0){var d=new cm.EnumerationThread("cfLoader",this,this.THREAD_DELAY);d.Start(this.parseTreeAsync,this,b.Children,null,c)}},parseTree:function(a,b){if($$CM.isArray(b)){var b=b.sortBy(function(c){return c.Layout?c.Layout.Y:0});b.each(function(c){var d=new cm.ui.customforms.CustomFormObject(Framework.Object.Render(c.ClassID,c.ConfigOptions));d.Guid=c.Guid;d.Layout=c.Layout;d.Conditions=c.Conditions;this.doParse(d);if(a instanceof cm.ui.customforms.Canvas){a.AddObject(d)}else{a.AddChildObject(d)}this.parseTree(d,c.Children)},this)}},doParse:function(a){},doConditionCheck:function(a){a=$$CM.toArray(a);a.each(function(b){b.IsApplicable=true;if($$CM.isArray(b.Conditions)){var c=new cm.ui.Hashtable();b.Conditions.each(function(e){var j=this.GetConstraintValue(e.Guid);var f=e.Value;try{f=JSON.parse(f)}catch(g){}try{j=JSON.parse(j)}catch(g){}var d=new cm.ui.customforms.Comparer(j,cm.ui.customforms.comparer[FW.Enums.Comparer.GetName(e.Comparer)]);var i=d.Execute(f);var h=c.get(e.Action);if($$CM.isNull(h)){h=true}c.put(e.Action,h&i)},this);c.keys.each(function(e){var d=new cm.ui.customforms.Action(b,cm.ui.customforms.action[FW.Enums.Action.GetName(e)]);d.Execute(c.get(e));this.onActionExecuted(b,e)},this)}},this);this._canvas.GetLayout().Update()},onAsyncProgressUpdate:function(b,a){$$CMD.SetProgressWaitDialog("Loading "+a.Iteration+" / "+a.Total+" fields... ["+a.PercentComplete+"%]",a.PercentComplete)},onAsyncLoadFinished:function(b,a){this.onContentLoaded();$$CMD.HideWaitDialog();this._canvas.Show(true,250,"fade");this.AsyncLoadCompleteEvent.fire()},onContentLoaded:function(){this._currentGuid=this.GetAllObjects().max(function(a){return a.Guid});if($$CM.isNull(this._currentGuid)){this._currentGuid=0}FW.Data.GetStore(this.GetConfigOptions().fieldStore).Replace("GuidTable",this._guidTable);this.UpdateAllConditions()},onObjectAdded:function(c,a){var b=a;if($$CM.isNull(b.Conditions)){b.Conditions=$A()}if(b.IsValid()!=true){c.Hide()}this.RegisterObject(b);this.checkCustomField(b);this.updateEvaluator(b);this.updateChange(b);b.onAttached();this.updateDefaultValue(b);this.ObjectAddedEvent.fire(this,b)},onObjectRemoved:function(c,a){var b=a;this.DeregisterObject(b);this.ObjectRemovedEvent.fire(this,b)},onObjectBeforeReload:function(b,a){this._preserveReloadData=this.getDataTree(b)},onObjectAfterReload:function(b,a){b.Show();b.RemoveClassName("cmActionPass");b.RemoveClassName("cmActionHidden");this._suppressConditions=true;this._preserveReloadData.each(function(c){var e=this._guidTable.get(c.Guid);if(!$$CM.isNull(e)){e.Bind(c.Data)}},this);this._suppressConditions=false;delete this._preserveReloadData;this.updateEvaluator(b);this.updateChange(b);this.updateConditionTable(b);this.updateDefaultValue(b);this.doConditionCheck(b.ToArray())},getDataTree:function(b){var a=$A();a.push({Guid:"L"+b.Guid,Data:b.GetData()});b.Children.each(function(c){a=a.concat(this.getDataTree(c))},this);return a},updateConditionTable:function(a){FW.Data.GetStore(this.GetConfigOptions().fieldStore).Remove("ConditionTable",{Source:"L"+a.Guid});a.Conditions.each(function(b){FW.Data.GetStore(this.GetConfigOptions().fieldStore).Concat("ConditionTable",{Source:"L"+a.Guid,Guid:b.Guid})},this)},updateDefaultValue:function(c){if(($$CM.isNull(c.GetData())||$$CM.isEmpty(c.GetData())||($$CM.isArray(c.GetData())&&c.GetData().length==0))&&c.GetConfig(CFG_CUSTOM_FIELD_ID)>0){var b=FW.Data.CustomForms.GetFirst("CustomFieldDefinitions",{FieldID:c.GetConfig(CFG_CUSTOM_FIELD_ID)});if(!$$CM.isNull(b)){var a=b.ExtendedProperties.find(function(d){return d.Key=="defaultValue"});if(!$$CM.isNull(a)){c.Bind(a.Value)}}}},checkCustomField:function(c){if(c.GetConfig(CFG_CUSTOM_FIELD_ID)>0){var b=FW.Data.CustomForms.GetFirst("CustomFieldDefinitions",{FieldID:c.GetConfig(CFG_CUSTOM_FIELD_ID)});if($$CM.isNull(b)){c.Hide();return}var a=this.GetAllObjects().find(function(d){return d.GetConfig(CFG_CUSTOM_FIELD_ID)==c.GetConfig(CFG_CUSTOM_FIELD_ID)&&d!=c});if(!$$CM.isNull(a)){c.Hide()}}},onObjectValueChanged:function(d,a){if(this._suppressConditions!=true){var c=FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("OriginalDataTable").get("L"+d.Guid);if(c!=d.GetData()){FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("DataTable").put("L"+d.Guid,d.GetData())}else{FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("DataTable").remove("L"+d.Guid)}var b=this.getCascadingConditionCheckList("L"+d.Guid);this.doConditionCheck(b.collect(function(f){return this._guidTable.get(f.Source)},this))}},getCascadingConditionCheckList:function(b){var a=FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("ConditionTable",{Guid:b});FW.Data.GetStore(this.GetConfigOptions().fieldStore).Get("ConditionTable",{Guid:b}).each(function(c){a=a.concat(this.getCascadingConditionCheckList(c.Source))},this);return a},onActionExecuted:function(a){}});cm.ui.customforms.CustomFormEditorConfigOptions=Class.create(cm.ui.customforms.CustomFormConfigOptions,{pageLimit:null});"cm.ui.customforms".namespace();cm.ui.customforms.CustomFormEditor=Class.create(cm.ui.customforms.CustomForm,{REGEX_MATCH_HTMLTAGS:/<\/?\w+((\s+\w+(\s*=\s*(?:\".*?\"|'.*?'|[^'\">\s]+))?)+\s*|\s*)\/?>/gi,_selection:null,_editMode:null,SelectionChangedEvent:null,FormSavedEvent:null,FormCancelledEvent:null,configureDefaultOptions:function(){return new cm.ui.customforms.CustomFormEditorConfigOptions()},initializeData:function($super){$super();this._selection=null;this._editMode=false;this._co=this.GetConfigOptions();this._pageLimit=this._co.pageLimit},initializeUIElements:function(){if(!$$CM.isNull(this.GetConfigOptions().width)){this.AssignStyle("width",this.GetConfigOptions().width+"px")}this.AddClassName("cmCustomForm cmCustomFormEditor");this._divCenter=$$P.div();this.AddChild(this._divCenter);this._toolbar=new cm.ui.customforms.CustomFormToolbar(this.ID()+"_toolbar");this._divCenter.AddChild(this._toolbar);this._viewMain=$$P.div("viewMain",null,{classNames:"cmCustomFormViewMain"});this._divCenter.AddChild(this._viewMain);this._viewCanvas=$$P.div("viewCanvas",null,{classNames:"cmCustomFormViewCanvas"});this._viewMain.AddChild(this._viewCanvas);this._canvas=new cm.ui.customforms.Canvas(this.ID()+"_canvas",{layout:this.GetConfigOptions().layout,width:this.GetConfigOptions().formWidth});this._canvas.AddClassName("cmCustomForm cmMaster cmEditCanvas m5px");this._viewCanvas.AddChild(this._canvas);this._cfgEdit=new cm.ui.customforms.ConfigEditor("cfConfigEditor");this._cfgEdit.Hide();this._viewMain.AddChild(this._cfgEdit);this._disabler=$$P.div(null,null,{classNames:"cmDisabler"});this._disabler.Hide();this._viewMain.AddChild(this._disabler)},createEvents:function($super){$super();this.SelectionChangedEvent=new cm.event();this.FormSavedEvent=new cm.event();this.FormCanceledEvent=new cm.event()},wireEvents:function(){this._toolbar.ToolAddedEvent.subscribe(this.onToolAdded,this);this._canvas.LayoutInitializedEvent.subscribe(this.onLayoutInitialized,this);this._canvas.ObjectAddedEvent.subscribe(this.onObjectAdded,this);this._canvas.ObjectBeforeRemovedEvent.subscribe(this.onObjectBeforeRemoved,this);this._canvas.SectorHoverEvent.subscribe(this.onSectorHover,this);this._canvas.SectorExitEvent.subscribe(this.onSectorExit,this);this._cfgEdit.ClosedEvent.subscribe(this.onConfigEditorClosed,this);DAO.CustomForms.CustomFormModify.SuccessEvent.subscribe(this.onCustomFormModified,this);DAO.CustomForms.CustomFormModify.FailureEvent.subscribe(this.onCustomFormFailure,this);FW.Data.CustomForms.Subscribe("CustomFieldDefinitions",this.onCustomFieldDefinitionsModified,this)},postInitialize:function(){this._canvas.SetLayout(this.GetConfigOptions().layout)},SetContent:function($super,a){FW.Data.CustomForms.Replace("ConflictTable",new cm.ui.Hashtable());this._suppressUpdates=true;$super(a);this._suppressUpdates=false;this.updateLayouts(this._canvas)},GetContent:function(){var a=this.createTree(this._canvas.GetObjects());return a},SetForm:function($super,a){if(!$$CM.isNull(a)){$super(a);var b=FW.Data.CustomForms.Get("Sections",{Context:this._currentForm.Context,SectionID:this._currentForm.ContextSection}).each(function(c){FW.Data.CustomForms.Replace("CurrentSection",$A([c]));FW.Data.CustomForms.Replace("CurrentFieldTypes",$A([a.Form.FieldTypes]));this.cacheFieldData()},this)}},SetEnabled:function(a){if(a==true){this._disabler.Hide(true,250,"fade")}else{this.setSplashVisible(true);this._disabler.Show(true,250,"fade");this._btnExternalData.Hide(true,250,"fade")}},createTree:function(b){var a=$A();b.each(function(c){a.push({Guid:c.Guid,Conditions:c.Conditions,Children:this.createTree(c.Children),Layout:c.Layout,ClassID:c.ClassID,ConfigOptions:this.stringifyConfigOptions(c.ClassID,c.GetConfigOptionData())})},this);return a},stringifyConfigOptions:function(b,d){var c=FW.Object.GetClass(b);var a=$A();d.each(function(e){var f=c.ConfigOptions.find(function(g){return g.ID==e.ID});if(!$$CM.isNull(f)){a.push({ID:e.ID,Value:$$CM.stringify(e.Value)})}},this);return a},cacheFieldData:function(){var c=FW.Data.CustomForms.GetFirst("CurrentFieldTypes");var a=FW.Data.CustomForms.GetFirst("CurrentSection");if(!$$CM.isNull(a)){c=(c>0)?c:FW.Data.CustomForms.GetFirst("CurrentSection").FieldTypes}var e=FW.Enums.ObjectTypeFlag;var d=e.GetArray().findAll(function(f){return f.ID>0&&e.TestFlag(c,f.ID)},this);var b=$A();d.each(function(f){var g={Flag:f.ID,Name:f.Name};var k=$$P.optgrp(null,f.Name);var i=$$P.optgrp(null,f.Name);var j=$$P.optgrp(null,f.Name);var h=FW.Data.Get("CustomFieldDefinitions","CustomForms",function(l){return e.TestFlag(l.ObjectType,f.ID)}).sort(this.sortCustomFieldDataset);h.each(function(l){if(l.Options.length<=0&&l.IsArray==false){k.AddChild($$P.opt(l.Name,l.FieldID))}else{if(l.Options.length>0&&l.IsArray==false){i.AddChild($$P.opt(l.Name,l.FieldID))}else{if(l.Options.length>0&&l.IsArray==true){j.AddChild($$P.opt(l.Name,l.FieldID))}}}});g.NoOptions=k;g.Options=i;g.Multiselect=j;b.push(g)},this);FW.Data.GetStore("CustomFieldCache").SetSilent("CustomFieldDatasources",b)},sortCustomFieldDataset:function(c,d){if(c.Name.toLowerCase()>d.Name.toLowerCase()){return 1}else{if(d.Name.toLowerCase()>c.Name.toLowerCase()){return -1}else{return 0}}},Cancel:function(){this.FormCanceledEvent.fire(this)},Save:function(d){this._silentSave=d;try{if(jQuery("div").find(".cmInvalidCustomField").length>0){throw"Invalid custom field exists on form"}this._currentForm.ExtConstraintArray=this.GetConstraintsArray();this._currentForm.LayoutParameters=this._canvas.GetLayout().GetParameters();var b={Content:this.GetContent(),Form:this._currentForm};this._currentFormData=b;if(!!this._pageLimit&&$$CM.isNumber(this._pageLimit)&&b.Content.findAll(function(e){return e.Layout.X>=this._pageLimit},this).length>0){throw"This form is limited to "+this._pageLimit+" page"+((this._pageLimit>1)?"s":"")+"."}else{var c=$$CM.stringify(b.Content);if(c.indexOf(">")>=0&&c.indexOf("<")>=0){throw"One or more fields contain restricted HTML tags."}else{DAO.CustomForms.CustomFormModify({Form:b},{silent:d})}}}catch(a){$$CMD.Alert({title:"Error saving custom form",message:a})}},SetToolkit:function(a){this._toolbar.Bind(a)},Clear:function(){this._canvas.Clear()},Select:function(a){if($$CM.isObject(a)){this.onObjectSelect(a)}else{var b=FW.Data.CustomForms.Get("GuidTable").get(a);if(!$$CM.isNull(b)){this.onObjectSelect(b)}}},GetConstraintsArray:function(){var a=$A();var b=$A();this.GetAllObjects().each(function(e){var c=e.GetConfig(CFG_CUSTOM_FIELD_ID);var d=FW.Data.CustomForms.GetFirst("CustomFieldDefinitions",{FieldID:c});a.push({ID:"L"+e.Guid,Name:e.GetName(),Label:e.GetConfig(CFG_LABEL),CustomFieldID:(c>0)?c:null,Datasource:(c>0)?null:e.GetConfig(CFG_LIST),IsMulti:($$CM.isNull(d))?e.GetConfig(CFG_IS_MULTISELECT_FIELD):d.IsArray,Context:this._currentForm.Context});if(c>0){if($$CM.isNull(d)){throw"Custom Field object '"+e.GetName()+"' references an invalid custom field ID"}else{if(b.indexOf(c)>=0){throw"Custom Field "+d.Name+" is already in use by another form object"}}b.push(c)}},this);return a},updateLayouts:function(a){var b=a.GetLayout();if(this._suppressUpdates!=true){b.Update()}b.GetSectors().each(function(c){c.ChildControls().each(function(d){if($$CM.isFunction(d.GetLayout)){this.updateLayouts(d)}},this)},this)},attachDragHandle:function(f){if($$CM.isNull(f.dragHandle)){var d=$$P.div(null,null,{classNames:"dragHandle"});d.SetAttribute("title","Drag this handle to move this object freely");d.Hide();f.dragHandle=d;f.AddChild(d);$$MIXIN.Draggable(f,{revert:true,revertDuration:0,handle:$$E(d)});f.Draggable.Bind(f)}if($$CM.isNull(f.actionTag)){var a=$$P.span(null,null,{classNames:"actionTag"});a.Hide();f.actionTag=a;f.AddChild(a)}if($$CM.isNull(f.functionBar)){var e=$$P.div(null,null,{classNames:"cmFunctionBar"});e.Hide();var b=new $$BTN(null,{classNames:"delete"});b.Object=f;b.SetAttribute("title","Delete");b.ClickEvent.subscribe(this.onFunctionDeleteClicked,this);var c=new $$BTN(null,{classNames:"duplicate"});c.Object=f;c.SetAttribute("title","Duplicate");c.ClickEvent.subscribe(this.onFunctionDuplicateClicked,this);e.AddChild(b);e.AddChild(c);f.functionBar=e;f.AddChild(e)}},onLayoutInitialized:function(b,a){this._overlay=$$P.div("cfOverlay");this._overlay.Hide();this.AddChild(this._overlay)},onToolAdded:function(c,a){var d=c;var b=a;$$MIXIN.Draggable(d,{helper:"clone"});d.Draggable.Bind(b);d.Draggable.DragStartEvent.subscribe(this.onToolStartDrag,this);d.Draggable.DragStopEvent.subscribe(this.onToolStopDrag,this);d.SetEnabled(false)},onToolStartDrag:function(d,a){var e=d;var b=e.Draggable.GetData();var c=new cm.ui.customforms.CustomFormObject(Framework.Object.Render(b.ClassID,b.RenderConfigOptions));e._itemData=b;e.Draggable.Bind(c)},onToolStopDrag:function(b,a){var c=b;c.Draggable.Bind(c._itemData);delete c._itemData;jQuery(".cmHoverTarget").removeClass("cmHoverTarget")},onObjectAdded:function($super,c,a){var b=a;this.attachDragHandle(b);$super(c,a);b.AddMouseOverListener();b.MouseOverEvent.subscribe(this.onObjectSelect,this);if(b.IsValid()!=true){b.AddClassName("cmInvalidObject");b.Show();b.actionTag.UpdateInnerHtml("Invalid Object!");b.actionTag.Show();b.actionTag.SetAttribute("title","Object class ID is invalid and will not appear on the custom form");b.functionBar.ChildControls()[1].Hide()}else{this.checkObject(b);b.AddDblClickListener();b.BeforeReloadEvent.subscribe(this.onObjectBeforeReload,this);b.AfterReloadEvent.subscribe(this.onObjectAfterReload,this);b.DblClickEvent.subscribe(this.onConfigEditorOpened,this)}},onObjectBeforeRemoved:function(c,a){var b=a;this.DeregisterObject(b)},onObjectSelect:function(b,a){if(this._editMode!=true){if(!$$CM.isNull(this._selection)){this._selection.dragHandle.Hide();this._selection.functionBar.Hide();this._selection.RemoveClassName("cmSelected")}if(jQuery(".cmSorting").length<=0){this._selection=b;this._selection.AddClassName("cmSelected");this._selection.dragHandle.Show();this._selection.functionBar.Show()}}this.SelectionChangedEvent.fire(this,this._selection);if(!$$CM.isNull(a)){a.event.stop()}},onObjectAfterReload:function($super,b,a){b.dragHandle=null;b.actionTag=null;b.functionBar=null;this.attachDragHandle(b);$super(b,a);this.checkObject(b)},doParse:function(b){if(!$$CM.isNull(FW.Data.CustomForms.Get("GuidTable").get("L"+b.Guid))){var a=FW.Data.CustomForms.Get("ConflictTable").get("L"+b.Guid);if(!$$CM.isArray(a)){a=$A()}a.push(b);FW.Data.CustomForms.Get("ConflictTable").put("L"+b.Guid,a)}},onContentLoaded:function($super){$super();var a=FW.Data.CustomForms.Get("ConflictTable");a.keys.each(function(b){a.get(b).each(function(c){this.DeregisterObject(c);c.Guid=++this._currentGuid;this.RegisterObject(c);c.Reload()},this)},this);FW.Data.CustomForms.Get("ConditionTable").each(function(b){this.checkObject(this._guidTable.get(b.Source))},this)},checkObject:function(f){f.RemoveClassName("cmInvalidCustomField");var g=$$CM.stringify(f.ConfigOptions);if(g.indexOf(">")>=0&&g.indexOf("<")>=0){f.AddClassName("cmInvalidCustomField htmlError");f.Show();f.actionTag.Show();f.actionTag.UpdateInnerHtml("Contains Restricted HTML Tags");f.actionTag.SetAttribute("title","This object contains unallowed HTML tags in it's configuration");return}if(f.Conditions.length>0){for(var e=0;e<f.Conditions.length;e++){var a=f.Conditions[e];var h=this.IsValidConstraint(a.Guid);if(h!=true||$$CM.isEmpty(a.Value)||$$CM.isEmpty(a.Guid)||$$CM.isEmpty(a.Comparer)||$$CM.isEmpty(a.Action)){f.AddClassName("cmInvalidCustomField htmlError");f.Show();f.actionTag.Show();f.actionTag.UpdateInnerHtml("Invalid Conditions");f.actionTag.SetAttribute("title","This object has a broken conditional reference");return}}}if(f.IsTypeOf(CLS_CUSTOMFIELD)&&!$$CM.isNull(f.GetConfig(CFG_CUSTOM_FIELD_ID))){var d=FW.Data.CustomForms.GetFirst("CustomFieldDefinitions",{FieldID:f.GetConfig(CFG_CUSTOM_FIELD_ID)});if($$CM.isNull(d)){f.AddClassName("cmInvalidCustomField");f.Show();f.actionTag.Show();f.actionTag.UpdateInnerHtml("Invalid Field ID!");f.actionTag.SetAttribute("title","This object is referencing an invalid custom field, and will not appear on the custom form");return}var b=this.GetAllObjects().find(function(c){return c.GetConfig(CFG_CUSTOM_FIELD_ID)==f.GetConfig(CFG_CUSTOM_FIELD_ID)&&c!=f});if(!$$CM.isNull(b)){f.AddClassName("cmInvalidCustomField");f.Show();f.actionTag.Show();f.actionTag.UpdateInnerHtml("Duplicate Field ID!");f.actionTag.SetAttribute("title","This object is referencing a custom field that is in use by another object")}}},onSectorHover:function(b,a){jQuery(".cmHoverTarget").removeClass("cmHoverTarget");b.AddClassName("cmHoverTarget")},onSectorExit:function(b,a){jQuery(".cmHoverTarget").removeClass("cmHoverTarget")},onConfigEditorOpened:function(c,a){if(!$$CM.isNull(this._selection)&&this._selection.IsValid()==true&&this._editMode!=true){this._editMode=true;this._canvas.SetEnabled(false);this._selection.AddClassName("cmHighlight");this._selection.Draggable.Disabled.Set(true);this._selection.functionBar.Hide();this._toolbar.SetEnabled(false);this._overlay.Show(true,250,"fade");this._cfgEdit.Bind(this._selection,this);this._cfgEdit.Show(true,150,"slide",{direction:"down"});var b=this;setTimeout(function(){b._cfgEdit.Focus()},150)}a.event.stop()},onConfigEditorClosed:function(b,a){this._editMode=false;this._canvas.SetEnabled(true);this._selection.RemoveClassName("cmHighlight");this._selection.Draggable.Disabled.Set(false);this._selection.functionBar.Show();this._toolbar.SetEnabled(true);this._overlay.Hide(true,250,"fade");this._cfgEdit.Hide(true,150,"slide",{direction:"down"})},onCustomFormModified:function(c,a){var b=a;this._currentForm=a.Form;$$GROWL.ShowBanner("Custom Form Saved!");if(this._silentSave!=true){this.FormSavedEvent.fire(this,b)}delete this._silentSave},onCustomFormFailure:function(c,a){var b=0;$$CMD.HideWaitDialog()},onActionExecuted:function(c,b){var a=b;if(c.HasClassName("cmActionPass")){c.actionTag.AddClassName("cmAction"+FW.Enums.Action.GetName(a));c.actionTag.UpdateInnerHtml(FW.Enums.Action.GetName(a));c.actionTag.Show()}else{c.actionTag.RemoveClassName("cmAction"+FW.Enums.Action.GetName(a));c.actionTag.UpdateInnerHtml("");c.actionTag.Hide()}},onFunctionDeleteClicked:function(b,a){$$CMD.Confirm({title:"Delete Field",message:"This action is not reversible and all fields contained in this one will also be removed.  Continue deleting this field?",handlerOk:this.onFunctionDeleteOk,scope:this})},onFunctionDeleteOk:function(c,a){var b=this.getObjectCanvas(this._selection);b.RemoveObject(this._selection)},onFunctionDuplicateClicked:function(c,a){var b=this._selection;this.doDuplicate(b,this.getObjectCanvas(b))},onCustomFieldDefinitionsModified:function(b,a){this.cacheFieldData()},doConditionCheck:function($super,a){if(!$$CM.isArray(a)){a=$A([a])}$super(a);a.each(function(b){this.checkObject(b)},this)},doDuplicate:function(c,a){var b=c.Duplicate();b._master=c._master;c.functionBar.Show();a.AddObject(b);this.UpdateConditions()},getObjectCanvas:function(a){var b=a.Parent;while(!$$CM.isFunction(b.AddObject)){b=b.Parent}return b}});"cm.ui.customforms".namespace();cm.ui.customforms.Toolbar=Class.create(cm.ui.Control,{_tools:null,ToolAddedEvent:null,createEvents:function(){this.ToolAddedEvent=new cm.event()},initializeData:function(){this._tools=$A()},Bind:function(a){this.DestroyChildControls();this._tools=$A();if(!$$CM.isNull(a)){a.ToolList.each(function(b){var c=this.renderTool(b);this.AddChild(c);this.onToolAdded(c,b);this._tools.push(c)},this)}},SetEnabled:function(a){this._tools.each(function(b){b.Draggable.Disabled.Set(!a)},this)},renderTool:function(a){return $$P.div()},onToolAdded:function(b,a){this.ToolAddedEvent.fire(b,a)}});cm.ui.customforms.AdvancedCustomFormEditorConfigOptions=Class.create(cm.ui.customforms.CustomFormEditorConfigOptions,{pageLimit:null});"cm.ui.customforms".namespace();cm.ui.customforms.AdvancedCustomFormEditor=Class.create(cm.ui.customforms.CustomFormEditor,{NL_COL_REVERT:{Key:"Revert",Name:"Undo",ClassNames:"w30px"},NL_COL_GUID:{Key:"Guid",Name:"Guid",ClassNames:"w60px"},NL_COL_LABEL:{Key:"Label",Name:"Label",ClassNames:"w160px"},NL_COL_NAME:{Key:"Name",Name:"Name",ClassNames:"w130px"},NL_COL_NAMEDEL:{Key:"DeleteName",Name:"",ClassNames:"w30px"},_selection:null,_editMode:null,SelectionChangedEvent:null,configureDefaultOptions:function(){return new cm.ui.customforms.AdvancedCustomFormEditorConfigOptions()},initializeData:function($super){$super();this._selection=null;this._editMode=false;this._colsNameLabel=$A([this.NL_COL_REVERT,this.NL_COL_GUID,this.NL_COL_LABEL,this.NL_COL_NAME,this.NL_COL_NAMEDEL])},initializeUIElements:function($super){this.AddClassName("cmAdvancedCustomFormEditor");this._header=$$P.div(null,null,{classNames:"cmCustomFormHeader cmBorderBox"});this.AddChild(this._header);this._dragDropHeader=$$P.h2(null,"Drag & Drop");this._header.AddChild(this._dragDropHeader);this._formTitleHeader=$$P.h3(null,"Untitled Form");this._header.AddChild(this._formTitleHeader);this._btnNameLabelView=new $$BTN(null,{text:"Name/Label Quick Edit",classNames:"cmFloatRight m10px"});this._btnNameLabelView.SetEnabled(false);this._header.AddChild(this._btnNameLabelView);$super();this._splash=new $$IMG(null,{source:cm.hosts.common+"/common/lib/core/ui/common/images/formbuilder.png"});this._footer=$$P.div(null,null,{classNames:"cmCustomFormFooter cmBorderBox"});this.AddChild(this._footer);this._btnSaveForm=new $$BTN(null,{text:"Save",classNames:"cmFloatRight cmGoButton m10px"});this._btnSaveForm.SetEnabled(false);this._footer.AddChild(this._btnSaveForm);this._btnPreview=new $$BTN(null,{text:"Preview",classNames:"cmFloatRight cmEditButton m10px"});this._btnPreview.Hide();this._btnPreview.SetEnabled(false);this._footer.AddChild(this._btnPreview);this._btnRevertForm=new $$BTN(null,{text:"Cancel",classNames:"cmFloatLeft cmCancelDeleteButton m10px"});this._footer.AddChild(this._btnRevertForm);this._cbShowConditionals=new $$FCB(null,{label:"Show Field Relations",classNames:"cmFloatRight m5px",spanWidth:125});this._cbShowConditionals.Bind(true);this._footer.AddChild(this._cbShowConditionals);this._btnExternalData=$$P.a(null,"&lArr;Ext",null,{classNames:"cmExternalData"});this._btnExternalData.Hide();this._viewMain.AddChild(this._btnExternalData);this._divExternalData=$$P.div(null,null,{classNames:"cmExternalData cmBorderBox"});this._divExternalData.Hide();this._viewMain.AddChild(this._divExternalData);this._tipExternalData=new cm.ui.customforms.PopupTip(null,{tip:"The external data editor lets you test fields that are linked to external data or constraints, such as Season ID which are system-wide properties. Hover over a data point and you can see which fields are tied to that data.  Changing the data will allow you to test conditions which rely on these external data points and show how the form will look when those data points are valid."});this._divExternalData.AddChild(this._tipExternalData);this._spanExternalDataHeader=$$P.span(null,"External Data Editor",{classNames:"cmExternalDataHeader"});this._divExternalData.AddChild(this._spanExternalDataHeader);this._btnExternalDataClose=new $$BTN(null,{text:"X"});this._divExternalData.AddChild(this._btnExternalDataClose);this._divExternalDataFields=$$P.div(null,"",{classNames:"extScroll"});this._divExternalData.AddChild(this._divExternalDataFields);this.makeNameLabelEditDialog()},createEvents:function($super){$super();this._btnExternalData.AddClickListener()},wireEvents:function($super){$super();this._btnExternalData.ClickEvent.subscribe(this.onExternalDataTabOpened,this);this._btnExternalDataClose.ClickEvent.subscribe(this.onExternalDataTabClosed,this);this._btnNameLabelView.ClickEvent.subscribe(this.onNameLabelViewClicked,this);this._diagNameLabelView.HideEvent.subscribe(this.onNameLabelViewHide,this);this._btnSaveForm.ClickEvent.subscribe(this.onSaveFormClicked,this);this._btnPreview.ClickEvent.subscribe(this.onPreviewClicked,this);this._btnRevertForm.ClickEvent.subscribe(this.onRevertFormClicked,this);this._cbShowConditionals.ChangeEvent.subscribe(this.onShowConditionalsChanged,this);this._btnNLSave.ClickEvent.subscribe(this.onNLSaveClicked,this);this._btnNLCancel.ClickEvent.subscribe(this.onNLCancelClicked,this);this._btnNLClearNames.ClickEvent.subscribe(this.onNLClearNamesClicked,this);this._btnNLClearLabels.ClickEvent.subscribe(this.onNLClearLabelsClicked,this)},postInitialize:function($super){$super();this.AddChild(this._splash);this.setSplashVisible(true,false)},setSplashVisible:function(b,a){this._btnSaveForm.SetEnabled(b!=true);this._btnPreview.SetEnabled(b!=true);if(b==true){if(a!=false&&this._splash.IsVisible()!=true){$$JQ(this._canvas).children().hide("fade",{duration:250});this._splash.Show()}else{$$JQ(this._canvas).children().hide();this._splash.Show()}}else{if(a!=false&&this._splash.IsVisible()==true){$$JQ(this._canvas).children().show("fade",{duration:250});this._splash.Hide()}else{$$JQ(this._canvas).children().show();this._splash.Hide()}}},SetContent:function($super,a){$super(a);if(a.length>0){this.setSplashVisible(false)}else{this.setSplashVisible(true)}},SetForm:function($super,a){if(!$$CM.isNull(a)){$super(a);this._formTitleHeader.UpdateInnerHtml(a.Form.Name);if(a.Form.ID>0){this.setSplashVisible(false)}this.updateExternalData()}},SetEnabled:function($super,a){$super(a);if(a!=true){this.setSplashVisible(true);this._btnExternalData.Hide(true,250,"fade")}},GetExternalData:function(){var a=$A();this._divExternalDataFields.ChildControls().each(function(b){a.push({Key:b.Guid,Value:b.GetData()})},this);return a},Clear:function($super){$super();this.setSplashVisible(this._splash.IsVisible()==true,false)},getObjectType:function(){if(this._currentForm.Context==FW.Enums.Context.FormsAdmin){return this._currentForm.FieldTypes}else{return FW.Data.CustomForms.GetFirst("CurrentSection").FieldTypes}},makeNameLabelEditDialog:function(){this._diagNameLabelView=new cm.ui.dialog.ModalDialog(null,{title:"Name/Label Quick Edit",width:515,dialogClass:"cmBaseDialog diagNameLabel"});this.AddChild(this._diagNameLabelView);this._tblNameLabel=new $$DTBL(null,{cols:this._colsNameLabel,hasBodyScroll:true,bodyScrollHeight:300,classNames:"w500px"});this._diagNameLabelView.AddChild(this._tblNameLabel);this._btnNLSave=new $$BTN(null,{text:"Save",classNames:"cmGoButton cmFloatRight m5px"});this._diagNameLabelView.AddChild(this._btnNLSave);this._btnNLCancel=new $$BTN(null,{text:"Cancel",classNames:"cmCancelDeleteButton cmFloatLeft m5px"});this._diagNameLabelView.AddChild(this._btnNLCancel);this._btnNLClearLabels=new $$BTN(null,{text:"Clear All Labels",classNames:"cmBackButton cmFloatLeft m5px"});this._diagNameLabelView.AddChild(this._btnNLClearLabels);this._btnNLClearNames=new $$BTN(null,{text:"Clear All Names",classNames:"cmBackButton cmFloatLeft m5px"});this._diagNameLabelView.AddChild(this._btnNLClearNames)},updateNameLabelView:function(){var a=this.GetConstraintsArray();this._tblNameLabel.Clear();a.each(function(e){var d=FW.Data.CustomForms.Get("GuidTable").get(e.ID);this._tblNameLabel.AddRow(e.ID);var c=new $$BTN(null,{classNames:"p10px cmBackButton"});c.SetEnabled(false);c.Guid=e.ID;c.ClickEvent.subscribe(this.onNLRevertClicked,this);this._tblNameLabel.SetCell(e.ID,this.NL_COL_REVERT.Key,c);var b=new cm.ui.Anchor(null,{text:e.ID,classNames:"guidView"});b.AddMouseOverListener();b.MouseOverEvent.subscribe(this.onNLGuidClicked,this);b.Guid=e.ID;this._tblNameLabel.SetCell(e.ID,this.NL_COL_GUID.Key,b);var f=new $$FTXT(null,{spanWidth:0,inputWidth:150});f.Bind(d.GetConfig(CFG_LABEL));f.Guid=e.ID;f.ChangeEvent.subscribe(this.onNLTextChange,this);this._tblNameLabel.SetCell(e.ID,this.NL_COL_LABEL.Key,f);var f=new $$FTXT(null,{spanWidth:0,inputWidth:130});f.Bind(d.GetConfig(CFG_NAME));f.Guid=e.ID;f.ChangeEvent.subscribe(this.onNLTextChange,this);this._tblNameLabel.SetCell(e.ID,this.NL_COL_NAME.Key,f);var c=new $$BTN(null,{classNames:"p10px cmCancelDeleteButton"});c.Guid=e.ID;c.ClickEvent.subscribe(this.onNLNameDeleteClicked,this);this._tblNameLabel.SetCell(e.ID,this.NL_COL_NAMEDEL.Key,c)},this)},onToolStartDrag:function($super,b,a){this.setSplashVisible(false);$super(b,a)},onNameLabelViewClicked:function(b,a){this._canvas.SetEnabled(false);this._toolbar.SetEnabled(false);$$JQ(this._canvas).find(".cmFrameworkObject").removeClass("cmSelected");FW.Data.CustomForms.Replace("NameLabelEditTable",$A());this.updateNameLabelView();this._diagNameLabelView.Show();this._editMode=true},onNameLabelViewHide:function(b,a){this._canvas.SetEnabled(true);this._toolbar.SetEnabled(true);this._canvas.SetEnabled(true);if(!$$CM.isNull(this._selection)){this._selection.AddClassName("cmSelected")}$$JQ(this._canvas).find(".cmFrameworkObject").removeClass("guidHighlight");this._editMode=false},onNLGuidClicked:function(d,a){var b=d.Guid;$$JQ(this._canvas).find(".cmFrameworkObject").removeClass("guidHighlight");var c=FW.Data.CustomForms.Get("GuidTable").get(b);if(!$$CM.isNull(c)){$$JQ(this._canvas).scrollTop($$JQ(c).position().top-100);c.AddClassName("guidHighlight")}},onNLRevertClicked:function(d,a){var b=d.Guid;var c=FW.Data.CustomForms.Get("GuidTable").get(b);if(!$$CM.isNull(c)){this._tblNameLabel.GetRow(b).Row.RemoveClassName("edited");this._tblNameLabel.GetCell(b,this.NL_COL_LABEL.Key).Bind(c.GetConfig(CFG_LABEL));this._tblNameLabel.GetCell(b,this.NL_COL_NAME.Key).Bind(c.GetConfig(CFG_NAME));this._tblNameLabel.GetCell(b,this.NL_COL_REVERT.Key).SetEnabled(false)}},onNLNameDeleteClicked:function(e,a){var c=e.Guid;var d=FW.Data.CustomForms.Get("GuidTable").get(c);if(!$$CM.isNull(d)){var b=this._tblNameLabel.GetCell(c,this.NL_COL_NAME.Key);b.Bind();this.onNLTextChange(b)}},onNLTextChange:function(f,a){var d=f.Guid;var c=this._tblNameLabel.GetCell(d,this.NL_COL_NAME.Key).GetData();var b=this._tblNameLabel.GetCell(d,this.NL_COL_LABEL.Key).GetData();var e=FW.Data.CustomForms.Get("GuidTable").get(d);if(!$$CM.isNull(e)){if(c!=e.GetConfig(CFG_NAME)||b!=e.GetConfig(CFG_LABEL)){this._tblNameLabel.GetRow(d).Row.AddClassName("edited");this._tblNameLabel.GetCell(d,this.NL_COL_REVERT.Key).SetEnabled(true);FW.Data.CustomForms.Merge("NameLabelEditTable",{Guid:d,Label:b,Name:c},"Guid")}else{this._tblNameLabel.GetRow(d).Row.RemoveClassName("edited");this._tblNameLabel.GetCell(d,this.NL_COL_REVERT.Key).SetEnabled(false);FW.Data.CustomForms.Remove("NameLabelEditTable",{Guid:d})}}},onNLSaveClicked:function(b,a){FW.Data.CustomForms.Get("NameLabelEditTable").each(function(c){var d=FW.Data.CustomForms.Get("GuidTable").get(c.Guid);if(!$$CM.isNull(d)){if(d.IsTypeOf(CLS_CUSTOMFIELD)){d.GetCustomFieldControl().SetConfig(CFG_LABEL,c.Label);d.GetCustomFieldControl().SetConfig(CFG_NAME,c.Name)}else{d.SetConfig(CFG_LABEL,c.Label);d.SetConfig(CFG_NAME,c.Name)}d.Reload()}},this);FW.Data.CustomForms.Replace("NameLabelEditTable",$A());this._diagNameLabelView.Hide()},onNLCancelClicked:function(b,a){FW.Data.CustomForms.Replace("NameLabelEditTable",$A());this._diagNameLabelView.Hide()},onNLClearNamesClicked:function(b,a){this._tblNameLabel.RowIDs().each(function(d){var c=this._tblNameLabel.GetCell(d,this.NL_COL_NAME.Key);c.Bind();this.onNLTextChange(c)},this)},onNLClearLabelsClicked:function(b,a){this._tblNameLabel.RowIDs().each(function(d){var c=this._tblNameLabel.GetCell(d,this.NL_COL_LABEL.Key);c.Bind();this.onNLTextChange(c)},this)},onSaveFormClicked:function(b,a){this.Save()},onPreviewClicked:function(b,a){DAO.CustomForms.RequestFormPreview({Content:this.GetContent(),Form:this._currentForm})},onPreviewRequested:function(c,a){var b=a.RedirectResponse;var e=b.Path.split("/");var d=e[0]+"//"+e[2];d+=FW.Data.CustomForms.GetFirst("RedirectURL");$$CM.doPopup(d,"Custom Form Preview","height=810,width=800,menubar=yes,resizable=yes,scrollbars=yes,status=yes,titlebar=yes,toolbar=yes,location=yes")},onContentLoaded:function($super){$super();this._btnSaveForm.SetEnabled(true);this._btnPreview.SetEnabled(true);this._btnNameLabelView.SetEnabled(true)},onShowConditionalsChanged:function(b,a){if(b.GetData()==true){this._canvas.RemoveClassName("cmForceConditionals")}else{this._canvas.AddClassName("cmForceConditionals")}},onRevertFormClicked:function(b,a){$$CMD.Confirm({title:"Revert Form",message:"All unsaved changes on this form will be lost, are you sure you want to cancel?",handlerOk:this.onRevertFormOk,scope:this})},onRevertFormOk:function(b,a){this.Cancel()},onLayoutInitialized:function(b,a){this._overlay=$$P.div("cfOverlay");this._overlay.Hide();this.AddChild(this._overlay)},onObjectReload:function($super,b,a){$super(b,a);this.updateExternalData()},onExternalDataTabOpened:function(b,a){this._editMode=true;if(!$$CM.isNull(this._selection)){this._selection.dragHandle.Hide();this._selection.functionBar.Hide();this._selection.RemoveClassName("cmSelected");this._selection=null}this._canvas.SetEnabled(false);this._toolbar.SetEnabled(false);this._overlay.Show(true,250,"fade");this._btnExternalData.Hide(true,250,"fade");this._divExternalData.Show(true,250,"slide",{direction:"right"})},onExternalDataTabClosed:function(b,a){this._editMode=false;this._canvas.SetEnabled(true);this._toolbar.SetEnabled(true);this._overlay.Hide(true,250,"fade");this._btnExternalData.Show(true,250,"fade");this._divExternalData.Hide(true,250,"slide",{direction:"right"});this.BindExternalData(this.GetExternalData())},onExtDataMouseOver:function(b,a){this._extDataTable.get(b.Guid).each(function(c){c.AddClassName("cmUsingExternalData")},this)},onExtDataMouseOut:function(b,a){this._extDataTable.get(b.Guid).each(function(c){c.RemoveClassName("cmUsingExternalData")},this)},updateExternalData:function(){this._extDataTable=new cm.ui.Hashtable();this._divExternalDataFields.DestroyChildControls();this.GetAllObjects().each(function(a){a.Conditions.each(function(c){if(c.Guid.startsWith("L")!=true){var g=this._extDataTable.get(c.Guid);if($$CM.isNull(g)){this._extDataTable.put(c.Guid,$A());var f=$A();var d=this.GetConstraint(c.Guid);if(!$$CM.isNull(d)){if(!$$CM.isNull(d.CustomFieldID)){FW.Data.CustomForms.Get("CustomFieldDefinitions",{FieldID:d.CustomFieldID}).each(function(h){h.Options.each(function(i){f.push({ID:i,Name:i})},this)},this)}else{var f=d.Datasource}if(d.IsMulti==true){var b=new $$FSCBL(null,{classNames:"cmExternalDataField",legendLabel:d.Name,dataSource:f});b.Guid=c.Guid;b.AddMouseOverListener();b.AddMouseOutListener();b.MouseOverEvent.subscribe(this.onExtDataMouseOver,this);b.MouseOutEvent.subscribe(this.onExtDataMouseOut,this);b.Bind(this.GetConstraintValue(c.Guid));this._divExternalDataFields.AddChild(b)}else{var e=new $$FDDL(null,{classNames:"cmExternalDataField",label:d.Name,dataSource:f});e.Guid=c.Guid;e.AddMouseOverListener();e.AddMouseOutListener();e.MouseOverEvent.subscribe(this.onExtDataMouseOver,this);e.MouseOutEvent.subscribe(this.onExtDataMouseOut,this);e.Bind(this.GetConstraintValue(c.Guid));this._divExternalDataFields.AddChild(e)}this._extDataTable.get(c.Guid).push(a)}}else{this._extDataTable.get(c.Guid).push(a)}}},this)},this);if(this._extDataTable.keys.length>0&&this._btnExternalData.IsVisible()==false){this._btnExternalData.Show(true,250,"fade")}else{if(this._extDataTable.keys.length==0&&this._btnExternalData.IsVisible()==true){this._btnExternalData.Hide(true,250,"fade")}}},onConfigEditorOpened:function($super,b,a){$super(b,a);if(!$$CM.isNull(this._selection)&&this._selection.IsValid()==true&&this._editMode!=true){this._btnNameLabelView.SetEnabled(false);this._btnExternalData.Hide(true,250,"fade")}a.event.stop()},onConfigEditorClosed:function($super,b,a){$super(b,a);this._btnNameLabelView.SetEnabled(true);this._btnExternalData.Show(true,250,"fade")}});"cm.ui.customforms".namespace();cm.ui.customforms.CustomFormToolbar=Class.create(cm.ui.customforms.Toolbar,{initializeDAOs:function(){this._dao=new cm.dao.Framework.DAO()},initializeData:function(){this._classes=this._dao.GetData("ActiveClassArray")},initializeUIElements:function(){this.AddClassName("cmCustomFormToolbar")},renderTool:function(e){var a=Framework.Object.GetClass(e.ClassID);var b=$A();e.VisualConfigOptions.each(function(h){b.push({ID:h.ID,Value:h.Value})},this);var c=$$P.div(null,null,{classNames:"cmFrameworkToolItem"});var g=$$P.h4("cmFrameworkToolItemLabel",e.Name,{classNames:"m0px"});c.AddChild(g);try{var f=Framework.Object.Render(a.ID,b);f.SetEnabled(false);c.AddChild(f);if(f.IsValid()!=true){throw""}}catch(d){c.AddClassName("cmInvalidTool");c.AddChild($$P.div(null,"Invalid Tool!"))}return c}});"cm.ui.customforms".namespace();"cm.ui.customforms.action".namespace();cm.ui.customforms.Action=Class.create({_object:null,_action:null,initialize:function(b,a){this._object=b;this._action=a},Execute:function(a){if(!$$CM.isNull(this._action)){if(a==true){this._action.Pass.call(this._object)}else{this._action.Fail.call(this._object)}}}});cm.ui.customforms.action.Show={Pass:function(){this.AddClassName("cmActionPass");this.RemoveClassName("cmActionHidden");this.IsApplicable=true;this.Show()},Fail:function(){this.RemoveClassName("cmActionPass");this.AddClassName("cmActionHidden");this.IsApplicable=false;this.Hide()}};cm.ui.customforms.action.Hide={Pass:function(){this.AddClassName("cmActionPass");this.AddClassName("cmActionHidden");this.IsApplicable=false;this.Hide()},Fail:function(){this.RemoveClassName("cmActionPass");this.RemoveClassName("cmActionHidden");this.IsApplicable=true;this.Show()}};cm.ui.customforms.action.Require={Pass:function(){this.AddClassName("cmActionPass");if(this._cf&&this._cf.IsArray==true){this.Validator.SetEvaluator($$EVAL.MULTISELECT({IsRequired:true}))}else{this.Validator.SetEvaluator($$EVAL.TEXT({IsRequired:true}))}try{this.ChildControls().each(function(b){if(b.GetTitleInnerControl){b.GetTitleInnerControl().AddClassName("cmRequiredField")}})}catch(a){}},Fail:function(){this.RemoveClassName("cmActionPass");if(this._cf&&this._cf.IsArray){this.Validator.SetEvaluator($$EVAL.MULTISELECT({IsRequired:false}))}else{this.Validator.SetEvaluator($$EVAL.TEXT({IsRequired:false}))}try{this.ChildControls().each(function(b){if(b.GetTitleInnerControl){b.GetTitleInnerControl().RemoveClassName("cmRequiredField")}})}catch(a){}}};var dao=new cm.dao.Framework.DAO();for(var action in cm.ui.customforms.action){var id=action;if(!$$CM.isNull(cm.ui.customforms.action[action].ID)){id=cm.ui.customforms.action[action].ID}dao.SetData("ActionArray",{ID:id,Name:action})}delete dao;"cm.ui.customforms".namespace();cm.ui.customforms.CanvasConfigOptions=Class.create(cm.ConfigOptions,{layout:new cm.ui.customforms.layout.LayoutHandler(),label:"",width:null});cm.ui.customforms.Canvas=Class.create(cm.ui.Control,{_master:null,_layout:null,ObjectBeforeAddedEvent:null,ObjectAddedEvent:null,ObjectBeforeRemovedEvent:null,ObjectRemovedEvent:null,LayoutUpdatedEvent:null,LayoutInitializedEvent:null,SectorHoverEvent:null,SectorExitEvent:null,createEvents:function(){this.ObjectBeforeAddedEvent=new cm.event();this.ObjectAddedEvent=new cm.event();this.ObjectBeforeRemovedEvent=new cm.event();this.ObjectRemovedEvent=new cm.event();this.LayoutUpdatedEvent=new cm.event();this.LayoutInitializedEvent=new cm.event();this.SectorHoverEvent=new cm.event();this.SectorExitEvent=new cm.event()},wireEvents:function(){},initializeData:function(){this._master=this},postInitialize:function(){this.AddClassName("cmCanvas");this.SetLayout(this.GetConfigOptions().layout);if(!$$CM.isNull(this.GetConfigOptions().width)){this.AssignStyle("width",this.GetConfigOptions().width+"px")}},configureDefaultOptions:function(){return new cm.ui.customforms.CanvasConfigOptions()},SetEnabled:function(a){this.GetObjects().each(function(b){if((a==true&&b.GetConfig(102)!=true)==false){b.SetEnabled(a)}},this);this._layout.SetEnabled(a)},GetData:function(){return null},SetWidth:function(a){if(!$$CM.isNull(a)){this.AssignStyle("width",a+"px")}},AddObject:function(a){if(this.isMaster()!=true){this.ObjectBeforeAddedEvent.fire(this,a)}this.getMaster().ObjectBeforeAddedEvent.fire(this,a);a._master=this._master;if(!$$CM.isNull(a.Parent)){a._owner.ObjectBeforeRemovedEvent.fire(a.Parent,a);a.Parent.RemoveChildControl(a);a._owner.ObjectRemovedEvent.fire(a.Parent,a);a._owner._layout.Update()}this._layout.Add(a);if(this.isMaster()!=true){this.ObjectAddedEvent.fire(this,a)}this.getMaster().ObjectAddedEvent.fire(this,a)},RemoveObject:function(a){if(this.isMaster()!=true){this.ObjectBeforeRemovedEvent.fire(this,a)}this.getMaster().ObjectBeforeRemovedEvent.fire(this,a);a._master=null;this._layout.Remove(a);if(this.isMaster()!=true){this.ObjectRemovedEvent.fire(this,a)}this.getMaster().ObjectRemovedEvent.fire(this,a)},SetLayout:function(a){this.DestroyChildControls();if(!$$CM.isNull(this._layout)){this._layout.Detach(this)}this._layout=a;this._layout.Initialize(this,this.GetConfigOptions().width);this.LayoutInitializedEvent.fire(this)},GetLayout:function(){return this._layout},GetObjects:function(){return this._layout.GetObjects()},GetAllObjects:function(){var a=this.doGetAllObjects(this.GetObjects());return a},doGetAllObjects:function(b){var a=$A();a=a.concat(b);b.each(function(c){if(c.Children.length>0){a=a.concat(this.doGetAllObjects(c.Children))}},this);return a},Clear:function(){this.GetObjects().each(function(a){this.RemoveObject(a)},this);this.GetLayout().Reset()},getMaster:function(){return this._master;if($$CM.isNull(this.Parent)||$$CM.isNull(this.Parent._master)){return this}else{return this.Parent._master}},isMaster:function(){return this._master==this}});"cm.ui.customforms".namespace();"cm.ui.customforms.comparer".namespace();cm.ui.customforms.RegExpSplitCaps=/([a-z])([A-Z])/g;cm.ui.customforms.Comparer=Class.create({_value:null,_comparer:null,initialize:function(b,a){this._value=b;this._comparer=a},Execute:function(a){if(!$$CM.isNull(this._comparer)){return this._comparer.Compare(this._value,a)}else{return false}}});cm.ui.customforms.comparer.Equals={Compare:function(b,a){return b==a}};cm.ui.customforms.comparer.GreaterThan={Compare:function(b,a){return b>a}};cm.ui.customforms.comparer.GreaterThanOrEqual={Compare:function(b,a){return b>=a}};cm.ui.customforms.comparer.LessThan={Compare:function(b,a){return b<a}};cm.ui.customforms.comparer.LessThanOrEqual={Compare:function(b,a){return b<=a}};cm.ui.customforms.comparer.NotEqual={Compare:function(b,a){return b!=a}};cm.ui.customforms.comparer.IsOneOf={Compare:function(c,a){if(!$$CM.isNull(c)&&$$CM.isArray(a)){if($$CM.isArray(c)){var b=false;c.each(function(d){if(a.indexOf(d.toString())>=0){b=true}},this);return b}else{return a.indexOf(c.toString())>=0}}else{return c===a}}};cm.ui.customforms.comparer.Contains={Compare:function(c,a){if($$CM.isArray(c)&&$$CM.isArray(a)){var b=false;a.each(function(d){if(c.indexOf(d.toString())>=0){b=true;return true}});return b}else{if($$CM.isArray(c)){return c.indexOf(a.toString())>=0}else{return c===a}}}};var dao=new cm.dao.Framework.DAO();for(var comp in cm.ui.customforms.comparer){var id=comp;if(!$$CM.isNull(cm.ui.customforms.comparer[comp].ID)){id=cm.ui.customforms.comparer[comp].ID}dao.SetData("ComparerArray",{ID:id,Name:comp.replace(cm.ui.customforms.RegExpSplitCaps,"$1 $2")})}delete dao;"cm.ui.customforms".namespace();cm.ui.customforms.ConfigEditor=Class.create(cm.ui.Control,{_currentObject:null,ClosedEvent:null,Focus:function(){this._btnSave.Focus()},Bind:function(b,a){this._currentObject=b;this._tabFields.Bind(b,a);this._tabValidation.Bind(b);this._tabConditions.Bind(b,a)},initializeData:function(){this._currentObject=null},initializeUIElements:function(){this._tabs=new $$TABS("cfConfigEditorTabs",{classNames:"w100prct h100prct cmBorderBox"});this.AddChild(this._tabs);this._tabFields=new cm.ui.customforms.ConfigEditorTabFields();this._tabValidation=new cm.ui.customforms.ConfigEditorTabValidation();this._tabConditions=new cm.ui.customforms.ConfigEditorTabConditions();this._tabs.AddTab("Field Properties",this._tabFields);this._tabs.AddTab("Validation",this._tabValidation);this._tabs.AddTab("Conditions",this._tabConditions);this._footer=$$P.div("cfConfigEditorFooter",null,{classNames:"w100prct h45px cmBorderBox"});this.AddChild(this._footer);this._btnRevert=new $$BTN(null,{text:"Cancel",classNames:"ml10px mt5px mb5px cmBackButton cmFloatLeft"});this._footer.AddChild(this._btnRevert);this._btnSave=new $$BTN(null,{text:"Save",classNames:"mr10px mt5px mb5px cmFloatRight"});this._footer.AddChild(this._btnSave)},createEvents:function(){this.AddKeyDownListener();this.ClosedEvent=new cm.event()},wireEvents:function(){this._btnSave.ClickEvent.subscribe(this.onSaveClicked,this);this._btnRevert.ClickEvent.subscribe(this.onRevertClicked,this);this.KeyDownEvent.subscribe(this.onKeyDown,this)},onKeyDown:function(b,a){if(a.event.keyCode==27){this.onRevertClicked(b,a)}if(a.event.keyCode==13){this.onSaveClicked(b,a)}},onRevertClicked:function(b,a){this.ClosedEvent.fire(this,a)},onSaveClicked:function(e,a){var d=this.Validator.validate(true);if(d.IsValid()==true){var c=this._tabFields.GetData();c.each(function(g){this._currentObject.SetConfig(g.ID,g.Value)},this);var f=this._tabValidation.GetData();this._currentObject.SetConfig(CFG_EVALUATOR,f.EvaluatorID);this._currentObject.SetConfig(CFG_EVALUATOR_IS_REQUIRED,f.IsRequired);var b=this._tabConditions.GetData();this._currentObject.Conditions=b;this._currentObject.Reload();this.ClosedEvent.fire(this,a)}a.event.stop()}});"cm.ui.customforms".namespace();cm.ui.customforms.ConfigEditorTabConditions=Class.create(cm.ui.Control,{CONDITION_COL_DELETE:{Key:"Delete",Name:"",ClassNames:"w55px cmCenter"},CONDITION_COL_FIELD:{Key:"Field",Name:"Field"},CONDITION_COL_COMPARISON:{Key:"Comparison",Name:"Comparison"},CONDITION_COL_VALUE:{Key:"Value",Name:"Value"},CONDITION_COL_ACTION:{Key:"Action",Name:"Action"},_valueState:null,_currentObject:null,initializeDAOs:function(){this._dao=new cm.dao.Framework.DAO();this._cfDAO=new cm.dao.CustomForms.DAO()},initializeData:function(){this._colsCondition=$A([this.CONDITION_COL_DELETE,this.CONDITION_COL_FIELD,this.CONDITION_COL_COMPARISON,this.CONDITION_COL_VALUE,this.CONDITION_COL_ACTION]);this._fieldDS=$A();this._valueState=false},initializeUIElements:function(){this._btnNew=new $$BTN(null,{text:"+ Add Condition",classNames:"cmGoButton"});this.AddChild(this._btnNew);var a=$$P.div("divConditions");this._tblCondition=new $$DTBL(null,{cols:this._colsCondition,classNames:"w100prct mt5px"});a.AddChild(this._tblCondition);this._tip=new cm.ui.customforms.PopupTip(null,{tip:"Conditions allow the form to change depending on other credentials supplied by the form.  For instance, you can show or hide this object if the specified criteria matches as specified in the condition table"});this.AddChild(this._tip);this.AddChild(a)},wireEvents:function(){this._btnNew.ClickEvent.subscribe(this.onNewConditionClicked,this)},GetData:function(){var a=$A();this._tblCondition.RowIDs().each(function(c){var b={Guid:this._tblCondition.GetCell(c,this.CONDITION_COL_FIELD.Key).GetData(),Comparer:this._tblCondition.GetCell(c,this.CONDITION_COL_COMPARISON.Key).GetData(),Value:this.getValue(c),Action:this._tblCondition.GetCell(c,this.CONDITION_COL_ACTION.Key).GetData()};a.push(b)},this);return a},Bind:function(b,a){this._tblCondition.Clear();this._currentObject=b;this._formID=a._currentForm.ID;this._cfe=a;b.Conditions.each(function(c){this.addCondition(c)},this)},getValue:function(a){var b=this._tblCondition.GetCell(a,this.CONDITION_COL_VALUE.Key).GetData();if($$CM.isArray(b)){return $$CM.stringify(b)}else{return b}},makeGuidList:function(){var d=FW.Data.CustomForms.Get("GuidTable");var a=new $$FDDL();var c=$$P.optgrp(null,"Local");d.keys.without("L"+this._currentObject.Guid).select(function(f){var e=d.get(f);return(!$$CM.isNull(e)&&e.IsValidConditional()==true)}).each(function(f){var e=d.get(f);var g=e.GetName();if($$CM.isEmpty(g)){g="Unnamed ("+f+")"}else{g+=" ("+f+")"}c.AddChild($$P.opt(g,f))},this);a.GetInputControl().AddChild(c);var b=this;FW.Data.CustomForms.Get("ExtConstraints",function(e){return e.FormID!=b._formID}).each(function(e){var g=null;var f;if(e.FormID==0){f="G:";g=$$P.optgrp(null,"Global")}else{f="F"+e.FormID+":";g=$$P.optgrp(null,"("+f.replace(":","")+") "+e.Name)}if(!$$CM.isNull(g)){e.ConstraintsArray.each(function(h){if(!$$CM.isNull(h.CustomFieldID)){FW.Data.CustomForms.Get("CustomFieldDefinitions",{FieldID:h.CustomFieldID}).each(function(i){if(i.Options.length>0){g.AddChild($$P.opt("("+(f+h.ID)+") "+h.Name,f+h.ID))}},this)}else{if(h.Datasource.length>0){g.AddChild($$P.opt("("+(f+h.ID)+") "+h.Name,f+h.ID))}}},this);a.GetInputControl().AddChild(g)}},this);return a},addCondition:function(d){var g=$$CM.newGuid();var b=new $$BTN(null,{text:"Delete",classNames:"cmCancelDeleteButton"});b.RowID=g;b.ClickEvent.subscribe(this.onDeleteConditionClicked,this);var f=this.makeGuidList();f.Validator.addEvaluator($$EVAL.SELECT({IsRequired:true}));f.ChangeEvent.subscribe(this.onConditionFieldChanged,this);f.RowID=g;var c=new $$FDDL(null,{name:"Condition Comparison",dataSource:Framework.Enums.Comparer.GetArrayWithoutNone()});c.Validator.addEvaluator($$EVAL.SELECT({IsRequired:true}));c.ChangeEvent.subscribe(this.onConditionComparerChanged,this);c.RowID=g;c.SetEnabled(false);var h=new $$FDDL(null,{name:"Condition Value",dataSource:$A()});h.Validator.addEvaluator($$EVAL.SELECT({IsRequired:true}));h.SetEnabled(false);var a=new $$FDDL(null,{name:"Condition Action",dataSource:Framework.Enums.Action.GetArrayWithoutNone()});a.Validator.addEvaluator($$EVAL.SELECT({IsRequired:true}));a.SetEnabled(false);this._tblCondition.SetCell(g,this.CONDITION_COL_DELETE.Key,b);this._tblCondition.SetCell(g,this.CONDITION_COL_FIELD.Key,f);this._tblCondition.SetCell(g,this.CONDITION_COL_COMPARISON.Key,c);this._tblCondition.SetCell(g,this.CONDITION_COL_VALUE.Key,h);this._tblCondition.SetCell(g,this.CONDITION_COL_ACTION.Key,a);if(!$$CM.isNull(d)){f.Bind(d.Guid);this.onConditionFieldChanged(f);c.Bind(d.Comparer);this.onConditionComparerChanged(c);try{this._tblCondition.GetCell(g,this.CONDITION_COL_VALUE.Key).Bind(JSON.parse(d.Value))}catch(e){this._tblCondition.GetCell(g,this.CONDITION_COL_VALUE.Key).Bind(d.Value)}a.Bind(d.Action)}},onNewConditionClicked:function(b,a){this.addCondition()},onDeleteConditionClicked:function(b,a){this._tblCondition.RemoveRow(b.RowID)},onConditionFieldChanged:function(n,b){var m=FW.Data.CustomForms.Get("GuidTable");var l=n.RowID;var e=this._tblCondition.GetCell(l,this.CONDITION_COL_COMPARISON.Key);var p=this._tblCondition.GetCell(l,this.CONDITION_COL_VALUE.Key);var a=this._tblCondition.GetCell(l,this.CONDITION_COL_ACTION.Key);var k=m.get(n.GetData());if(!$$CM.isNull(k)){var i=k.GetConfig(CFG_LIST);if($$CM.isArray(i)){p.bindList(i,-1,"Select one")}e.SetEnabled(true);p.SetEnabled(true);a.SetEnabled(true)}else{var g=FW.Data.Get("ExtConstraints","CustomForms");var h=n.GetData();var o=h.split(":");var d=null;if(o[0]=="G"){d=g.find(function(c){return c.FormID==0})}else{if(o[0].startsWith("F")){d=g.find(function(c){return c.FormID==o[0].substr(1)})}}if(!$$CM.isNull(d)){var f=d.ConstraintsArray.find(function(c){return c.ID==o[1]});if(f.Datasource.length>0){p.bindList(f.Datasource,-1,"Select one")}else{if(!$$CM.isNull(f.CustomFieldID)){FW.Data.CustomForms.Get("CustomFieldDefinitions",{FieldID:f.CustomFieldID}).each(function(q){var c=$A();q.Options.each(function(r){c.push({ID:q.Options.indexOf(r),Name:r})},this);p.bindList(c,-1,"Select one")},this)}}var j=FW.Enums.Comparer.GetArrayWithoutNone();if(f.IsMulti==true){j=j.reject(function(c){return c.ID<FW.Enums.Comparer.Contains})}else{j=j.reject(function(c){return c.ID>=FW.Enums.Comparer.Contains})}e.bindList(j,-1,"Select one");e.SetEnabled(true);p.SetEnabled(true);a.SetEnabled(true)}else{e.SetEnabled(false);p.SetEnabled(false);a.SetEnabled(false)}}e.Bind(null);p.Bind(null);a.Bind(null);this.onConditionComparerChanged(e)},onConditionComparerChanged:function(i,a){var f=i.RowID;var h=FW.Data.CustomForms.Get("GuidTable");var d=this._cfe.GetConstraint(this._tblCondition.GetCell(f,this.CONDITION_COL_FIELD.Key).GetData());var g=this._tblCondition.GetCell(f,this.CONDITION_COL_VALUE.Key);if(!$$CM.isNull(d)){var e=$A();if($$CM.isNull(d.CustomFieldID)){e=d.Datasource}else{FW.Data.CustomForms.Get("CustomFieldDefinitions",{FieldID:d.CustomFieldID}).each(function(k){var j=$A();k.Options.each(function(l){j.push({ID:l,Name:l})},this);e=j},this)}if(!$$CM.isNull(e)){if(i.GetData()==FW.Enums.Comparer.IsOneOf&&this._valueState!=true){var b=new $$FLB(null,{inputWidth:150,spanWidth:0,dataSource:e,classNames:"m0px"});b.Validator.addEvaluator($$EVAL.MULTISELECT({IsRequired:true}));this._tblCondition.SetCell(f,this.CONDITION_COL_VALUE.Key,b);this._valueState=true}else{if(i.GetData()!=FW.Enums.Comparer.IsOneOf&&this._valueState!=false){var c=new $$FDDL(null,{dataSource:e});c.Validator.addEvaluator($$EVAL.SELECT({IsRequired:true}));this._tblCondition.SetCell(f,this.CONDITION_COL_VALUE.Key,c);this._valueState=false}}}}}});"cm.ui.customforms".namespace();cm.ui.customforms.ConfigEditorTabFields=Class.create(cm.ui.Control,{_data:null,initializeUIElements:function(){this._divField=$$P.div("divFields");this.AddChild(this._divField);this._tip=new cm.ui.customforms.PopupTip(null,{tip:"This tab allows you to change the properties of the selected form object.<br /><br />The NAME property is used for printing, if NAME is blank, the LABEL property is used instead."});this._tip2=new cm.ui.customforms.PopupTip(null,{tip:"This tab allows you to change the properties of the selected form object.<br /><br />The NAME property is used for printing, if NAME is blank, the TEXT property is used instead."});this._currentTip=this._tip;this.AddChild(this._currentTip)},initializeData:function(){this._data=$A()},initializeDAOs:function(){this._dao=new cm.dao.Framework.DAO();this._cfDAO=new cm.dao.CustomForms.DAO()},GetData:function(){var a=$A();this._data.each(function(b){a.push({ID:b.ConfigOption.ID,Value:b.Field.GetData()})},this);return a},Bind:function(c,a){this._data=$A();this._divField.ClearChildControls();var b=FW.Object.GetClass(c.ClassID);if(!$$CM.isNull(b)){var d=$A();c.ConfigOptions.each(function(f){var e=b.ConfigOptions.find(function(k){return k.ID==f.ID});if(!$$CM.isNull(e)&&e.IsEditable==true){var i=!$$CM.isEmpty(e.DisplayName)?e.DisplayName:FW.Object.GetConfigOptionDefinition(e.ID).Name;var g=$$P.div(null,null,{classNames:"w100prct cmFloatLeft"});var j=$$P.span(null,i,{classNames:"cmFloatLeft w120px m5px"});var h=$$FE(c,e.FieldEditor,null,"configEditor");h.AddClassName("cmFloatLeft w200px");h.SetEnabled(e.IsEnabled);h.Bind(c.GetConfig(e.ID));g.AddChild(j);g.AddChild(h);d.push({Div:g,ConfigOption:e,Field:h})}},this);d.sort(function(e,f){return e.ConfigOption.SortOrder-f.ConfigOption.SortOrder});d.each(function(f){this._divField.AddChild(f.Div)},this);this._data=d;this.RemoveChildControl(this._currentTip);this._currentTip=(b.Name==="InfoBox"||b.Name==="Header")?this._tip2:this._tip;this.AddChild(this._currentTip)}}});"cm.ui.customforms".namespace();cm.ui.customforms.ConfigEditorTabValidation=Class.create(cm.ui.Control,{initializeDAOs:function(){this._dao=new cm.dao.Framework.DAO()},initializeData:function(){this._validationDS=$A([{ID:"TEXT",Name:"Is Text"},{ID:"NUMBER",Name:"Is Number"},{ID:"EMAIL",Name:"Is E-mail Address"},{ID:"URL",Name:"Is Website/URL"},{ID:"DATE",Name:"Is Date"},{ID:"SELECT",Name:"Is Required"},{ID:"GROUP",Name:"Is Required"},{ID:"MULTISELECT",Name:"Is Required"},{ID:"BOOL",Name:"Is Yes/No"}])},initializeUIElements:function(){var a=$$P.div(null,null,{classNames:"w100prct cmFloatLeft"});var b=$$P.span(null,"Evaluator",{classNames:"cmFloatLeft w120px m5px"});this._ddlValidation=new $$FDDL(null,{classNames:"cmFloatLeft w200px"});a.AddChild(b);a.AddChild(this._ddlValidation);this.AddChild(a);this._divRequired=$$P.div(null,null,{classNames:"w100prct cmFloatLeft"});var b=$$P.span(null,"Is Required",{classNames:"cmFloatLeft w120px m5px"});this._cbRequired=new $$FCB(null,{classNames:"cmFloatLeft w200px"});this._divRequired.AddChild(b);this._divRequired.AddChild(this._cbRequired);this.AddChild(this._divRequired);this._tip=new cm.ui.customforms.PopupTip(null,{tip:'This tab allows you to specify that this field requires a specific type of input in order for the custom form to be submitted.  For instance, the "Is Required" option will require that the field is not empty to submit, or "Is Number" which requires that the user specifies a number value in the field.'});this.AddChild(this._tip)},wireEvents:function(){this._ddlValidation.ChangeEvent.subscribe(this.onValidationChange,this)},Bind:function(a){var d=a.GetConfig(CFG_VALIDATION_OPTION);if($$CM.isArray(d)&&d.length>0){var b=$A();d.each(function(e){b.push(this._validationDS.find(function(f){return e==f.ID}))},this);this._ddlValidation.bindList(b,-1,"No Validation");this._ddlValidation.SetEnabled(true);var c=a.GetConfig(CFG_EVALUATOR);if(a.IsTypeOf(CLS_CUSTOMFIELD)&&a.GetConfig(CFG_CUSTOM_FIELD_TYPE_FILTER)==FW.Enums.CustomFieldProperty.NoOptions){FW.Data.CustomForms.Get("CustomFieldDefinitions",{FieldID:a.GetConfig(CFG_CUSTOM_FIELD_ID)}).each(function(e){if(e.DataType==FW.Enums.DataType.Integer||e.DataType==FW.Enums.DataType.Decimal){c=FW.Enums.Evaluator.Number;this._ddlValidation.SetEnabled(false)}},this)}if($$CM.isNull(c)||isNaN(c)){c=0}this._ddlValidation.Bind(Framework.Enums.Evaluator.GetName(c).toUpperCase());this._cbRequired.Bind(a.GetConfig(CFG_EVALUATOR_IS_REQUIRED));this.onValidationChange()}else{this._ddlValidation.bindList($A(),-1,"No Validation");this._divRequired.Hide()}},GetData:function(){var a=this._ddlValidation.GetData();a=a[0]+a.substr(1).toLowerCase();return{EvaluatorID:Framework.Enums.Evaluator.GetId(a),IsRequired:(this._divRequired.IsVisible()==true)?this._cbRequired.GetData():a=="Select"||a=="Multiselect"||a=="Group"}},onValidationChange:function(b,a){this._divRequired.Hide();switch(this._ddlValidation.GetData()){case"TEXT":case"NUMBER":case"EMAIL":case"DATE":case"URL":this._divRequired.Show();break}}});"cm.ui.customforms".namespace();cm.ui.customforms.CustomFormObject=Class.create({Guid:null,Layout:{X:0,Y:0,W:0,H:0},Conditions:$A(),IsApplicable:true,initialize:function(a){if($$CM.isNull(a)){throw"CustomFormObject requires a valid object control"}for(var b in a){this[b]=a[b]}this.Layout={X:0,Y:0,W:0,H:0};this.Conditions=$A();this.IsApplicable=true;this.AddClassName("cmFrameworkObject");$$E(a).CM.Set(this);if(!$$CM.isNull(a.ChangeEvent)){this.ChangeEvent=new cm.event();a.ChangeEvent.subscribe(this.onBaseObjectChange,this)}delete a},GetParent:function(){if(!$$CM.isNull(this._owner)&&this._owner!=this._master){return this._owner.Parent}},GetApplicableState:function(){return(this.IsApplicable==true&&($$CM.isNull(this.GetParent())||this.GetParent().GetApplicableState()==true))},IsValidConditional:function(){if(this.GetConfig(CFG_CUSTOM_FIELD_ID)>0){var a=FW.Data.CustomForms.GetFirst("CustomFieldDefinitions",{FieldID:this.GetConfig(CFG_CUSTOM_FIELD_ID)});return(!$$CM.isNull(a)&&$$CM.isArray(a.Options)&&(a.Options.length>0))}else{return($$CM.isArray(this.GetConfig(CFG_LIST))&&this.GetConfig(CFG_LIST).length>0)}},Duplicate:function(){var b=new cm.ui.customforms.CustomFormObject(FW.Object.Render(this.ClassID,this.ConfigOptions));if(b.IsValid()==true){this.ConfigOptions.each(function(c){var d=c.ID;var e=this.GetConfig(d);b.SetConfig(d,e)},this);b.Layout=$$CM.deepClone(this.Layout);b.Conditions=$$CM.deepClone(this.Conditions);b._master=this._master;var a=this.Children;a.each(function(c){b.AddChildObject(c.Duplicate())},this);b.Reload()}return b},GetObjectData:function(){return{ClassID:this.ClassID,ConfigOptions:this.GetConfigOptionData(),Conditions:this.Conditions,Guid:this.Guid,Layout:this.Layout,Children:this.GetChildObjectData()}},GetConfigOptionData:function(){var b=FW.Object.GetClass(this.ClassID);var a=this.ConfigOptions.reject(function(d){var c=b.ConfigOptions.find(function(e){return e.ID==d.ID},this);return($$CM.isNull(c)||c.Static==true)},this);return this.getConfigOptions(a)},getConfigOptions:function(a){return a},GetChildObjectData:function(){var a=$A();this.Children.each(function(b){a.push(b.GetObjectData())},this);return a},GetName:function(){if(!$$CM.isEmpty(this.GetConfig(CFG_NAME))){return this.GetConfig(CFG_NAME)}else{if(!$$CM.isEmpty(this.GetConfig(CFG_LABEL))){return this.GetConfig(CFG_LABEL)}}},onBaseObjectChange:function(b,a){this.ChangeEvent.fire(this,a)},onAttached:function(){}});"cm.ui.customforms.fe".namespace();$$__FE__GROUP=new cm.ui.Hashtable();$$FE=function(e,c,a,d){if($$CM.isObject(c)){if($$CM.isNull(c)){c=cm.ui.customforms.fe.Default}c=new cm.ui.customforms.fe.FieldEditor(e,null,a,c,d)}else{var b=cm.ui.customforms.fe[c];if($$CM.isNull(b)){$$CMD.Alert({title:"Missing Field Editor Definition",message:"No such field editor"})}else{c=new cm.ui.customforms.fe.FieldEditor(e,null,a,cm.ui.customforms.fe[c],d)}}return c},cm.ui.customforms.fe.FieldEditor=Class.create(cm.ui.Control,{_fe:null,_group:null,initialize:function($super,g,e,a,b,d){$super(e,a);this._src=g;this._fe=b;this._group=d;for(var f in b){if(f!="Get"&&f!="Set"&&f!="UI"){this[f]=b[f]}}this._fe.UI.call(this);if(!$$CM.isNull(d)){var c=$$__FE__GROUP.get(d);if($$CM.isNull(c)){c=$A()}c.push(this);$$__FE__GROUP.put(d,c)}},Bind:function(a){this._fe.Set.call(this,a)},GetData:function(a){return this._fe.Get.call(this)},Broadcast:function(a,c){var b=$$__FE__GROUP.get(this._group);if(!$$CM.isNull(b)){b.each(function(d){if($$CM.isNull(c)){d.Listen(a)}else{if(!$$CM.isNull(c)&&d.getListenerKeys().indexOf(c)>=0){d.Listen(a)}}},this)}},Listen:function(a){},getListenerKeys:function(){return $A()}});cm.ui.customforms.fe.Default={Get:function(){return this._input.GetData()},Set:function(a){this._input.Bind(a)},UI:function(){this._input=new $$FTXT();this.AddChild(this._input)}};cm.ui.customforms.fe.HeaderType={Get:function(){return parseInt(this._input.GetData())},Set:function(a){this._input.Bind(a)},UI:function(){this._input=new $$FDDL(null,{dataSource:$A([{ID:0,Name:"Normal"},{ID:6,Name:"Header 1"},{ID:5,Name:"Header 2"},{ID:4,Name:"Header 3"},{ID:3,Name:"Header 4"},{ID:2,Name:"Header 5"},{ID:1,Name:"Header 6"}]),spanWidth:0});this._input.GetInputControl().AddClassName("w100prct");this.AddChild(this._input)}};cm.ui.customforms.fe.BoundName={Get:function(){return this._input.GetData()},Set:function(a){this._input.Bind(a)},UI:function(){this._input=new $$FTXT();this.AddChild(this._input);this._btnClear=new $$BTN(null,{text:"X",classNames:"cmCancelDeleteButton bnBtn"});this._btnClear.ClickEvent.subscribe(this.onClearClicked,this);this.AddChild(this._btnClear)},Listen:function(a){if($$CM.isEmpty(this._input.GetData())||a.Old==this._input.GetData()){this.Bind(a.New)}},getListenerKeys:function(){return $A(["customFieldName"])},onClearClicked:function(b,a){this._input.Bind()}};cm.ui.customforms.fe.CustomText={Get:function(){return this._input.GetData()},Set:function(a){this._input.Bind(a)},UI:function(){this.AddClassName("cmCustomText");this._input=new $$FTXA(null,{inputWidth:300,rows:8});this.AddChild(this._input);this._input.AddKeyDownListener();this._input.KeyDownEvent.subscribe(this.onInputEnterPressed,this)},onInputEnterPressed:function(b,a){a.event.stopPropagation()}};cm.ui.customforms.fe.Number={Get:function(){return parseInt(this._input.GetData())},Set:function(a){this._input.Bind(a)},UI:function(){this._input=new $$FTXT();this._input.GetInputControl().SetAttribute("type","number");this.AddChild(this._input)}};cm.ui.customforms.fe.Boolean={Get:function(){return this._input.GetData()},Set:function(a){this._input.Bind(a==true)},UI:function(){this._input=new $$FCB();this.AddChild(this._input)}};cm.ui.customforms.fe.Array={Get:function(){var a=$A();this._rows.each(function(b){a.push(b.Field.GetData())},this);return a},Set:function(a){this._rows.each(function(b){this.RemoveChildControl(b)},this);this._rows=$A();if($$CM.isArray(a)){a.each(function(b){this.createField(b)},this)}else{if(!$$CM.isEmpty(a)){this.createField(a)}}},UI:function(){this.AddClassName("w215px");this._rows=$A();this._btn=new $$BTN(null,{text:"+ Add Value",classNames:"w100prct cmGoButton cmFloatLeft"});this.AddChild(this._btn);this._btn.ClickEvent.subscribe(this.onBtnClicked,this)},onBtnClicked:function(b,a){this.createField()},onDeleteClicked:function(b,a){this._rows.remove(b.Row);this.RemoveChildControl(b.Row)},createField:function(d){var b=$$P.div(null,null,{classNames:"w100prct cmFloatLeft cmCenter"});var c=new $$FTXT(null,{spanWidth:0,classNames:"cmFloatLeft w185px"});var a=new $$BTN(null,{text:"X",classNames:"cmFloatLeft cmCancelDeleteButton"});a.AssignStyle("margin","4px 2px");a.ClickEvent.subscribe(this.onDeleteClicked,this);a.Row=b;b.Field=c;b.AddChild(a);b.AddChild(c);this.AddChild(b);if(!$$CM.isNull(d)){c.Bind(d)}this._rows.push(b)}};cm.ui.customforms.fe.SimpleDatasource={Get:function(){var a=$A();this._rows.each(function(b){a.push({ID:b.Field.GetData(),Name:b.Field.GetData()})},this);return a},Set:function(a){this._rows.each(function(b){this.RemoveChildControl(b)},this);this._rows=$A();if($$CM.isArray(a)){a.each(function(b){if($$CM.isObject(b)){this.createField(b.ID)}else{this.createField(b)}},this)}else{if(!$$CM.isEmpty(a)){this.createField(a)}}},UI:function(){this.AddClassName("w215px");this._rows=$A();this._btn=new $$BTN(null,{text:"+ Add Value",classNames:"w100prct cmGoButton cmFloatLeft"});this.AddChild(this._btn);this._btn.ClickEvent.subscribe(this.onBtnClicked,this)},onBtnClicked:function(b,a){this.createField()},onDeleteClicked:function(b,a){this._rows.remove(b.Row);this.RemoveChildControl(b.Row)},createField:function(d){var b=$$P.div(null,null,{classNames:"w100prct cmFloatLeft cmCenter"});var c=new $$FTXT(null,{spanWidth:0,classNames:"cmFloatLeft w185px"});if(!$$CM.isNull(this.GetConfigOptions().evaluator)){c.Validator.addEvaluator(this.GetConfigOptions().evaluator)}var a=new $$BTN(null,{text:"X",classNames:"cmFloatLeft cmCancelDeleteButton"});a.AssignStyle("margin","4px 2px");a.ClickEvent.subscribe(this.onDeleteClicked,this);a.Row=b;b.Field=c;b.AddChild(a);b.AddChild(c);this.AddChild(b);if(!$$CM.isNull(d)){c.Bind(d)}this._rows.push(b);c.Focus()}};cm.ui.customforms.fe.ValidationParameter={Get:function(){var a=$A();this._rows.each(function(c){var b=c.Field.GetData();if(a.indexOf(b)<0){a.push(b)}},this);return a},Set:function(a){this._rows.each(function(b){this.RemoveChildControl(b)},this);this._rows=$A();if($$CM.isArray(a)){a.each(function(b){this.createField(b)},this)}},UI:function(){this._ds=$A([{ID:"TEXT",Name:"TEXT"},{ID:"NUMBER",Name:"NUMBER"},{ID:"EMAIL",Name:"EMAIL"},{ID:"URL",Name:"URL"},{ID:"DATE",Name:"DATE"},{ID:"SELECT",Name:"SELECT"},{ID:"GROUP",Name:"GROUP"},{ID:"MULTISELECT",Name:"MULTISELECT"},{ID:"BOOL",Name:"BOOL"}]);this._rows=$A();this._btn=new $$BTN(null,{text:"+ Add Validation Option",classNames:"w100prct cmGoButton cmFloatLeft"});this.AddChild(this._btn);this._btn.ClickEvent.subscribe(this.onBtnClicked,this)},onBtnClicked:function(b,a){this.createField()},onDeleteClicked:function(b,a){this._rows.remove(b.Row);this.RemoveChildControl(b.Row)},createField:function(d){var c=$$P.div(null,null,{classNames:"w100prct cmFloatLeft cmCenter"});var b=new $$FDDL(null,{dataSource:this._ds,spanWidth:0,classNames:"cmFloatLeft w185px"});var a=new $$BTN(null,{text:"X",classNames:"cmFloatLeft cmCancelDeleteButton"});a.AssignStyle("margin","4px 2px");a.ClickEvent.subscribe(this.onDeleteClicked,this);a.Row=c;c.Field=b;c.AddChild(a);c.AddChild(b);this.AddChild(c);if(!$$CM.isNull(d)){b.Bind(d)}this._rows.push(c)}};cm.ui.customforms.fe.ClassSelector={Get:function(){return this._ddl.GetData()},Set:function(a){this._ddl.Bind(a)},UI:function(){this._ddl=new $$FDDL(null,{dataSource:FW.Object.ClassDefinitions});this.AddChild(this._ddl);this._ddl.ChangeEvent.subscribe(this.onDDLChange,this)},onDDLChange:function(){this.Broadcast(this._ddl.GetData(),"classSelector")}};cm.ui.customforms.fe.NameValidator=Class.create(cm.validation.Evaluator,{_fieldID:null,_fields:null,getType:function(){return"CUSTOM_FIELD_NAME"},initialize:function($super,a){$super(a);this._fields=a.existingFields;this._fieldID=$$CM.isNull(a.fieldID)?0:a.fieldID},evaluate:function(a){var b=$$CM.isNull(a)?"":a.trim().toLowerCase();if(b!==""){var c=this._fields.find(function(d){return(d.Name.toLowerCase()==b)});if(c&&this._fieldID!=c.FieldID){this._result.AddError("Duplicate Field Name. Name cannot be the same as another field's.")}}return this._result},configureDefaultOptions:function(){return new cm.validation.ValidationConfigOptions()}}),cm.ui.customforms.fe.CustomFieldSelector={COL_FIELD:{Key:"Field",Name:"Field"},COL_TYPE:{Key:"Type",Name:"Type"},COL_SEASONAL:{Key:"Seasonal",Name:"Seasonal"},COL_ACTIVE:{Key:"Active",Name:"Active"},COL_EDIT:{Key:"Edit",Name:"",ClassNames:"w40px"},DS_OBJECTTYPEFLAG:$$CM.IsAdultFamilyRegistration()?$A([{ID:2,Name:"Alumni"},{ID:4,Name:"Staff"},{ID:8,Name:"Camper"},{ID:32,Name:"Adult"}]):$A([{ID:2,Name:"Alumni"},{ID:4,Name:"Staff"},{ID:8,Name:"Camper"}]),Get:function(){return parseInt(this._ddl.GetData())},Set:function(a){this._ddl.Bind(a);this._curData=this._ddl.getSelectedText()},UI:function(){this._fieldTypes=FW.Data.CustomForms.GetFirst("CurrentFieldTypes");this._fieldTypeContext=FW.Data.CustomForms.GetFirst("CurrentSection").FieldTypes;this._dao=new cm.dao.CustomForms.DAO();FW.Data.CustomForms.Subscribe("CustomFieldDefinitions",this.onCustomFieldsRetrieved,this);this._dsYesNo=$A([{ID:true,Name:"Yes"},{ID:false,Name:"No"}]);this._tblCols=$A([this.COL_FIELD,this.COL_TYPE,this.COL_SEASONAL,this.COL_ACTIVE,this.COL_EDIT]);this._ddl=new $$FDDL();this._ddl.ChangeEvent.subscribe(this.onDDLChanged,this);this.AddChild(this._ddl);this._editBtn=new $$BTN(null,{text:"+",classNames:"cmFloatRight cmGoButton mr20px mt5px"});this._editBtn.ClickEvent.subscribe(this.onEditClicked,this);this.AddChild(this._editBtn);this.makeFieldListEditDialog();this.makeFieldEditDialog();this._rblFilter.Bind(this._fieldTypeContext);this.updateFieldDDL()},makeFieldListEditDialog:function(){this._cfEditDialog=new cm.ui.dialog.ModalDialog("cfEditDialog",{title:"Custom Fields",width:800,height:600});this.AddChild(this._cfEditDialog);this._btnNewField=new $$BTN(null,{text:"Add Custom Field",classNames:"cmGoButton"});this._btnNewField.ClickEvent.subscribe(this.onNewFieldClicked,this);this._cfEditDialog.AddChild(this._btnNewField);this._rblFilter=new $$FSRBL(null,{legendLabel:"Show Fields For:",dataSource:this.DS_OBJECTTYPEFLAG,classNames:"cmFloatRight mr10px",legendCssClass:"cmFilterLegend"});this._rblFilter.AddChangeListener();this._rblFilter.ChangeEvent.subscribe(this.onTypeFilterChange,this);this._cfEditDialog.AddChild(this._rblFilter);this._tblFields=new $$DTBL(null,{cols:this._tblCols});this._cfEditDialog.AddChild(this._tblFields)},updateFieldDDL:function(){var f=this._ddl.GetData();var e=(this._fieldTypes>0)?this._fieldTypes:this._fieldTypeContext;var d=null;if(!$$CM.isNull(this._src)){var d=this._src.GetConfig(CFG_CUSTOM_FIELD_TYPE_FILTER)}var c=FW.Enums.CustomFieldProperty;var b=$A();if(!$$CM.isNull(d)&&d!=c.GetId("Undefined")){switch(d){case c.GetId("NoOptions"):b=FW.Data.Get("NoOptions","CustomFieldCache");break;case c.GetId("Options"):b=FW.Data.Get("Options","CustomFieldCache");break;case c.GetId("Multiselect"):b=FW.Data.Get("Multiselect","CustomFieldCache");break}}else{b=FW.Data.Convert("CustomFieldDefinitions","CustomForms",{FieldID:"ID",Name:"Name",ObjectType:"ObjectType"})}this._ddl.GetInputControl().DestroyChildControls(false);this._ddl.bindList($A(),-1,"Select one");var a=FW.Data.Get("CustomFieldDatasources","CustomFieldCache",function(g){return FW.Enums.ObjectTypeFlag.TestFlag(e,g.Flag)}).sort(function(g,h){return g.Name-h.Name});a.each(function(g){if(g[c.GetName(d)].ChildControls().length>0){this._ddl.GetInputControl().AddChild(g[c.GetName(d)])}},this);this._ddl.Bind(f)},updateFieldListEditDialog:function(){this._cfDS=$A();var c=this._rblFilter.GetData();this._cfArray=FW.Data.CustomForms.Get("CustomFieldDefinitions",function(e){return(e.ObjectType&c)==c});if($$CM.isNull(this._cfArray)){this._cfArray=$A()}var b=null;if(!$$CM.isNull(this._src)){var b=this._src.GetConfig(CFG_CUSTOM_FIELD_TYPE_FILTER)}var a=FW.Enums.CustomFieldProperty;this._cfArray.each(function(e){if(!$$CM.isNull(b)&&b!=a.GetId("Undefined")){if(b==a.GetId("NoOptions")&&e.Options.length<=0&&e.IsArray==false){this._cfDS.push({ID:e.FieldID,Name:e.Name})}else{if(b==a.GetId("Options")&&e.Options.length>0&&e.IsArray==false){this._cfDS.push({ID:e.FieldID,Name:e.Name})}else{if(b==a.GetId("Multiselect")&&e.Options.length>0&&e.IsArray==true){this._cfDS.push({ID:e.FieldID,Name:e.Name})}}}}else{this._cfDS.push({ID:e.FieldID,Name:e.Name})}},this);this._tblFields.Clear();this._cfDS.sort(function(e,f){if(e.Name<f.Name){return -1}if(e.Name>f.Name){return 1}return 0});this._cfDS.each(function(e){FW.Data.CustomForms.Get("CustomFieldDefinitions",{FieldID:e.ID}).each(function(g){var f=new $$BTN(null,{text:"Edit",classNames:"cmEditButton"});f.FieldID=g.FieldID;f.ClickEvent.subscribe(this.onFieldEditButtonClicked,this);if(g.DataType==FW.Enums.DataType.Boolean){f.SetEnabled(false)}this._tblFields.AddRow(g.FieldID);this._tblFields.SetCell(g.FieldID,this.COL_FIELD.Key,g.Name);this._tblFields.SetCell(g.FieldID,this.COL_TYPE.Key,FW.Enums.DataType[g.DataType].replace("Boolean","Yes/No"));this._tblFields.SetCell(g.FieldID,this.COL_SEASONAL.Key,(g.IsSeasonal==true)?"Yes":"No");this._tblFields.SetCell(g.FieldID,this.COL_ACTIVE.Key,(g.Active==true)?"Yes":"No");this._tblFields.SetCell(g.FieldID,this.COL_EDIT.Key,f)},this)},this);this._filterType=b;var d=this._ddlFieldType.GetData();if(this._filterType==a.GetId("Multiselect")){this._ddlFieldType.bindList($A([{ID:"1",Name:"String (alphanumeric text)"}]),-1,"[Select Data Type]")}else{this._ddlFieldType.bindList(this._dsTypes,-1,"[Select Data Type]")}this._ddlFieldType.Bind(d)},makeFieldEditDialog:function(){this._cfFieldEditDialog=new cm.ui.dialog.ModalDialog("cfFieldEditDialog",{title:"Edit Custom Field",width:380,classNames:"cmCustomFieldEditDialog cmScrollY max_h600px"});this.AddChild(this._cfFieldEditDialog);this._dsTypes=$A([{ID:"1",Name:"String (alphanumeric text)"},{ID:"2",Name:"Integer (number)"},{ID:"3",Name:"Decimal (currency, etc.)"}]);this._cblObjectTypeFlags=new $$FSCBL(null,{legendLabel:"Relevant to",dataSource:this.DS_OBJECTTYPEFLAG,classNames:"w95prct m10px cmBorderBox",stretch:true});this._cfFieldEditDialog.AddChild(this._cblObjectTypeFlags);this._txtFieldName=new $$FTXT(null,{label:"Field Name",inputWidth:200,classNames:"cmFloatLeft mt5px ml10px"});this._cfFieldEditDialog.AddChild(this._txtFieldName);this._ddlFieldType=new $$FDDL(null,{label:"Data Type",defaultText:"[Select Data Type]",inputWidth:204,classNames:"cmFloatLeft mt5px",dataSource:this._dsTypes});this._ddlFieldType.AddClassName("ml10px");this._ddlFieldType.ChangeEvent.subscribe(this.onDataTypeChanged,this);this._cfFieldEditDialog.AddChild(this._ddlFieldType);this._txtDefaultValue=new $$FTXT(null,{label:"Default Value",inputWidth:200,classNames:"cmFloatLeft mt5px ml10px"});this._cfFieldEditDialog.AddChild(this._txtDefaultValue);this._spanOptions=$$P.span(null,"<b>Options</b>",{classNames:"cmFloatLeft w80px m10px"});this._cfFieldEditDialog.AddChild(this._spanOptions);this._spanOptions.Hide();this._feOptions=new $$FE(this._src,cm.ui.customforms.fe.SimpleDatasource,{classNames:"cmFloatLeft ml20px mt10px"});this._feOptions.Validator.addEvaluator($$EVAL.MULTISELECT({DisplayName:"Options",ErrorMessage:"Field must contain at least one selectable option",RequiredLength:1}));this._cfFieldEditDialog.AddChild(this._feOptions);this._feOptions.Hide();this._rblSeasonal=new $$FSRBL(null,{legendLabel:"Seasonal",classNames:"w250px cmFloatLeft mt5px ml10px",dataSource:this._dsYesNo});this._cfFieldEditDialog.AddChild(this._rblSeasonal);this._rblActive=new $$FSRBL(null,{legendLabel:"Active",classNames:"w250px cmFloatLeft mt5px ml10px mb10px",dataSource:this._dsYesNo});this._cfFieldEditDialog.AddChild(this._rblActive);this._PCIWarningBox=$$P.div("PCIWarningBox");this._PCIWarningBox.UpdateInnerHtml("Custom Fields should not be used to collect financial information including, Bank Account Numbers, Routing Numbers, Credit Card Information and other sensitive information.  The Custom Fields system was not designed to be PCI Compliant, so failing to adhere to these instructions may put your organization at significant risk.");this._PCIWarningBox.AddClassName("cmAlert");this._PCIWarningBox.SetAttribute("style","clear: both; margin: 0 15px 5px 15px;");this._cfFieldEditDialog.AddChild(this._PCIWarningBox);this._btnCancel=new $$BTN(null,{text:"Cancel",classNames:"m10px cmFloatLeft cmClear cmCancelDeleteButton"});this._btnCancel.ClickEvent.subscribe(this.onFieldEditCancelBtnClicked,this);this._cfFieldEditDialog.AddChild(this._btnCancel);this._btnUpdate=new $$BTN(null,{text:"Save Field",classNames:"m10px cmFloatRight cmGoButton"});this._btnUpdate.ClickEvent.subscribe(this.onFieldEditUpdateBtnClicked,this);this._cfFieldEditDialog.AddChild(this._btnUpdate)},getOptionEvaluator:function(a){var b=FW.Enums.DataType;switch(a){case b.GetId("String"):return $$EVAL.TEXT({IsRequired:true});case b.GetId("Integer"):return $$EVAL.NUMBER({IsRequired:true,DataType:"INTEGER"});case b.GetId("Decimal"):return $$EVAL.NUMBER({IsRequired:true,DataType:"FLOAT"});case b.GetId("Boolean"):return $$EVAL.BOOLEAN({IsRequired:true})}},toObjectTypeArray:function(d){var a=$A();var b=Number(d);if(b>0){for(var c=b;c>=1;c/=2){if((d&c)==c){a.push(c)}}}return a},toObjectTypeFlag:function(a){var b=0;a.each(function(c){b+=parseInt(c)},this);return b},onDDLChanged:function(b,a){this.Broadcast({Old:this._curData,New:this._ddl.getSelectedText()},"customFieldName");this._curData=this._ddl.getSelectedText()},onEditClicked:function(c,a){var b=this._ddl.GetData();this._currentField=FW.Data.CustomForms.GetFirst("CustomFieldDefinitions",{FieldID:b});this.updateFieldListEditDialog();this._cfEditDialog.Show()},onNewFieldClicked:function(c,a){this._currentFieldID=0;this._txtFieldName.Bind(null);this._ddlFieldType.SetEnabled(true);this._ddlFieldType.Bind(null);this._txtDefaultValue.Bind(null);this._txtDefaultValue.SetEnabled(false);this._rblActive.Bind(true);this._rblActive.SetEnabled(false);this._rblSeasonal.Bind(true);this._rblSeasonal.SetEnabled(true);var b=(!$$CM.isNull(this._currentField))?this._currentField.ObjectType:this._fieldTypeContext;if(this._fieldTypeContext==this._rblFilter.GetData()){this._cblObjectTypeFlags.Bind($$CM.toBitFlagArray(b))}else{this._cblObjectTypeFlags.Bind(null)}this.onDataTypeChanged();this._feOptions.Bind($A());this._cfFieldEditDialog.Show();this._txtFieldName.Validator.RemoveAll();this._ddlFieldType.Validator.RemoveAll();this._cblObjectTypeFlags.Validator.RemoveAll();this._txtFieldName.Validator.addEvaluator($$EVAL.TEXT({IsRequired:true}));this._txtFieldName.Validator.addEvaluator(new cm.ui.customforms.fe.NameValidator({existingFields:FW.Data.CustomForms.CustomFieldDefinitions}));this._ddlFieldType.Validator.addEvaluator($$EVAL.SELECT({IsRequired:true}));this._cblObjectTypeFlags.Validator.addEvaluator($$EVAL.MULTISELECT({IsRequired:true}))},onFieldEditButtonClicked:function(c,a){var b=c.FieldID;FW.Data.CustomForms.Get("CustomFieldDefinitions",{FieldID:b}).each(function(d){this._currentFieldID=b;this._txtFieldName.Bind(d.Name);this._ddlFieldType.Bind(d.DataType);this._rblSeasonal.Bind(d.IsSeasonal);this._rblActive.Bind(d.Active);this.onDataTypeChanged();var f=FW.Enums.CustomFieldProperty;var g=FW.Enums.DataType;this._feOptions.GetConfigOptions().evaluator=this.getOptionEvaluator(d.DataType);if(d.DataType!=g.GetId("Boolean")&&(this._filterType==f.GetId("Options")||this._filterType==f.GetId("Multiselect"))){this._spanOptions.Show();this._feOptions.Show();this._feOptions.Bind(d.Options)}else{this._spanOptions.Hide();this._feOptions.Hide();this._feOptions.Bind($A())}var e=d.ExtendedProperties.find(function(i){return i.Key=="defaultValue"});if(!$$CM.isNull(e)){if(d.DataType==FW.Enums.DataType.Boolean){this._txtDefaultValue.Bind((e.Value=="True")?true:false)}else{this._txtDefaultValue.Bind(e.Value)}}this._txtDefaultValue.SetEnabled(true);this._ddlFieldType.SetEnabled(false);this._rblActive.SetEnabled(true);this._rblSeasonal.SetEnabled(false);var h=(!$$CM.isNull(this._currentField))?this._currentField.ObjectType:this._fieldTypeContext;this._cblObjectTypeFlags.Bind($$CM.toBitFlagArray(d.ObjectType));this._cfFieldEditDialog.Show();this._txtFieldName.Validator.RemoveAll();this._ddlFieldType.Validator.RemoveAll();this._cblObjectTypeFlags.Validator.RemoveAll();this._txtFieldName.Validator.addEvaluator($$EVAL.TEXT({IsRequired:true}));this._txtFieldName.Validator.addEvaluator(new cm.ui.customforms.fe.NameValidator({existingFields:FW.Data.CustomForms.CustomFieldDefinitions,fieldID:b}));this._ddlFieldType.Validator.addEvaluator($$EVAL.SELECT({IsRequired:true}));this._cblObjectTypeFlags.Validator.addEvaluator($$EVAL.MULTISELECT({IsRequired:true}))},this)},onTypeFilterChange:function(b,a){this.updateFieldListEditDialog()},onFieldEditCancelBtnClicked:function(b,a){this._cfFieldEditDialog.Hide()},onFieldEditUpdateBtnClicked:function(i,a){var h=this._cfFieldEditDialog.Validator.validate(true);if(h.IsValid()==true){var c=this._txtDefaultValue.GetData();var b=this._ddlFieldType.GetData();if(b==FW.Enums.DataType.Boolean){c=(c=="true")?"True":"False"}var d=FW.Enums.CustomFieldProperty;var g=$A();this._feOptions.GetData().each(function(j){g.push(j.ID)},this);var e={FieldID:this._currentFieldID,Name:this._txtFieldName.GetData(),DataType:this._ddlFieldType.GetData(),IsSeasonal:this._rblSeasonal.GetData(),Active:this._rblActive.GetData(),ExtendedProperties:($$CM.isEmpty(c))?null:$A([{Key:"defaultValue",Value:c}]),ObjectType:$$CM.toBitFlag(this._cblObjectTypeFlags.GetData()),IsArray:(this._filterType==d.GetId("Multiselect"))?true:false,Options:g};var f=this;DAO.CustomForms.CustomFieldModify({field:e,context:this._fieldTypeContext},{onSuccess:function(){f._cfFieldEditDialog.Hide()}})}},onCustomFieldsRetrieved:function(b,a){this.updateFieldDDL();this.updateFieldListEditDialog()},onDataTypeChanged:function(e,a){var f=this._ddlFieldType.GetData();var b=FW.Enums.CustomFieldProperty;var c=FW.Enums.DataType;this._cfFieldEditDialog.RemoveChildControl(this._txtDefaultValue);this._spanOptions.Hide();this._feOptions.Hide();switch(f){case"7":this._txtDefaultValue=new $$FSRBL(null,{legendLabel:"Default Value",dataSource:this._dsYesNo,classNames:"w250px cmFloatLeft mt5px ml10px"});this._txtDefaultValue.Bind(false);break;case"1":case"2":case"3":if(this._filterType==b.GetId("Options")||this._filterType==b.GetId("Multiselect")){this._feOptions.Show();this._spanOptions.Show()}default:this._txtDefaultValue=new $$FTXT(null,{label:"Default Value",inputWidth:200,classNames:"cmFloatLeft mt5px ml10px"});break}var d=this._feOptions.GetData();this._feOptions.GetConfigOptions().evaluator=this.getOptionEvaluator(parseInt(f));this._feOptions.Bind(d);this._cfFieldEditDialog.AddChild(this._txtDefaultValue,$$E(this._rblSeasonal))}};cm.ui.customforms.fe.CustomFieldConfigEditor={Get:function(){var a=$A();this._data.each(function(b){if(b.ConfigOption.Static!=true){a.push({ID:b.ConfigOption.ID,Value:b.Field.GetData()})}},this);return{ClassID:this._classID,ConfigOptions:a}},Set:function(b){this._div.DestroyChildControls();var c=$A();if(!$$CM.isNull(b)){this._classID=b.ClassID;var a=FW.Object.GetClass(this._classID);b.ConfigOptions.each(function(e){var d=a.ConfigOptions.find(function(j){return j.ID==e.ID});if(!$$CM.isNull(d)&&d.Static!=true&&(this.GetConfigOptions().showAll==true||d.ID!=107)&&(d.IsEditable==true||this.GetConfigOptions().showAll==true)){var h=!$$CM.isEmpty(d.DisplayName)?d.DisplayName:FW.Object.GetConfigOptionDefinition(d.ID).Name;var f=$$P.div(null,null,{classNames:"w100prct cmFloatLeft"});var i=$$P.span(null,h,{classNames:"cmFloatLeft w120px m5px"});var g=$$FE(this._src,d.FieldEditor,null,this._group);g.AddClassName("cmFloatLeft w200px");g.SetEnabled(d.IsEnabled||this.GetConfigOptions().showAll==true);g.Bind(e.Value);f.AddChild(i);f.AddChild(g);c.push({Div:f,ConfigOption:d,Field:g})}},this);c.sort(function(d,e){return d.ConfigOption.SortOrder-e.ConfigOption.SortOrder});c.each(function(d){this._div.AddChild(d.Div)},this)}this._data=c},UI:function(){this._line=$$P.hr(null,{classNames:"cmConfigEditor"});this.AddChild(this._line);this._div=$$P.div(null,null,{classNames:"cmConfigEditor"});this.AddChild(this._div);this._dao=new cm.dao.Framework.DAO();this._data=$A()},Listen:function(b){var a=FW.Object.GetClass(b);if(!$$CM.isNull(a)){this.Bind({ClassID:a.ID,ConfigOptions:a.ConfigOptions})}},getListenerKeys:function(){return $A(["classSelector"])}};cm.ui.customforms.fe.CustomFieldFilterSelector={Get:function(){return this._cbl.GetData()},Set:function(a){this._cbl.Bind(a)},UI:function(){this._dao=new cm.dao.CustomForms.DAO();this._cbl=new $$FSRBL(null,{dataSource:FW.Enums.CustomFieldProperty.GetArray(),classNames:"cmCustomFieldFilters"});this.AddChild(this._cbl)}};"cm.ui.customforms".namespace();cm.ui.customforms.PopupTipConfigOptions=Class.create(cm.ConfigOptions,{tip:"Default Tip"});cm.ui.customforms.PopupTip=Class.create(cm.ui.Control,{initializeUIElements:function(){this.AddClassName("cmPopupTip");this._icon=$$P.div(null,"?");this.AddChild(this._icon);this._tip=$$P.span(null,this.GetConfigOptions().tip);this.AddChild(this._tip);this._tip.Hide()},createEvents:function(){this._icon.AddMouseEnterListener();this._icon.AddMouseLeaveListener()},wireEvents:function(){this._icon.MouseEnterEvent.subscribe(this.onHover,this);this._icon.MouseLeaveEvent.subscribe(this.onExit,this)},configureDefaultOptions:function(){return new cm.ui.customforms.PopupTipConfigOptions()},onHover:function(b,a){this._tip.Show()},onExit:function(b,a){this._tip.Hide()}});