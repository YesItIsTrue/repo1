<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD>
    <META NAME="AUTHOR" CONTENT="Trae Luttrell">
    <TITLE>Merit Badge Workshop 2</TITLE>
    <META NAME='VERSION' CONTENT='1.21'>
    <META NAME='COPYRIGHT' CONTENT='Solsource'>
    <META NAME='CREATE_DATE' CONTENT="01/Sep/2017">
    <META NAME='LAST_UPDATED' CONTENT="09/Sep/2017">   
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" type="text/css" href="http://www.w3schools.com/lib/w3.css"> 
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> 
    
<SCRIPT LANGUAGE="SpeedScript">
CREATE WIDGET-POOL.
</SCRIPT>

<style>
/***** ****** W3CSS THEME FOR #66A97C ***** *****/
.w3-theme-l5 {color:#000 !important; background-color:#f6faf7 !important}
.w3-theme-l4 {color:#000 !important; background-color:#e0eee5 !important}
.w3-theme-l3 {color:#000 !important; background-color:#c2dccb !important}
.w3-theme-l2 {color:#000 !important; background-color:#a3cbb0 !important}
.w3-theme-l1 {color:#000 !important; background-color:#84ba96 !important}
.w3-theme-d1 {color:#fff !important; background-color:#589c6e !important}
.w3-theme-d2 {color:#fff !important; background-color:#4e8a62 !important}
.w3-theme-d3 {color:#fff !important; background-color:#447956 !important}
.w3-theme-d4 {color:#fff !important; background-color:#3a684a !important}
.w3-theme-d5 {color:#fff !important; background-color:#31563d !important}

.w3-theme-light {color:#000 !important; background-color:#f6faf7 !important}
.w3-theme-dark {color:#fff !important; background-color:#31563d !important}
.w3-theme-action {color:#fff !important; background-color:#31563d !important}

.w3-theme {color:#fff !important; background-color:#66a97c !important}
.w3-text-theme {color:#66a97c !important}
.w3-border-theme {border-color:#66a97c !important}

.w3-hover-theme:hover {color:#fff !important; background-color:#66a97c !important}
.w3-hover-text-theme {color:#66a97c !important}
.w3-hover-border-theme:hover {border-color:#66a97c !important}

.w3-theme-body {color:#000 !important; background-color:#f1f1f1 !important}
.w3-theme-background {color::#000 !important; background-color:#fff !important}
.w3-theme-accent {color:#000 !important; background-color:#874D74 !important}
.w3-hover-theme-accent:hover {color:#000 !important; background-color:#874D74 !important}
.w3-hover-border-theme-accent:hover {color:#000 !important; background-color:#874D74 !important}

</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<!-- we don't need this when we are using different sections for the periods 
<script>

$(document).ready(function(){
    $("input:checkbox").click(function() {
    var numOfThings = $("input:checkbox:checked").length;
if (numOfThings == 2) {
$("input:submit").attr("disabled", false); } else { $("input:submit").attr("disabled", true); }
    });
   
});

$(document).ready(function() {
    $("input:checkbox").click(function() {
        var numOfThings = $("input:checkbox:checked").length;
        if (numOfThings == 2) {
            $("button:submit").attr("disabled", false);
            $("button:submit").removeClass("w3-grey");
            $("button:submit").addClass("w3-theme-l2");
            $("button:submit").css("box-shadow", "");
        } else {
            $("button:submit").attr("disabled", true);
            $("button:submit").removeClass("w3-theme-l2");
            $("button:submit").addClass("w3-grey");
            $("button:submit").css("box-shadow", "none");
        }
    });

});

</script>
 -->
<!-- <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css"> -->

</HEAD>

<body class='ss-background'>

<SCRIPT LANGUAGE="SpeedScript">

  /*------------------------------------------------------------------
    File:
    Description:
    Created:
        
  -----------------------------------------------------------------
    Revision History:
    -----------------
    1.0 - written by TRAE LUTTRELL on 01/Sept/2017. Copied the AMSmeritU.html 
        that was used for the first Merit Badge Workshop 1.
       P.S. I also just found out that while this was supposed to have to eight
        meritbadges, it might only have 5 or 6...
   
    1.2 - written by TRAE LUTTRELL on 08/Sept/2017. 
        Making too many changes to the data processing of the logic to document.        
                    
    1.21 - written by DOUG LUTTRELL on 09/Sep/17.  Taking a crack at this before
            Trae gets to work.  Looks like the only problem left is that it is not
            registering folks for the proper version of a class if there are more
            than one classes taught per day (as is often the case at MBW, etc.). 
            Fixing that issue here and in the include file.  Had to split apart 
            the logic between periods and classes.  Marked by 121.                     
                    
  -------------------------------------------------------------------*/

DEFINE VARIABLE x           AS INTEGER                  NO-UNDO.
DEFINE VARIABLE y           AS INTEGER                  NO-UNDO.
DEFINE VARIABLE act         AS CHARACTER                NO-UNDO.
DEFINE VARIABLE ITmessages   AS LOGICAL INITIAL NO        NO-UNDO.
DEFINE VARIABLE error-message   AS CHARACTER            NO-UNDO.

DEFINE VARIABLE v-lastname      LIKE people_mstr.people_lastname     NO-UNDO. 
DEFINE VARIABLE v-firstname     LIKE people_mstr.people_firstname    NO-UNDO. 
DEFINE VARIABLE v-DOB           LIKE people_mstr.people_DOB     NO-UNDO.
DEFINE VARIABLE v-html-DOB      AS CHARACTER NO-UNDO.
DEFINE VARIABLE v-unit          AS CHARACTER NO-UNDO.
DEFINE VARIABLE v-people_id     AS INTEGER NO-UNDO.
DEFINE VARIABLE v-member        LIKE speop_shadow.speop_lds NO-UNDO.                                        
DEFINE VARIABLE v-troop         LIKE speop_shadow.speop_troop NO-UNDO.                                      
DEFINE VARIABLE v-stake         LIKE speop_shadow.speop_stake NO-UNDO.                                      

DEFINE VARIABLE v-addr_ID       LIKE people_mstr.people_addr_id NO-UNDO.    /** old address ID - need to remove - 1dot1 */
DEFINE VARIABLE v-error         AS LOGICAL NO-UNDO.                                                         
DEFINE VARIABLE v-ran           AS LOGICAL NO-UNDO.                                                         

DEFINE VARIABLE v-created       AS LOGICAL NO-UNDO.                                                         
DEFINE VARIABLE v-updated       AS LOGICAL NO-UNDO.                                                         
DEFINE VARIABLE v-avail         AS LOGICAL NO-UNDO.                                                         
DEFINE VARIABLE v-success       AS LOGICAL NO-UNDO.                                                         

/*/* Meritbadge #1 */ DEFINE VARIABLE seat-Aviation                   AS INTEGER NO-UNDO.*/
/*/* Meritbadge #2 */ DEFINE VARIABLE seat-CitizenshipInTheCommunity  AS INTEGER NO-UNDO.*/
/*/* Meritbadge #3 */ DEFINE VARIABLE seat-CitizenshipInTheNation     AS INTEGER NO-UNDO.*/
/*/* Meritbadge #4 */ DEFINE VARIABLE seat-Engineering                AS INTEGER NO-UNDO.*/
/*/* Meritbadge #5 */ DEFINE VARIABLE seat-Moviemaking                AS INTEGER NO-UNDO.*/ 
/*/* Meritbadge #6 */ DEFINE VARIABLE seat-Dentistry                  AS INTEGER NO-UNDO.*/ 
/*/* Meritbadge #7 */ DEFINE VARIABLE seat-Golf                       AS INTEGER NO-UNDO.*/

/* Meritbadge #1 */ DEFINE VARIABLE v-Aviation                      LIKE MB_mstr.MB_name  NO-UNDO.
/* Meritbadge #2 */ DEFINE VARIABLE v-CitizenshipInTheCommunity     LIKE MB_mstr.MB_name  NO-UNDO.
/* Meritbadge #3 */ DEFINE VARIABLE v-CitizenshipInTheNation        LIKE MB_mstr.MB_name  NO-UNDO.
/* Meritbadge #4 */ DEFINE VARIABLE v-Engineering                   LIKE MB_mstr.MB_name  NO-UNDO.
/* Meritbadge #5 */ DEFINE VARIABLE v-Moviemaking                   LIKE MB_mstr.MB_name  NO-UNDO.
/* Meritbadge #6 */ DEFINE VARIABLE v-Dentistry                     LIKE MB_mstr.MB_name  NO-UNDO.
/* Meritbadge #7 */ DEFINE VARIABLE v-Golf                          LIKE MB_mstr.MB_name  NO-UNDO.
/* Meritbadge #8 */ DEFINE VARIABLE v-Art                           LIKE MB_mstr.MB_name  NO-UNDO.
DEFINE VARIABLE c-MeritBadges       AS INTEGER NO-UNDO.
DEFINE VARIABLE v-badgechoice1      AS CHARACTER NO-UNDO.
DEFINE VARIABLE v-badgechoice1_id   LIKE MB_mstr.MB_BSA_ID NO-UNDO.
DEFINE VARIABLE v-badgechoice2      AS CHARACTER NO-UNDO.
DEFINE VARIABLE v-badgechoice2_id   LIKE MB_mstr.MB_BSA_ID NO-UNDO.

DEFINE VARIABLE v-foundone              AS LOGICAL NO-UNDO.                                                 

DEFINE VARIABLE v-event_ID  LIKE event_mstr.event_ID INITIAL 20170923 NO-UNDO.            /****    :( :( :(    hard code    ): ): ):   ****/
DEFINE VARIABLE c-card-nbr AS INTEGER NO-UNDO.
/*DEFINE VARIABLE v-period-1 AS CHARACTER NO-UNDO.*/                                        /** 121 **/
/*DEFINE VARIABLE v-period-2 AS CHARACTER NO-UNDO.*/                                        /** 121 **/
def var v-MB_ID-1 like MB_mstr.MB_BSA_ID no-undo.                                           /** 121 **/
def var v-MB_ID-2 like MB_mstr.MB_BSA_ID no-undo.                                           /** 121 **/
DEFINE VARIABLE v-openseats AS INTEGER NO-UNDO.
        
def var v-allowed-seat-overage as int initial 5 no-undo.              /** how many seats over the limit are allowed? - manually change --- 121 **/        
def var v-class_ID-1 like sched_mstr.sched_class_ID no-undo.                                                    /** 121 **/
def var v-class_ID-2 like sched_mstr.sched_class_ID no-undo.                                                    /** 121 **/
def var v-class-list-1 as char no-undo.                                                                         /** 121 **/
def var v-class-list-2 as char no-undo.                                                                         /** 121 **/
def var v-class-list-other as char no-undo.                                                                     /** 121 **/
        
ASSIGN 
    v-event_ID              = INTEGER(html-encode(get-value("h-event_ID")))
    act                     = html-encode(get-value("h-act"))    

/*    v-period-1              = html-encode(get-value("h-period-1"))*/                      /* 121 */
/*    v-period-2              = html-encode(get-value("h-period-2"))*/                      /* 121 */
    v-class_ID-1              = INTEGER(html-encode(get-value("h-period-1")))                           /* 121 */
    v-class_ID-2              = integer(html-encode(get-value("h-period-2")))                           /* 121 */
       
    v-lastname              = html-encode(get-value("h-lastname"))
    v-firstname             = html-encode(get-value("h-firstname"))
    v-html-DOB              = html-encode(get-value("h-DOB"))
    v-people_id             = INTEGER(html-encode(get-value("h-people_ID")))
    v-unit                  = html-encode(get-value("h-unit"))
    v-stake                 = html-encode(get-value("h-stake"))
    v-troop                 = INTEGER(html-encode(get-value("h-troop")))                                              
    .
/* 121 --- minimize the effect of the change, keep old logic as intact as possible but still make variable functions clearer */
if v-class_ID-1 <> 0 then do: 

    find sched_mstr where sched_class_ID = v-class_ID-1 
        no-lock no-error.
    if avail (sched_mstr) then 
        v-MB_ID-1  = sched_BSA_ID.
    else 
        v-MB_ID-1  = 0.
        
end.  /** of if v-class_ID-1 <> 0 **/

if v-class_ID-2 <> 0 then do: 

    find sched_mstr where sched_class_ID = v-class_ID-2 
        no-lock no-error.
    if avail (sched_mstr) then 
        v-MB_ID-2  = sched_BSA_ID.
    else 
        v-MB_ID-2  = 0.
        
end.  /** of if v-class_ID-2 <> 0 **/ 
/**** end of 121 --- minimize change ****/   
    
IF v-unit <> "DidntChoose" THEN DO:        /* member-ish */

    IF v-stake = "" THEN    
        v-stake = "Augusta".    /* is this right? */

    IF v-member = ? THEN
        v-member = YES.         /* here's the ish part */
        
END.  /** of if v-unit <> "" **/

IF act <> "" AND ITmessages = YES THEN 
    {&OUT}
        "<H1>Act = " act "</H1>" SKIP
        "<UL>" SKIP
        "<LI>v-class_ID-1 = " v-class_ID-1 "</LI>" SKIP                                       /** 121 **/
        "<LI>v-class_ID-2 = " v-class_ID-2 "</LI>" SKIP                                       /** 121 **/
/*        "<LI>v-period-1 = " v-period-1 "</LI>" SKIP                                             /* 121 */*/
/*        "<LI>v-period-2 = " v-period-2 "</LI>" SKIP                                             /* 121 */*/
        "<LI>v-MB_ID-1 = " v-MB_ID-1 "</LI>" SKIP                                             /* 121 */
        "<LI>v-MB_ID-2 = " v-MB_ID-2 "</LI>" SKIP                                             /* 121 */
        "<LI>v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP
        "<LI>v-badgechoice1_id = " v-badgechoice1_id "</LI>" SKIP
        "<LI>v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP
        "<LI>v-badgechoice2_id = " v-badgechoice2_id "</LI>" SKIP
        "</UL>" SKIP.

IF act= "" THEN 
    act = "YouthInfo".

RUN VALUE(SEARCH("subr_CCYY_to_YY.r"))(v-html-DOB, OUTPUT v-DOB).

IF act = "Verification" THEN DO:

                                                            IF ITmessages = YES THEN 
                                                            {&OUT} "<H3>Start OF the Verification act</H3>" SKIP
                                                                "<UL>" SKIP
                                                                "   <LI>people_id = " v-people_id "</LI>" SKIP
                                                                "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
                                                                "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
                                                                "</UL>" SKIP.
    
    ASSIGN 
        v-ran = NO 
        v-success = YES. 
           
	RUN VALUE(SEARCH("SUBpeop-datefindR.r")) ("",                       /* Prefix */
	                                          v-firstname,              /* Firstname */
	                                          "",                       /* Middle Name */
	                                          v-lastname,               /* Lastname */
	                                          "",                       /* Suffix */
	                                          v-dob,                    /* DOB */
	                                          OUTPUT v-people_ID,       /* People ID */
	                                          OUTPUT v-addr_ID,         /* old address ID --- need to remove */
	                                          OUTPUT v-error,           /* returned error */
	                                          OUTPUT v-ran).            /* did it run? */
                                                      
/*        IF v-ran = YES AND v-error = NO AND v-people_ID = 0 THEN DO:*/
    IF v-ran <> YES THEN DO:
        
        {&OUT} "<H1>Subroutine SUBpeop-datefindR.r failed. Contact <a href='mailto:solsource.techsupport@mysolsource.com'>Solsource Techsupport</a> immediately!</H1>".
        
    END.  /** of else do --- unable to update people_mstr **/                                                /*** 1dot2 ***/
    
    ELSE DO:
        
                                                            IF ITmessages = YES THEN 
                                                            {&OUT} "<H3>Just ran the SUBpeop-datefindR.r</H3>" SKIP
                                                                "<UL>" SKIP
                                                                "   <LI>Act = " act "</LI>" SKIP
                                                                "   <LI>people_id = " v-people_id "</LI>" SKIP
                                                                "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
                                                                "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
                                                                "</UL>" SKIP.
             
        RUN VALUE(SEARCH("SUBpeop-ucU.r")) (v-people_ID,            /* People ID */ 
	                                         v-firstname,            /* Firstname */
	                                         "",                     /* Middle Name */
	                                         v-lastname,             /* Lastname */
	                                         "",                     /* Prefix */
	                                         "",                     /* Suffix */
	                                         "",                     /* Company */ 
	                                         ?,                      /* Gender */
	                                         "",                     /* Home Phone */
	                                         "",                     /* Work Phone */
	                                         "",                     /* Cell Phone */
	                                         "",                     /* Fax Phone */
	                                         "",                     /* Email */
	                                         "",                     /* Email 2 */
	                                         0,                     /* Address ID ---- will need to be replaced -- pal_list */
	                                         "",                     /* Contact ---- will need to be replaced -- plink_mstr */
	                                         v-DOB,                  /* DOB */
	                                         0,                     /* Address ID 2 -- will need to be replaced -- pal_list */
	                                         "",                     /* Preferred Name */
	                                         "",                     /* Title */
	                                         OUTPUT v-people_ID,     /* People_ID */
	                                         OUTPUT v-created,       /* people_mstr created */
	                                         OUTPUT v-updated,       /* people_mstr updated */
	                                         OUTPUT v-avail,         /* people_mstr available */
	                                         OUTPUT v-success).      /* update successful? */
                                                 
        IF v-success <> YES THEN DO:
		
            {&OUT} "<H1>Subroutine SUBpeop-ucU.r has failed!  Contact <a href='mailto:solsource.techsupport@mysolsource.com'>Solsource Techsupport</a> immediately!</H1>".
        
        END.  /** of else do --- v-ran = YES AND v-error = NO AND v-people_ID = 0 **/
		
        ELSE DO:
		    
                                                            IF ITmessages = YES THEN 
                                                            {&OUT} "<H3>Just ran the SUBpeop-ucU.r</H3>" SKIP
                                                                "<UL>" SKIP                                                                
                                                                "   <LI>Act = " act "</LI>" SKIP
                                                                "   <LI>people_id = " v-people_id "</LI>" SKIP
                                                                "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
                                                                "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
                                                                "</UL>" SKIP.		    
		    
		    FIND speop_shadow WHERE speop_shadow.speop_ID = v-people_ID 
		        EXCLUSIVE-LOCK NO-ERROR.
		        
		    IF NOT AVAILABLE (speop_shadow) THEN DO:
		        
		        CREATE speop_shadow.
		        ASSIGN 
		            speop_shadow.speop_ID           = v-people_ID
		            speop_shadow.speop_create_date  = TODAY 
		            speop_shadow.speop_created_by   = USERID("CUSTOM").
		            
		    END.  /** of if not avail speop_shadow **/
		    
		    ASSIGN 
		        speop_shadow.speop_ward             = IF v-unit <> "" THEN v-unit ELSE speop_shadow.speop_ward
		        speop_shadow.speop_stake            = IF v-stake <> "" THEN v-stake ELSE speop_shadow.speop_stake
		        speop_shadow.speop_LDS              = IF v-member <> ? THEN v-member ELSE speop_shadow.speop_LDS
		        speop_shadow.speop_troop            = IF v-troop <> 0 THEN v-troop ELSE speop_shadow.speop_troop
		        speop_shadow.speop_modified_by      = USERID("MODULES")
		        speop_shadow.speop_modified_date    = TODAY
		        speop_shadow.speop_prog_name        = THIS-PROCEDURE:FILE-NAME.
		        
        END. /*** of ELSE DO --- if v-success = yes ---- create a people_mstr ***/

    END.  /*** of ELSE DO --- people_mstr finding by date sub routine didn't crash ***/

/*******************************************    Start Merit Badge Verification  **************************************************/

												        IF ITmessages = YES THEN 
												            {&OUT} "<H3>Inside the MB verification and Scheduling section</H3>" SKIP
												                "<UL>" SKIP
												                "   <LI>people_id = " v-people_id "</LI>" SKIP
												                "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
												                "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
												                "</UL>" SKIP.
    
	FIND MB_mstr WHERE 
/*	    MB_mstr.MB_BSA_ID = INTEGER(v-period-1)                                        /* 121 */*/
	    MB_mstr.MB_BSA_ID = v-MB_ID-1                                                  /* 121 */
	        NO-LOCK NO-ERROR.
            
	IF AVAILABLE (MB_mstr) THEN ASSIGN 
	   v-badgechoice1_id = MB_mstr.MB_BSA_ID
	   v-badgechoice1 = mb_mstr.mb_name.
        
    ELSE ASSIGN 
        act = "CriticalError"
        error-message = error-message + "mb1 sucks, ".
        
    FIND MB_mstr WHERE 
/*        MB_mstr.MB_BSA_ID = INTEGER(v-period-2)                                         /* 121 */*/
        MB_mstr.MB_BSA_ID = v-MB_ID-2                                         /* 121 */
            NO-LOCK NO-ERROR.
            
    IF AVAILABLE (MB_mstr) THEN ASSIGN 
        v-badgechoice2_id = MB_mstr.MB_BSA_ID
        v-badgechoice2 = mb_mstr.mb_name.
        
    ELSE ASSIGN 
        act = "CriticalError"
        error-message = error-message + "mb2 sucks, ".

											        IF ITmessages = YES THEN 
											            {&OUT} "<H3>Just after the MB verification section</H3>" SKIP
											                    "<UL>" SKIP
											                    "   <LI>people_id = " v-people_id "</LI>" SKIP
											                    "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
											                    "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
											                    "</UL>" SKIP.
        
    IF v-badgechoice1_id <> 0 AND v-badgechoice2_ID <> 0 AND v-people_id <> 0 THEN DO:
        
											          IF ITmessages = YES THEN 
											              {&OUT} "<H3>I got to this awesome spot where a person chose two merit badges</H3>" SKIP
											                  "<UL>" SKIP
											                  "   <LI>people_id = " v-people_id "</LI>" SKIP
											                  "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
											                  "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
											                  "</UL>" SKIP.
        
        /* 121 --- check for pre-existing registration */
        for each regis_mstr where regis_mstr.regis_people_ID = v-people_ID and 
                regis_mstr.regis_deleted = ? no-lock, 
            each sched_mstr where sched_mstr.sched_class_ID = regis_class_ID and 
                sched_mstr.sched_deleted = ? no-lock:
                
            if sched_mstr.sched_period = "1" then 
                v-class-list-1 = if v-class-list-1 = "" then string(sched_mstr.sched_class_ID) else v-class-list-1 + "," + string(sched_mstr.sched_class_ID).
            else if sched_mstr.sched_period = "2" then 
                v-class-list-2 = if v-class-list-2 = "" then string(sched_mstr.sched_class_ID) else v-class-list-2 + "," + string(sched_mstr.sched_class_ID).
            else 
                v-class-list-other = if v-class-list-other = "" then string(sched_mstr.sched_class_ID) else v-class-list-other + "," + string(sched_mstr.sched_class_ID).
        
        end.  /** of 4ea. regis_mstr, etc. **/
        
                                                                                      /*** You can have a class taught more than once at an event. ***/
		FIND sched_mstr WHERE                                                   /*** This is where we should be searching by sched_class_ID. ***/
		    sched_mstr.sched_class_ID = v-class_ID-1 and                                  /* 121 */
		    sched_mstr.sched_BSA_ID = v-badgechoice1_id AND                           /*** This is why the regis_mstr isn't for the proper class   ***/
		    sched_mstr.sched_event_ID = v-event_ID AND                                /*** and the seat count is thus off.                         ***/
		    (sched_mstr.sched_total_seats + v-allowed-seat-overage) > sched_mstr.sched_used_seats AND                 /* 121 */
		    sched_mstr.sched_deleted = ?
		        EXCLUSIVE-LOCK NO-ERROR.
                
        IF AVAILABLE (sched_mstr) THEN DO:

                                                    IF ITmessages = YES THEN 
                                                          {&OUT} "<H3>Sched_mstr AVAILABLE FOR v-badgechoice1 </H3>" SKIP
                                                              "<UL>" SKIP
                                                              "   <LI>people_id = " v-people_id "</LI>" SKIP
                                                              "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
                                                              "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
                                                              "   <LI>v-class-list-1 = " v-class-list-1 "</LI>" SKIP            /* 121 */
                                                              "   <LI>v-class-list-2 = " v-class-list-2 "</LI>" SKIP            /* 121 */
                                                              "   <LI>v-class-list-other = " v-class-list-other "</LI>" SKIP    /* 121 */
                                                              "</UL>" SKIP.    

/*            /** begin 121 */                                                                                                 */
/*            if v-class-list-1 <> "" then do:                                                                                 */
/*                                                                                                                             */
/*                if lookup (sched_mstr.sched_class_ID,v-class-list-1) = 0 then do:                                            */
/*                                                                                                                             */
/*                    registered for something else, fix it                                                                    */
/*                    do x to num-entries(v-class-list-1):                                                                     */
/*                                                                                                                             */
/*                        find regis_mstr where regis_people_ID = v-people_ID and                                              */
/*                            regis_mstr.regis_class_ID = entry(x,v-class-list-1) and                                          */
/*                            regis_mstr.regis_deleted = ?                                                                     */
/*                                exclusive-lock no-error.                                                                     */
/*                                                                                                                             */
/*                        if avail (regis_mstr) then do:                                                                       */
/*                                                                                                                             */
/*                            crap, I'm out of time.  Commenting all this out for now.  We'll have to address it after go live.*/
/*                                                                                                                             */
/*                                                                                                                             */
/*                end.  /** of if lookup sched_class_ID in v-class-list-1 = 0 **/                                              */
/*                                                                                                                             */
/*                else do:                                                                                                     */
/*                                                                                                                             */
/*                    all is well, no need to re-register                                                                      */
/*                                                                                                                             */
/*                end.  /** of else do -- sched_class_ID found in v-class-list-1 **/                                           */
/*                                                                                                                             */
/*            end.  /** of if v-class-list-1 <> 0 --- already registered for stuff **/                                         */
/*            /** end of 121 **/                                                                                               */
                
                
            FIND regis_mstr WHERE regis_mstr.regis_people_id = v-people_id AND 
                regis_mstr.regis_class_ID = sched_mstr.sched_class_ID AND 
                regis_mstr.regis_deleted = ?
                    EXCLUSIVE-LOCK NO-ERROR.
                    
            IF NOT AVAILABLE (regis_mstr) THEN DO: 
            
                CREATE regis_mstr.
                
                ASSIGN 
                    regis_mstr.regis_people_id      = v-people_id 
                    regis_mstr.regis_class_ID       = sched_mstr.sched_class_ID
                    act                             = "success"
                    regis_mstr.regis_created_by     = USERID("MODULES")
                    regis_mstr.regis_create_date    = TODAY.
            
            END.  /** of if not avail regis_mstr --- MB1 **/
            
            ASSIGN 
                    sched_mstr.sched_used_seats     = sched_mstr.sched_used_seats + 1
                    act                             = "success"
                    regis_mstr.regis_modified_by    = USERID("MODULES")
                    regis_mstr.regis_modified_date  = TODAY
                    regis_mstr.regis_prog_name      = THIS-PROCEDURE:FILE-NAME. 
            
        END. /*** of if sched_mstr avail -- MB1 ***/
        
        ELSE DO:
        
            ASSIGN act = "CriticalError"
            error-message = error-message + "MB1 is really full, ".
            
        END. /*** full class ***/    
        
        FIND sched_mstr WHERE                                                               /* 121 */
            sched_mstr.sched_class_ID = v-class_ID-2 and                                       /* 121 */  
            sched_mstr.sched_BSA_ID = v-badgechoice2_id AND 
            sched_mstr.sched_event_ID = v-event_ID AND  
            (sched_mstr.sched_total_seats + v-allowed-seat-overage) > sched_mstr.sched_used_seats           /* 121 */                    
            EXCLUSIVE-LOCK NO-ERROR.
            
        IF AVAILABLE (sched_mstr) THEN DO:

                                                    IF ITmessages = YES THEN 
                                                          {&OUT} "<H3>Sched_mstr AVAILABLE FOR v-badgechoice2 </H3>" SKIP
                                                              "<UL>" SKIP
                                                              "   <LI>people_id = " v-people_id "</LI>" SKIP
                                                              "   <LI>v-badgechoice1_ID = " v-badgechoice1_id "     v-badgechoice1 = " v-badgechoice1 "</LI>" SKIP 
                                                              "   <LI>v-badgechoice2_ID = " v-badgechoice2_id "     v-badgechoice2 = " v-badgechoice2 "</LI>" SKIP 
                                                              "   <LI>v-class-list-1 = " v-class-list-1 "</LI>" SKIP            /* 121 */
                                                              "   <LI>v-class-list-2 = " v-class-list-2 "</LI>" SKIP            /* 121 */
                                                              "   <LI>v-class-list-other = " v-class-list-other "</LI>" SKIP    /* 121 */                                                              
                                                              "</UL>" SKIP.  

             
                

            FIND regis_mstr WHERE regis_mstr.regis_people_id = v-people_id AND 
                regis_mstr.regis_class_ID = sched_mstr.sched_class_ID AND 
                regis_mstr.regis_deleted = ?
                    NO-LOCK NO-ERROR.
                    
            IF NOT AVAILABLE (regis_mstr) THEN DO: 
            
                CREATE regis_mstr.
                
                ASSIGN 
                    regis_mstr.regis_people_id      = v-people_id 
                    regis_mstr.regis_class_ID       = sched_mstr.sched_class_ID
                    act                             = "success"
                    regis_mstr.regis_created_by     = USERID("MODULES")
                    regis_mstr.regis_create_date    = TODAY.
            
            END.  /** of if not avail regis_mstr --- MB1 **/
            
            ASSIGN 
                    sched_mstr.sched_used_seats     = sched_mstr.sched_used_seats + 1
                    act                             = "success"
                    regis_mstr.regis_modified_by    = USERID("MODULES")
                    regis_mstr.regis_modified_date  = TODAY
                    regis_mstr.regis_prog_name      = THIS-PROCEDURE:FILE-NAME.
                
        END. /*** of if sched_mstr avail --- MB2 ***/
        
        ELSE ASSIGN 
            act = "CriticalError"
            error-message = error-message + "MB2 is really full, ".
            
    END. /*** sched verification ( mb1 <> 0 and mb2 <> 0 and people_id <> 0 ) ***/

    IF act = "verification" THEN DO:
    
        ASSIGN act = "CriticalError"
            error-message = error-message + "... and you got dropped!". 
        
    END. /****  it is STILL verification :(  ****/

END. /*** act = "Verification" ***/

/**************************************  MAIN PROGRAM  ********************************************/

CASE act:

    WHEN "Login" THEN DO:
        
    END. /*** Login ***/

    WHEN "YouthInfo" THEN DO: 
        
        {&OUT}
            "<div class='w3-responsive w3-content' style='max-width:1400px'>" SKIP
            "   <header class='w3-container w3-theme-dark w3-margin-bottom'>" SKIP
            "       <h1>Registration Page</h1>" SKIP
            "   </header>" SKIP
              
            "   <div class='w3-card-4 w3-white'>" SKIP  
            "   <form method='POST'>" SKIP
            "       <input type='hidden' name='h-event_ID' value='" v-event_ID "' />" SKIP
            "       <div class='w3-row-padding'>" SKIP
            "           <DIV class='w3-col l6'>" SKIP
            "               <label class='w3-text-theme w3-col l6'><b>First Name</b></label>" SKIP
            "               <INPUT class='ss-scanfield w3-input w3-border w3-round' type='TEXT' name='h-firstname' value='" v-firstname "' required/>" SKIP
            "           </DIV>" SKIP
            "           <DIV class='w3-col l6'>" SKIP
            "               <label class='w3-text-theme w3-col l6'><b>Last Name</b></label>" SKIP
            "               <INPUT class='ss-scanfield w3-input w3-border w3-round' type='TEXT' name='h-lastname' value='" v-lastname "' required/>" SKIP
            "           </DIV>" SKIP
            "       </div>" SKIP
            "<div class='w3-row-padding'>" SKIP
            "   <DIV class='w3-col l6'>" SKIP
            "       <label class='w3-text-theme'><b>Date of Birth</b></label>" SKIP
            "       <INPUT class='w3-select w3-border w3-round' type='date' name='h-DOB' value='" v-DOB "' required/>" SKIP
            "   </div>" SKIP
            "   <DIV class='w3-col l6'>" SKIP
            "       <DIV class='w3-text-theme'><b>LDS Unit</b></DIV>" SKIP
            "       <select name='h-unit' class='w3-border w3-round w3-select w3-margin-bottom' >" SKIP            
            "           <option value='DidntChoose'>Choose</option>" SKIP
            "           <option value='Auburn'>Auburn</option>" SKIP
            "           <option value='Cornish'>Cornish</option>" SKIP
            "           <option value='Damariscotta'>Damariscotta</option>" SKIP
            "           <option value='Farmingdale'>Farmingdale</option>" SKIP
            "           <option value='Oxford'>Oxford</option>" SKIP
            "           <option value='Portland'>Portland</option>" SKIP
            "           <option value='Saco'>Saco</option>" SKIP
            "           <option value='Topsham'>Topsham</option>" SKIP
            "           <option value='Windham'>Windham</option>" SKIP
            "           <option value='Winthrop'>Winthrop</option>" SKIP
            "           <option value='Yarmouth'>Yarmouth</option>" SKIP
            "       </select>" SKIP
            "   </DIV>" SKIP
            "</div>" SKIP
            
            "<div class='w3-row-padding'>" SKIP
            "   <DIV class='w3-col'>" SKIP
            "       <label class='w3-text-theme w3-col l6'><b>Troop Number</b></label>" SKIP
            "       <INPUT class='ss-scanfield w3-input w3-border w3-round' type='TEXT' name='h-troop' value='" v-troop "' />" SKIP
            "   </DIV>" SKIP
            "</div>" SKIP
            
            "<br>" SKIP 
            "</div>" SKIP (3).
            
    /*********************************  MERIT BADGE FIRST PERIOD  ***************************************************/
        {&OUT} 
            "   <header class='w3-container w3-theme-dark w3-margin-bottom'>" SKIP
            "       <h1>Select Your First Period Merit Badge</h1>" SKIP 
            "   </header>" SKIP  
            "   <div class='w3-row w3-light-grey'>" SKIP.
            
        IF v-event_id = 0 THEN v-event_id = 20170923. /*** Merit Badge Workshop 2 ***/
        c-card-nbr = 0.  
         
        FOR EACH sched_mstr WHERE sched_mstr.sched_event_ID = v-event_ID AND
            sched_mstr.sched_deleted = ? NO-LOCK,
          FIRST MB_mstr WHERE MB_mstr.MB_BSA_ID = sched_mstr.sched_BSA_ID NO-LOCK 
            BREAK BY sched_mstr.sched_period BY MB_mstr.MB_name:

            IF FIRST-OF (sched_mstr.sched_period) THEN DO: 

                IF sched_mstr.sched_period = "2" THEN {&OUT}
                    "   </div>" SKIP
		            "   <header class='w3-container w3-theme-dark w3-margin-bottom'>" SKIP
		            "       <h1>Select Your Second Period Merit Badge</h1>" SKIP
		            "   </header>" SKIP 
		            "   <div class='w3-row w3-light-grey'>" SKIP.
   
            END. /*** first of period x ***/ 
  
            ASSIGN v-openseats = (sched_mstr.sched_total_seats - sched_mstr.sched_used_seats).     
                                                                            
                           /********************************* -->  Future Note  <-- ************************************************
                            * The following code could be made smarter by counting the classes in a period and then 
                            * deciding either 6 (the first example) or 8 (the second example).  Then you could have several
                            * different predefined layouts based on whatever art rules you were following.
                            *******************************************************************************************************/
            IF sched_mstr.sched_period = "1" THEN DO: {MB_card_period.i sched_BSA_ID sched_period v-openseats "s12 l4" sched_class_ID}. END.    /* 121 */
            
            ELSE IF sched_mstr.sched_period = "2" THEN DO: {MB_card_period.i sched_BSA_ID sched_period v-openseats "s12 m6 l3" sched_class_ID}. END.    /* 121 */
                            /***********************  End of Future Note area  ****************************************************/
                            
            c-card-nbr = c-card-nbr + 1. 

/*            {&OUT} "card-nbr = " c-card-nbr.*/
 
            IF c-card-nbr = 3 OR c-card-nbr = 6 OR c-card-nbr = 10 OR c-card-nbr = 14 THEN {&OUT}
	            "   </div><!--- row div --->" SKIP
	            "   <div class='w3-row'> <!--------------------------------  Row #2  ------------------------------------------------->" SKIP.
                
        END. /*** for each sched_mstr ***/           
        
                        
        {&OUT}
            "<br>" SKIP
            
            "<div class='w3-row-padding w3-margin'>" SKIP
            "   <div class='w3-center w3-col m12'>" SKIP
            "       <button type='submit' name='h-act' value='Verification' class='w3-btn-block w3-theme-l2 w3-round' style='max-width:400px;'><b>Submit</b></BUTTON>" SKIP
            "   </div>" SKIP
            "</div>" SKIP
            "<div class='w3-row-padding w3-margin'>" SKIP
            "   <div class='w3-center w3-col m12'>" SKIP
            "       <button type='Reset' class='w3-btn-block w3-theme-l2 w3-round' style='max-width:400px;'><b>Reset</b></BUTTON>" SKIP
            "   </div>" SKIP
            "</div>" SKIP
            "</form>" SKIP.
            
    END. /*** of new user --- act =  "YouthInfo" ***/
             
    WHEN "Success" THEN DO:
        
        {&OUT}
            "<div class='w3-container'>" SKIP
            "<form method='POST'>" SKIP
            "   <input type='hidden' name='h-event_ID' value='" v-event_ID "' />" SKIP
            "<div class='w3-card-8 w3-content w3-white' style='max-width:1250px;'>" SKIP
            "    <header class='w3-container w3-theme'>" SKIP
            "       <h1>Congratulations</h1>" SKIP
            "    </header>" SKIP
            
            "    <div class='w3-container'>" SKIP
            "       <p>You have successfully signed " v-firstname " " v-lastname " up for the " v-badgechoice1 " and " v-badgechoice2 " merit badges.</p>" SKIP
            "    </div>" SKIP
    
            "    <button type='submit' name='h-act' value='YouthInfo' class='w3-btn-block w3-left-align w3-padding-16 w3-hover-blue'>Submit Another</BUTTON>" SKIP
            "    <button type='submit' name='h-act' value='' class='w3-btn-block w3-left-align w3-padding-16 w3-hover-green'>Return to Start</BUTTON>" SKIP
            "</div>" SKIP
            "</form>" SKIP
            "</div>" SKIP.
        
    END. /*** Success ***/

    WHEN "WrongNumber" THEN DO:
        
         {&OUT}
            "<div class='w3-container'>" SKIP
            "<form method='POST'>" SKIP
            "   <input type='hidden' name='h-event_ID' value='" v-event_ID "' />" SKIP
            "<div class='w3-card-8 w3-content w3-white' style='max-width:1250px;'>" SKIP
            "    <header class='w3-container w3-red'>" SKIP
            "       <h1>Error</h1>" SKIP
            "    </header>" SKIP
            
            "    <div class='w3-container'>" SKIP
            "       <p>You have selected " c-MeritBadges " merit badges, please select 2. Feel free to click the back button and try again.</p>" SKIP
            "    </div>" SKIP

            "    <button type='submit' name='h-act' value='' class='w3-btn-block w3-left-align w3-padding-16 w3-hover-red'>Return to Start</BUTTON>" SKIP
            "</div>" SKIP
            "</form>" SKIP
            "</div>" SKIP.
            
        
    END. /*** wrong number ***/ 
    
    WHEN "CriticalError" THEN DO:
        
         {&OUT}
            "<div class='w3-container'>" SKIP
            "<form method='POST'>" SKIP
            "   <input type='hidden' name='h-event_ID' value='" v-event_ID "' />" SKIP
            "<div class='w3-card-8 w3-content w3-white' style='max-width:1250px;'>" SKIP
            "    <header class='w3-container w3-red'>" SKIP
            "       <h1>Error</h1>" SKIP
            "    </header>" SKIP
            
            "    <div class='w3-container'>" SKIP
            "       <p>You have encountered a critical error. Feel free to click the back button, refresh your browser and try again.</p>" SKIP.
            
IF ITmessages = YES THEN {&OUT} "   <br><P> " error-message " </P>" SKIP.

        {&OUT}
            "    </div>" SKIP

            "    <button type='submit' name='h-act' value='' class='w3-btn-block w3-left-align w3-padding-16 w3-hover-red'>Return to Start</BUTTON>" SKIP
            "</div>" SKIP
            "</form>" SKIP
            "</div>" SKIP.
            
        
    END. /*** wrong number ***/ 

    OTHERWISE DO:
        
        {&OUT}
            "<div class='w3-container'>" SKIP
            "<form method='POST'>" SKIP
            "   <input type='hidden' name='h-event_ID' value='" v-event_ID "' />" SKIP
            "<div class='w3-card-8 w3-content w3-white' style='max-width:1250px;'>" SKIP
            "    <header class='w3-container w3-red'>" SKIP
            "       <h1>Error</h1>" SKIP
            "    </header>" SKIP
            
            "    <div class='w3-container'>" SKIP
            "       <p>Could not find act '" act "'.</p>" SKIP
            "    </div>" SKIP

            "    <button type='submit' name='h-act' value='' class='w3-btn-block w3-left-align w3-padding-16 w3-hover-red'>Return to Start</BUTTON>" SKIP
            "</div>" SKIP
            "</form>" SKIP
            "</div>" SKIP.
            
    END. /*** otherwise ***/
    
END CASE.

</SCRIPT>
</BODY>
</HTML>